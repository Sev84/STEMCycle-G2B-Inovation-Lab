<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STEMCycle G2B Lab Hub</title>
    <!-- Tailwind CSS Yüklemesi -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font Yüklemesi -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet (Harita) CSS Yüklemesi -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/SJPMeIegerwBLpT6A="
     crossorigin=""/>
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0f9ff; /* Açık gökyüzü mavisi */
            position: relative; /* Arka plan için gerekli */
            min-height: 100vh;
        } 
        
        /* ARKA PLAN DOKUSU EKLENDİ */
        body::before {
            content: '';
            position: fixed; /* Fixed olarak değiştirildi */
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-image: url('https://www.transparenttextures.com/patterns/cubes.png');
            opacity: 0.05; /* Biraz daha belirgin hale getirildi */
            z-index: -1; /* İçeriğin arkasında kalması için */
            pointer-events: none;
        }
        
        #app {
            position: relative; /* z-index'in çalışması için */
            z-index: 1; /* Arka planın üzerinde kalması için */
        }
        
        .header-blue { background-color: #00796b; }
        .accent-blue { background-color: #00838f; }
        .accent-green { background-color: #4caf50; }
        .tab-active { border-bottom: 3px solid #00838f; color: #00838f; font-weight: 600; }
        .announcement-card { border-left: 4px solid #ffb300; }
        .project-card { border-top: 5px solid #00838f; }
        .lab-accent { background-color: #ffb300; }
        
        #user-map { height: 300px; width: 100%; border-radius: 12px; margin-bottom: 1.5rem; z-index: 5; background-color: #e0f2fe; } /* Harita yüklenirken yer tutucu rengi */
        
        .module { cursor: grab; user-select: none; }
        .module:active { cursor: grabbing; }
        #kit-canvas { 
            min-height: 250px; 
            background-color: #e2e8f0; 
            border: 2px dashed #94a3b8;
            position: relative;
        }
        
        /* Harita ikonları için 'iframe' yerine divIcon kullanılır */
        .custom-div-icon { background-color: transparent !important; border: none !important; }
        
    </style>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
</head>
<body class="min-h-screen">

    <div id="app" class="flex flex-col min-h-screen">
        
        <!-- Hesap Oluşturma/Giriş Modalı -->
        <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h1 class="text-2xl font-bold mb-4 text-center text-accent-blue" data-i18n="welcome_title">HOŞ GELDİNİZ</h1>
                <div class="space-y-3 mb-6">
                    <h2 class="text-sm font-semibold text-gray-700" data-i18n="esep_students_title">Öğrenci Girişleri ve Kaynaklar:</h2>
                    <a href="https://school-education.ec.europa.eu/en/pupil-login" target="_blank" class="block p-3 bg-green-100 border border-green-300 rounded-lg hover:bg-green-200 transition">
                        <p class="font-bold text-green-700 text-sm" data-i18n="esep_login_btn">ESEP/eTwinning Öğrenci Girişi</p>
                    </a>
                    <a href="https://school-education.ec.europa.eu/en/" target="_blank" class="block p-3 bg-blue-100 border border-blue-300 rounded-lg hover:bg-blue-200 transition">
                        <p class="font-bold text-blue-700 text-sm" data-i18n="esep_platform_btn">ESEP Okul Eğitimi Platformu</p>
                    </a>
                </div>
                <h2 class="text-xl font-bold mb-4 text-center text-accent-blue border-t pt-4" data-i18n="hub_login_title">STEMCycle Hub Girişi</h2>
                <div id="register-ui">
                    <h3 class="font-bold text-sm mb-2 text-gray-700" data-i18n="new_register_title">Yeni Kayıt / Bilgi Güncelleme</h3>
                    <input type="text" id="user-name-input" placeholder="Adınız, Soyadınız" class="w-full p-2 border rounded-lg mb-3">
                    <input type="email" id="user-email-input" placeholder="E-posta (Opsiyonel)" class="w-full p-2 border rounded-lg mb-3">
                    <input type="text" id="user-school-input" placeholder="Okulunuz / Ülkeniz" class="w-full p-2 border rounded-lg mb-4">
                    <button onclick="registerUser()" class="w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700">Kayıt Ol / Güncelle</button>
                </div>
                <div id="login-ui" class="mt-4">
                    <h3 class="font-bold text-sm mb-2 text-gray-700 border-t pt-4" data-i18n="guest_login_title">Veya Misafir Olarak Devam Et</h3>
                    <button onclick="loginUser()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700">Misafir Girişi</button>
                </div>
                <!-- DÜZELTİLMİŞ LOGOLAR (GİRİŞ EKRANI) -->
                <div class="p-4 flex flex-wrap justify-center items-center space-x-4 mt-4 border-t">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjMwIiB2aWV3Qm94PSIwIDAgMTAwIDMwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGZpbGw9IiMwMDQ0OTQiIGQ9Ik0wIDIuNzQ2aDEuNzM4VjI3LjI1NEgwVjIuNzQ2ek0zLjI3IDIuNzQ2aDQuMDQ4YzIuODEgMCA0LjM2OC41MyA1LjY3NSAyLjE5NyAxLjMwNSAxLjY2NyAxLjk1OCAzLjg2NyAxLjk1OCA2LjYwMiAwIDIuNzM0LS42NTMgNC45MzQtMS45NTggNi42MDItMS4zMDcuMTY2Ny0yLjg2NSAyLjE5Ny01LjY3NSAyLjE5N0gzLjI3VjIuNzQ2Wm0xLjc0IDYuMDYydjcuMjNoMi4zMDhjMi4wMSAwIDIuOTI4LS44MjIgMi45MjgtMi4yNzOTIgMC0yLjA1My0uOTE5LTIuNzUzLTIuNzgtMi43NTNINS4wMXpNMTUuODQ4IDIuNzQ2aDQuMDQ4YzIuODEgMCA0LjM2OC41MyA1LjY3NSAyLjE5NyAxLjMwNSAxLjY2NyAxLjk1OCAzLjg2NyAxLjk1OCA2LjYwMiAwIDIuNzM0LS42NTMgNC45MzQtMS45NTggNi42MDItMS4zMDcuMTY2Ny0yLjg2NSAyLjE5Ny01LjY3NSAyLjE5N0gxNS44NThWMi43NDZabTEuNzQgNi4wNjJ2Ny4yM2gyLjMwOGMyLjAxIDAgMi45MjgtLjgyMiAyLjkyOC0yLjc5MiAwLTIuMDUzLS45MTktMi43NTMtMi43OC0yLjc1M2gtMi4xNDhaTTI4LjQyNyAyLjM0N2MxLjQxMy0xLjM4IDIuOTctMi4wNyA0LjY3LTIuMDcgMS43OCAwIDMuMzguNjg1IDQuODEgMi4wNTcgMS40MzIgMS4zNzIgMi4xNDggMy4xNzcgMi4xNDggNS40MTUgMCAyLjE5Ny0uNzE2IDMuOTk3LTIuMTQ4IDUuNHMtMy4wMyAyLjEtNC44MSAyLjFjLTEuNyAwLTMuMjU3LS42OS00LjY3LTIuMDY5VjI3LjI1NGgtMS43MzhWMi43NDZoMS43Mzh2Ni44NTZaTTMzLjA5NyA5LjE5YzAgMS43NTguNTMgMy4xMTggMS41OTEgNC4wNzkgMS4wNi45NiAyLjMzOCAxLjQ0IDMuODQzIDEuNDQgMS41NDggMCAyLjg1MS0uNDggMy44ODYtMS40NCAxLjAzNS0uOTYgMS41NTMtMi4zMiAxLjU1My00LjA3OSAwLTEuNzE2LS41MTgtMy4wNjgtMS41NTMtNC4wNTktMS4wMzUtLjk5LTIuMzM4LTEuNDg1LTMuODg2LTEuNDg1LTEuNTA1IDAtMi43ODMuNDk1LTMuODQzIDEuNDg1LTEuMDYgMS0xLjU5MSAyLjM0My0xLjU5MSA0LjA1OVpNNTAuMTI3IDIuNzQ2aDMuMjE2bC0zLjAzIDkuMzE4LTUuNjU0LTkuMzE4aC0zLjU2M2w3LjIzIDExLjk0Ny43NDIgMS4yMzVoLTEuNjQxbC0xLjk3OS0zLjI2aC0uOTM4bC0uODk2IDEuNDI3IDIuMTEyIDMuNDkzaDMuMzIzbDYuOTI0LTExLjQwM2gxLjc2bC01LjUyIDkuMDg4IDQuMzY4IDcuMTY4aC0zLjMyMmwtMi44NzctNC43MTUtMS41MzEgMi41MmgxLjQ2N2wuODI4IDEuMzY4aC45NThsLjY3OCAxLjExNGgtNy45NjhsLjY3OC0xLjExNGguOTU4bC44MjgtMS4zNjhoMS40NjdMNDEuNiAyNy4yNTRsLTUuNzgtOS41MjVMODAuMDM0IDIuNzQ2aC0uNjU2bC01LjY1MyA5LjMxOEw2OC4wNDQgMi43NDZoLTMuMjE2bDQuNjkyIDcuNzYyIDQuNDUtNy43NjJoMy41NjNsLTcuMjMgMTEuOTQ3LS43NDIgMS4yMzVoMS42NDFsMS45OC0zLjI2aC45MzhsLjg5NiAxLjQyNy0yLjExMiAzLjQ5M2gtMy4zMjNMNTguMyAxNS44NGwtNi45MjQtMTEuNDAzaC0xLjc2bDUuNTIgOS4wODgtNC4zNjggNy4xNjhoMy4zMjJsMi44NzctNC43MTUgMS41MzIgMi41MmgtMS40NjdsLS44MjggMS4zNjhoLS45NThsLS42NzgtMS4xMTRoNy45NjhMNTkuMzU4IDI3LjI1NGw1Ljc4LTkuNTI1IDQuNjQ2IDcuNTI1aC42NTZaTTY5LjEyNyAyLjM0N2MxLjQxMy0xLjM4IDIuOTctMi4wNyA0LjY3LTIuMDcgMS43OCAwIDMuMzguNjg1IDQuODEgMi4wNTcgMS40MzIgMS4zNzIgMi4xNDggMy4xNzcgMi4xNDggNS40MTUgMCAyLjE5Ny0uNzE2IDMuOTk3LTIuMTQ4IDUuNHMtMy4wMyAyLjEtNC44MSAyLjFjLTEuNyAwLTMuMjU3LS42OS00LjY3LTIuMDY5VjI3LjI1NGgtMS43MzhWMi43NDZoMS43Mzh2Ni44NTZaTTczLjc5NyA5LjE5YzAgMS43NTguNTMgMy4xMTggMS41OTEgNC4wNzkgMS4wNi45NiAyLjMzOCAxLjQ0IDMuODQzIDEuNDQgMS41NDggMCAyLjg1MS0uNDggMy44ODYtMS40NCAxLjAzNS0uOTYgMS41NTMtMi4zMiAxLjU1My00LjA3OSAwLTEuNzE2LS41MTgtMy4wNjgtMS41NTMtNC4wNTktMS4wMzUtLjk5LTIuMzM4LTEuNDg1LTMuODg2LTEuNDg1LTEuNTA1IDAtMi43ODMuNDk1LTMuODQzIDEuNDg1LTEuMDYgMS0xLjU5MSAyLjM0My0xLjU5MSA0LjA1OVpNODQuMzQ2IDIuNzQ2aDEuNzM4VjIzLjQxNGMwIDEuMzc5LjM1NSAyLjQ1IDEuMDY2IDMuMjE2LjcxMS43NjYgMS42MTUgMS4xNSIvPg0KPHBhdGggZmlsbD0iI0ZGRDEwMCIgZD0iTTMxLjE5MiAxMi4xMTJsMS40MTQtMS40MTMgMy41ODYgMy41ODYgMS40MTQtMS40MTQtMy41ODYtMy41ODYgMS40MTQtMS40MTQtMy41ODYtMy41ODZhLjk5Ni45OTYgMCAwIDAtMS40MTQgMGwtMS40MTQgMS40MTMgMy41ODYgMy41ODYtMS40MTQgMS40MTMgMy41ODYgMy41ODZ6Ii8+DQo8L3N2Zz4=" alt="eTwinning Logosu" class="h-6 opacity-80">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjMwIiB2aWV3Qm94PSIwIDAgMTAwIDMwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGZpbGw9IiMwMDkzZGEiIGQ9Ik0zMi4wMzIgMTIuMjk1SDIyLjk0bDMuOTc3IDMuOTc3di4wMDFoNS4xMTV2LTMuOTc4Wm0wIDUuMTJIMUMxLjgyNCAxLjEyIDIuODcyIDEuNTkgMy43MjggMi4zN2guMDJjLjk1Ny43OCAxLjU3IDEuODQgMi4xMDcgMy4xNTNsLjAwNS4wMTJjLjUzOCAxLjMxMy44MDYgMi43OC44MDYgNC40VjI3LjI1NWgtMS43MzhWMjMuNDE0Yy4wMDEtMS4zNzktLjM1NC0yLjQ1LTEuMDY1LTMuMjE2LS43MS0uNzY2LTEuNjE0LTEuMTUtMi43MDgtMS4xNUg4MC4zVjI3LjI1NGgtMS43MzhWOS45NmMwLTEuNzMzLjIyLTMuMjU3LjY1Ny00LjU3NC40MzYtMS4zMTcuOTk3LTIuNDI1IDEuNjgxLTMuMzI1IDEuMzU3LTEuNzU4IDMuMDc5LTIuNjM3IDUuMTY2LTIuNjM3IDEuOTk3IDAgMy42MzUuNzggNC45MTUgMi4zNHMxLjkxOSAzLjQ4MyAxLjkxOSA1Ljc3MnYxMi45MDFoLTEuNzM4di0xLjQ4NmMtMS4yNjYgMS4xOTUtMi43ODMgMS43OTMtNC41NSAxLjc5My0yLjEyIDAtMy45MS0uODctNS4zNzMtMi42MS0xLjQ2My0xLjc0LTEuNjY3LTMuNjQzLTEuNjY3LTUuNzA5IDAtMi4wNjYuMjA0LTMuOTczIDEuNjY3LTUuNzA5IDEuNDYzLTEuNzQgMy4yNTMtMi42MSA1LjM3My0yLjYxIDEuNzY3IDAgMy4yODMuNjAzIDQuNTUgMS43OTNWMTEuMTRjMC0yLjI4OS0uNjQzLTMuOTk3LTEuOTE5LTUuNzcyWk05NC4wMiAyLjM0N2MxLjQxMy0xLjM4IDIuOTctMi4wNyA0LjY3LTIuMDcgMS43OCAwIDMuMzguNjg1YyAxLjQzMiAxLjM3MiAyLjE0OCAzLjE3NyAyLjE0OCA1LjQxNSAwIDIuEzk3LS43MTYgMy45OTctMi4xNDggNS40cy0zLjAzIDIuMS00LjgxIDIuMWMtMS43IDAtMy4yNTctLjY5LTQuNjctMi4wNjlWMjcuMjU0aC0xLjczOFYyLjc0NmgxLjczOHY2Ljg1NlpNOTQuNjkgOS4xOWMwIDEuNzU4LjUzIDMuMTE4IDEuNTkxIDQuMDc5IDEuMDYuOTYgMi4zMzggMS40NCAzLjg0MyAxLjQ0IDEuNTQ4IDAgMi44NTEtLjQ4IDMuODg2LTEuNDQgMS4wMzUtLjk2IDEuNTUzLTIuMzIgMS41NTMtNC4wNzkgMC0xLjcxNi0uNTE4LTMuMDY4LTEuNTUzLTQuMDU5LTEuMDM1LTUuOTktMi4zMzgtMS40ODUtMy44ODYtMS40ODUtMS41MDUgMC0yLjc4My40OTUtMy44NDMgMS40ODUtMS4wNiAxLTEuNTkxIDIuMzQzLTEuNTkxIDQuMDU5WiIvPjxwYXRoIGZpbGw9IiMwMDkzZGEiIGQ9Ik0xOC40ODUgMTUuMDA4aDEuNDU2YTcuMDIgNy4wMiAwIDAgMCAzLjQ5OC0xLjA5NSA0LjQ4OSA0LjQ4OSAwIDAgMCAyLjQ1NC0zLjA4OCA0LjI4MiA0LjI4MiAwIDAgMC0xLjQ4OS00LjMzNCA1LjAxMiA1LjAxMiAwIDAgMC0zLjgxMS0xLjQ2OUgxOC40ODV2OS45ODYxWm0tMy4xNzcgOS4zMDVIMTUuMzA4VjMuOTY5aDUuMTc3YzEuNzYgMCAzLjMwNS4zNzkgNC43MzMgMS4xMzkgMS40MjcuNzU5IDIuNTcgMS44NzQgMy40MjggMy4zNDQgLjg1OCAxLjQ2OSAxLjI4NyAzLjE2IDEuMjg3IDUuMDc0IDAgMS42MTUtLjMyNSAzLjEyMy0uOTc0IDQuNTE4YTcuMDY5IDcuMDY5IDAgMCAxLTIuNjU3IDMuMTk4IDcuOTQxIDcuOTQxIDAgMCAxLTQgMS4zMDJINC4xMTRsMy4yMDggMy4yMDhoMy45ODd2LTguNDE1aC0zLjk4N2wtMy4yMDggMy4yMDhINC4xMTRsMy4yMDggMy4yMDh6TTIuNzU2IDE1LjAwOGgxLjQ1NmE3LjAyIDcuMDIgMCAwIDAgMy40OTgtMS4wOTUgNC40ODkgNC40ODkgMCAwIDAgMi40NTQtMy4wODggNC4yODIgNC4yODIgMCAwIDAtMS40ODktNC4zMzQgNS4wMTIgNS4wMTIgMCAwIDAtMy44MTEtMS40NjlIMi43NTZ2OS45ODYxWk0tLjQyIDI0LjMxM2gxNS43MjlWMy45NjloNS4xNzdjMS43NiAwIDMuMzA1LjM3OSA0LjczMyAxLjEzOSAxLjQyNy43NTkgMi41NyAxLjg3NCAzLjQyOCAzLjM0NCAuODU4IDEuNDY5IDEuMjg3IDMuMTYgMS4yODcgNS4wNzQgMCAxLjYxNS0uMzI1IDMuMTIzLS45NzQgNC41MThhNy4wNjkgNy4wNjkgMCAwIDEtMi42NTcgMy4xOTggNy45NDEgNy45NDEgMCAwIDEtNCAxLjMwMkgtLjQxOHoiLz48L3N2Zz4=" alt="CodeWeek Logosu" class="h-8 opacity-80">
                </div>
            </div>
        </div>

        <!-- Başlık ve Kullanıcı Bilgisi -->
        <header class="header-blue text-white p-4 shadow-lg sticky top-0 z-20">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <h1 class="text-base sm:text-xl font-bold flex items-center">
                        <svg class="w-6 h-6 mr-2 text-green-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9h-9m-9 0a9 9 0 019-9m-9 9h6m-9 9a9 9 0 019-9m-9 9a9 9 0 009 9m9-9a9 9 0 01-9 9m9-9h-9m-9 0a9 9 0 019-9m-9 9h6"></path></svg>
                        <span data-i18n="app_main_title">STEMCycle G2B Lab Hub</span>
                    </h1>
                    <!-- DÜZELTİLMİŞ LOGOLAR (BAŞLIK) -->
                    <span class="text-sm font-light italic ml-3 pl-3 border-l border-green-200 hidden sm:block">BluEcoInVET</span>
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjMwIiB2aWV3Qm94PSIwIDAgMTAwIDMwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGZpbGw9IiMwMDQ0OTQiIGQ9Ik0wIDIuNzQ2aDEuNzM4VjI3LjI1NEDgwVjIuNzQ2ek0zLjI3IDIuNzQ2aDQuMDQ4YzIuODEgMCA0LjM2OC41MyA1LjY3NSAyLjE5NyAxLjMwNSAxLjY2NyAxLjk1OCAzLjg2NyAxLjk1OCA2LjYwMiAwIDIuNzM0LS42NTMgNC45MzQtMS45NTggNi42MDItMS4zMDcuMTY2Ny0yLjg2NSAyLjE5Ny01LjY3NSAyLjE5N0gzLjI3VjIuNzQ2Wm0xLjc0IDYuMDYydjcuMjNoMi4zMDhjMi4wMSAwIDIuOTI4LS44MjIgMi45MjgtMi4yNzOTIgMC0yLjA1My0uOTE5LTIuNzUzLTIuNzgtMi43NTNINS4wMXpNMTUuODQ4IDIuNzQ2aDQuMDQ4YzIuODEgMCA0LjM2OC41MyA1LjY3NSAyLjE5NyAxLjMwNSAxLjY2NyAxLjk1OCAzLjg2NyAxLjk1OCA2LjYwMiAwIDIuNzM0LS42NTMgNC45MzQtMS45NTggNi42MDItMS4zMDcuMTY2Ny0yLjg2NSAyLjE5Ny01LjY3NSAyLjE5N0gxNS44NThWMi43NDZabTEuNzQgNi4wNjJ2Ny4yM2gyLjMwOGMyLjAxIDAgMi45MjgtLjgyMiAyLjkyOC0yLjc5MiAwLTIuMDUzLS45MTktMi43NTMtMi43OC0yLjc1M2gtMi4xNDhaTTI4LjQyNyAyLjM0N2MxLjQxMy0xLjM4IDIuOTctMi4wNyA0LjY3LTIuMDcgMS43OCAwIDMuMzguNjg1IDQuODEgMi4wNTcgMS40MzIgMS4zNzIgMi4xNDggMy4xNzcgMi4xNDggNS40MTUgMCAyLjE5Ny0uNzE2IDMuOTk3LTIuMTQ4IDUuNHMtMy4wMyAyLjEtNC44MSAyLjFjLTEuNyAwLTMuMjU3LS42OS00LjY3LTIuMDY5VjI3LjI1NGgtMS43MzhWMi43NDZoMS43Mzh2Ni44NTZaTTMzLjA5NyA5LjE5YzAgMS43NTguNTMgMy4xMTggMS41OTEgNC4wNzkgMS4wNi45NiAyLjMzOCAxLjQ0IDMuODQzIDEuNDQgMS41NDggMCAyLjg1MS0uNDggMy44ODYtMS40NCAxLjAzNS0uOTYgMS41NTMtMi4zMiAxLjU1My00LjA3OSAwLTEuNzE2LS41MTgtMy4wNjgtMS41NTMtNC4wNTktMS4wMzUtLjk5LTIuMzM4LTEuNDg1LTMuODg2LTEuNDg1LTEuNTA1IDAtMi43ODMuNDk1LTMuODQzIDEuNDg1LTEuMDYgMS0xLjU5MSAyLjM0My0xLjU5MSA0LjA1OVpNNTAuMTI3IDIuNzQ2aDMuMjE2bC0zLjAzIDkuMzE4LTUuNjU0LTkuMzE4aC0zLjU2M2w3LjIzIDExLjk0Ny43NDIgMS4yMzVoLTEuNjQxbC0xLjk3OS0zLjI2aC0uOTM4bC0uODk2IDEuNDI3IDIuMTEyIDMuNDkzaDMuMzIzbDYuOTI0LTExLjQwM2gxLjc2bC01LjUyIDkuMDg4IDQuMzY4IDcuMTY4aC0zLjMyMmwtMi44NzctNC43MTUtMS41MzEgMi41MmgxLjQ2N2wuODI4IDEuMzY4aC45NThsLjY3OCAxLjExNGgtNy45NjhsLjY3OC0xLjExNGguOTU4bC44MjgtMS4zNjhoMS40NjdMNDEuNiAyNy4yNTRsLTUuNzgtOS41MjVMODAuMDM0IDIuNzQ2aC0uNjU2bC01LjY1MyA5LjMxOEw2OC4wNDQgMi43NDZoLTMuMjE2bDQuNjkyIDcuNzYyIDQuNDUtNy43NjJoMy41NjNsLTcuMjMgMTEuOTQ3LS43NDIgMS4yMzVoMS42NDFsMS45OC0zLjI2aC45MzhsLjg5NiAxLjQyNy0yLjExMiAzLjQ5M2gtMy4zMjNMNTguMyAxNS44NGwtNi45MjQtMTEuNDAzaC0xLjc2bDUuNTIgOS4wODgtNC4zNjggNy4xNjhoMy4zMjJsMi44NzctNC43MTUgMS41MzIgMi41MmgtMS40NjdsLS44MjggMS4zNjhoLS45NThsLS42NzgtMS4xMTRoNy45NjhMNTkuMzU4IDI3LjI1NGw1Ljc4LTkuNTI1IDQuNjQ2IDcuNTI1aC42NTZaTTY5LjEyNyAyLjM0N2MxLjQxMy0xLjM4IDIuOTctMi4wNyA0LjY3LTIuMDcgMS43OCAwIDMuMzguNjg1IDQuODEgMi4wNTcgMS40MzIgMS4zNzIgMi4xNDggMy4xNzcgMi4xNDggNS40MTUgMCAyLjE5Ny0uNzE2IDMuOTk3LTIuMTQ4IDUuNHMtMy4wMyAyLjEtNC44MSAyLjFjLTEuNyAwLTMuMjU3LS42OS00LjY3LTIuMDY5VjI3LjI1NGgtMS43MzhWMi43NDZoMS43Mzh2Ni44NTZaTTczLjc5NyA5LjE5YzAgMS43NTguNTMgMy4xMTggMS41OTEgNC4wNzkgMS4wNi45NiAyLjMzOCAxLjQ0IDMuODQzIDEuNDQgMS41NDggMCAyLjg1MS0uNDggMy44ODYtMS40NCAxLjAzNS0uOTYgMS41NTMtMi4zMiAxLjU1My00LjA3OSAwLTEuNzE2LS41MTgtMy4wNjgtMS41NTMtNC4wNTktMS4wMzUtLjk5LTIuMzM4LTEuNDg1LTMuODg2LTEuNDg1LTEuNTA1IDAtMi43ODMuNDk1LTMuODQzIDEuNDg1LTEuMDYgMS0xLjU5MSAyLjM0My0xLjU5MSA0LjA1OVpNODQuMzQ2IDIuNzQ2aDEuNzM4VjIzLjQxNGMwIDEuMzc5LjM1NSAyLjQ1IDEuMDY2IDMuMjE2LjcxMS43NjYgMS42MTUgMS4xNSIvPg0KPHBhdGggZmlsbD0iI0ZGRDEwMCIgZD0iTTMxLjE5MiAxMi4xMTJsMS40MTQtMS40MTMgMy41ODYgMy41ODYgMS40MTQtMS40MTQtMy41ODYtMy41ODYgMS40MTQtMS40MTQtMy41ODYtMy41ODZhLjk5Ni45OTYgMCAwIDAtMS40MTQgMGwtMS40MTQgMS40MTMgMy41ODYgMy41ODYtMS40MTQgMS40MTMgMy41ODYgMy41ODZ6Ii8+DQo8L3N2Zz4=" alt="eTwinning Logosu" class="h-5 ml-4 opacity-90 hidden sm:block">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjMwIiB2aWV3Qm94PSIwIDAgMTAwIDMwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGZpbGw9IiMwMDkzZGEiIGQ9Ik0zMi4wMzIgMTIuMjk1SDIyLjk0bDMuOTc3IDMuOTc3di4wMDFoNS4xMTV2LTMuOTc4Wm0wIDUuMTJIMUMxLjgyNCAxLjEyIDIuODcyIDEuNTkgMy43MjggMi4zN2guMDJjLjk1Ny43OCAxLjU3IDEuODQgMi4xMDcgMy4xNTNsLjAwNS4wMTJjLjUzOCAxLjMxMy44MDYgMi43OC44MDYgNC40VjI3LjI1NWgtMS43MzhWMjMuNDE0Yy4wMDEtMS4zNzktLjM1NC0yLjQ1LTEuMDY1LTMuMjE2LS43MS0uNzY2LTEuNjE0LTEuMTUtMi43MDgtMS4xNUg4MC4zVjI3LjI1NGgtMS43MzhWOS45NmMwLTEuNzMzLjIyLTMuMjU3LjY1Ny00LjU3NC40MzYtMS4zMTcuOTk3LTIuNDI1IDEuNjgxLTMuMzI1IDEuMzU3LTEuNzU4IDMuMDc5LTIuNjM3IDUuMTY2LTIuNjM3IDEuOTk3IDAgMy42MzUuNzggNC45MTUgMi4zNHMxLjkxOSAzLjQ4MyAxLjkxOSA1Ljc3MnYxMi45MDFoLTEuNzM4di0xLjQ4NmMtMS4yNjYgMS4xOTUtMi43ODMgMS43OTMtNC41NSAxLjc5My0yLjEyIDAtMy45MS0uODctNS4zNzMtMi42MS0xLjQ2My0xLjc0LTEuNjY3LTMuNjQzLTEuNjY3LTUuNzA5IDAtMi4wNjYuMjA0LTMuOTczIDEuNjY3LTUuNzA5IDEuNDYzLTEuNzQgMy4yNTMtMi42MSA1LjM3My0yLjYxIDEuNzY3IDAgMy4yODMuNjAzIDQuNTUgMS43OTNWMTEuMTRjMC0yLjI4OS0uNjQzLTMuOTk3LTEuOTE5LTUuNzcyWk05NC4wMiAyLjM0N2MxLjQxMy0xLjM4IDIuOTctMi4wNyA0LjY3LTIuMDcgMS43OCAwIDMuMzguNjg1YyAxLjQzMiAxLjM3MiAyLjE0OCAzLjE3NyAyLjE0OCA1LjQxNSAwIDIuEzk3LS43MTYgMy45OTctMi4xNDggNS40cy0zLjAzIDIuMS00LjgxIDIuMWMtMS43IDAtMy4yNTctLjY5LTQuNjctMi4wNjlWMjcuMjU0aC0xLjczOFYyLjc0NmgxLjczOHY2Ljg1NlpNOTQuNjkgOS4xOWMwIDEuNzU4LjUzIDMuMTE4IDEuNTkxIDQuMDc5IDEuMDYuOTYgMi4zMzggMS40NCAzLjg0MyAxLjQ0IDEuNTQ4IDAgMi44NTEtLjQ4IDMuODg2LTEuNDQgMS4wMzUtLjk2IDEuNTUzLTIuMzIgMS41NTMtNC4wNzkgMC0xLjcxNi0uNTE4LTMuMDY4LTEuNTUzLTQuMDU5LTEuMDM1LTUuOTktMi4zMzgtMS40ODUtMy44ODYtMS40ODUtMS41MDUgMC0yLjc4My40OTUtMy44NDMgMS40ODUtMS4wNiAxLTEuNTkxIDIuMzQzLTEuNTkxIDQuMDU5WiIvPjxwYXRoIGZpbGw9IiMwMDkzZGEiIGQ9Ik0xOC40ODUgMTUuMDA4aDEuNDU2YTcuMDIgNy4wMiAwIDAgMCAzLjQ5OC0xLjA5NSA0LjQ4OSA0LjQ4OSAwIDAgMCAyLjQ1NC0zLjA4OCA0LjI4MiA0LjI4MiAwIDAgMC0xLjQ4OS00LjMzNCA1LjAxMiA1LjAxMiAwIDAgMC0zLjgxMS0xLjQ2OUgxOC40ODV2OS45ODYxWm0tMy4xNzcgOS4zMDVIMTUuMzA4VjMuOTY5aDUuMTc3YzEuNzYgMCAzLjMwNS4zNzkgNC43MzMgMS4xMzkgMS40MjcuNzU5IDIuNTcgMS44NzQgMy40MjggMy4zNDQgLjg1OCAxLjQ2OSAxLjI4NyAzLjE2IDEuMjg3IDUuMDc0IDAgMS42MTUtLjMyNSAzLjEyMy0uOTc0IDQuNTE4YTcuMDY5IDcuMDY5IDAgMCAxLTIuNjU3IDMuMTk4IDcuOTQxIDcuOTQxIDAgMCAxLTQgMS4zMDJINC4xMTRsMy4yMDggMy4yMDhoMy45ODd2LTguNDE1aC0zLjk4N2wtMy4yMDggMy4yMDhINC4xMTRsMy4yMDggMy4yMDh6TTIuNzU2IDE1LjAwOGgxLjQ1NmE3LjAyIDcuMDIgMCAwIDAgMy40OTgtMS4wOTUgNC40ODkgNC40ODkgMCAwIDAgMi40NTQtMy4wODggNC4yODIgNC4yODIgMCAwIDAtMS40ODktNC4zMzQgNS4wMTIgNS4wMTIgMCAwIDAtMy44MTEtMS40NjlIMi43NTZ2OS45ODYxWk0tLjQyIDI0LjMxM2gxNS43MjlWMy45NjloNS4xNzdjMS43NiAwIDMuMzA1LjM3OSA0LjczMyAxLjEzOSAxLjQyNy43NTkgMi41NyAxLjg3NCAzLjQyOCAzLjM0NCAuODU4IDEuNDY5IDEuMjg3IDMuMTYgMS4yODcgNS4wNzQgMCAxLjYxNS0uMzI1IDMuMTIzLS45NzQgNC41MThhNy4wNjkgNy4wNjkgMCAwIDEtMi4yNTcgMy4xOTggNy45NDEgNy45NDEgMCAwIDEtNCAxLjMwMkgtLjQxOHoiLz48L3N2Zz4=" alt="CodeWeek Logosu" class="h-6 ml-3 opacity-90 hidden sm:block">
                </div>
                <div class="flex items-center space-x-4"><select id="language-select" class="bg-white text-gray-800 text-xs font-semibold p-1 rounded-md cursor-pointer" onchange="changeLanguage(this.value)"><option value="tr">TR</option><option value="en">EN</option></select><div class="text-sm"><p id="user-info" class="font-semibold text-right truncate"></p><p id="user-location" class="text-xs opacity-70 truncate"></p></div></div>
            </div>
        </header>

        <!-- Sekmeler -->
        <nav class="bg-white shadow-md p-2 flex justify-around text-gray-600 sticky top-[68px] z-20 overflow-x-auto whitespace-nowrap">
            <button id="tab-groups" onclick="changeTab('groups')" class="px-2 py-2 text-xs sm:text-sm flex-shrink-0 tab-active" data-i18n="tab_groups">Gruplar</button>
            <button id="tab-files" onclick="changeTab('files')" class="px-2 py-2 text-xs sm:text-sm flex-shrink-0" data-i18n="tab_files">Dosyalar</button>
            <button id="tab-announcements" onclick="changeTab('announcements')" class="px-2 py-2 text-xs sm:text-sm flex-shrink-0" data-i18n="tab_announcements">Duyurular</button>
            <button id="tab-gallery" onclick="changeTab('gallery')" class="px-2 py-2 text-xs sm:text-sm flex-shrink-0" data-i18n="tab_boards">Panolar</button>
            <button id="tab-lab" onclick="changeTab('lab')" class="px-2 py-2 text-xs sm:text-sm flex-shrink-0" data-i18n="tab_lab_data">LAB Veri</button>
            <button id="tab-module" onclick="changeTab('module')" class="px-2 py-2 text-xs sm:text-sm flex-shrink-0" data-i18n="tab_module">
                <svg class="w-5 h-5 inline-block sm:mr-1 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 10-4 0v1a2 2 0 004 0V4zM19 4a2 2 0 10-4 0v1a2 2 0 004 0V4zM7 20h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v11a2 2 0 002 2z"></path></svg>
                Modül
            </button>
        </nav>

        <!-- Ana İçerik Alanı -->
        <main class="flex-grow p-4 space-y-6 z-10 relative">
            <section id="groups-view" class="tab-content"><div class="bg-white p-4 rounded-xl shadow-lg mb-6"><h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2" data-i18n="map_title">Etki Haritası</h2><div id="user-map"></div></div><div class="bg-white p-4 rounded-xl shadow-lg mb-6"><h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2" data-i18n="create_join_group_title">Grup Oluştur / Katıl</h2><input type="text" id="new-group-name" placeholder="Yeni Grup Adı" class="w-full p-2 border rounded-lg mb-3"><div class="mb-4"><label class="block text-sm font-medium" data-i18n="project_focus_label">Odak:</label><div class="flex space-x-4"><label><input type="radio" name="economyFocus" value="Mavi" checked> <span data-i18n="focus_blue">Mavi Ekonomi</span></label><label><input type="radio" name="economyFocus" value="Yeşil"> <span data-i18n="focus_green">Yeşil Ekonomi</span></label></div></div><button onclick="createGroup()" class="w-full accent-blue bg-blue-600 text-white py-2 rounded-lg font-semibold" data-i18n="create_group_btn">Grup Oluştur</button></div><div id="all-groups-list" class="space-y-4 mb-8"><h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2" data-i18n="all_groups_title">Tüm Gruplar</h2></div><div class="bg-white p-4 rounded-xl shadow-lg"><h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2" data-i18n="active_users_title">Aktif Kullanıcılar</h2><div id="all-users-list" class="space-y-2 max-h-64 overflow-y-auto"></div></div></section>
            <section id="files-view" class="tab-content hidden"><div class="bg-white p-4 rounded-xl shadow-lg"><h2 class="text-xl font-bold text-gray-800 mb-4" data-i18n="file_share_title">Dosya Paylaşımı</h2><select id="group-select-files" class="w-full p-2 border rounded-lg mb-4"></select><div id="file-upload-area" class="hidden"><input type="file" id="file-input" class="w-full p-2 border rounded-lg mb-3"><input type="text" id="file-description" placeholder="Açıklama" class="w-full p-2 border rounded-lg mb-3"><button onclick="uploadFile()" class="w-full accent-blue bg-blue-600 text-white py-2 rounded-lg font-semibold" data-i18n="upload_file_link_btn">Yükle</button></div></div><div id="group-files-list" class="mt-6 space-y-4"><h3 class="text-xl font-bold text-gray-800 border-b pb-2" data-i18n="selected_group_files">Grubun Dosyaları</h3></div></section>
            <section id="announcements-view" class="tab-content hidden"><div class="bg-white p-4 rounded-xl shadow-lg mb-6"><h2 class="text-xl font-bold text-gray-800 mb-4" data-i18n="publish_announcement_title">Yeni Duyuru</h2><input type="text" id="announcement-title" placeholder="Başlık" class="w-full p-2 border rounded-lg mb-3"><textarea id="announcement-content" placeholder="İçerik" rows="3" class="w-full p-2 border rounded-lg mb-3"></textarea><button onclick="publishAnnouncement()" class="w-full lab-accent bg-yellow-500 text-white py-2 rounded-lg font-semibold" data-i18n="publish_btn">Yayınla</button></div><div id="announcements-list" class="space-y-4"><h3 class="text-xl font-bold text-gray-800 border-b pb-2" data-i18n="all_announcements_title">Tüm Duyurular</h3></div></section>
            <section id="gallery-view" class="tab-content hidden"><div class="bg-white p-4 rounded-xl shadow-lg"><h2 class="text-xl font-bold text-gray-800 mb-4" data-i18n="project_board_title">Proje Panosu</h2><select id="group-select-panel" class="w-full p-2 border rounded-lg mb-4"></select><div id="panel-editor-area" class="hidden"><input type="text" id="panel-title" placeholder="Pano Başlığı" class="w-full p-2 border rounded-lg mb-3"><textarea id="panel-content" placeholder="Pano İçeriği" rows="5" class="w-full p-2 border rounded-lg mb-3"></textarea><input type="url" id="panel-link" placeholder="Proje Linki (opsiyonel)" class="w-full p-2 border rounded-lg mb-3"><button onclick="saveProjectPanel()" class="w-full accent-green bg-green-600 text-white py-2 rounded-lg font-semibold" data-i18n="save_board_btn">Kaydet</button></div></div><div id="project-gallery" class="mt-6 space-y-4"><h3 class="text-xl font-bold text-gray-800 border-b pb-2" data-i18n="innovation_gallery_title">İnovasyon Galerisi</h3></div></section>
            <section id="lab-view" class="tab-content hidden"><div class="bg-white p-4 rounded-xl shadow-lg"><h2 class="text-xl font-bold text-gray-800 mb-4" data-i18n="lab_results_title">LAB Sonuçları</h2><select id="group-select-lab" class="w-full p-2 border rounded-lg mb-4"></select><div id="lab-input-area" class="hidden"><input type="text" id="lab-name" placeholder="Deney Adı" class="w-full p-2 border rounded-lg mb-3"><input type="number" id="lab-value" placeholder="Tasarruf (Litre/Ay)" class="w-full p-2 border rounded-lg mb-3"><input type="number" id="lab-baseline" placeholder="Temel Tüketim (Litre/Ay)" class="w-full p-2 border rounded-lg mb-3"><button onclick="calculateBlueContribution()" class="w-full lab-accent bg-yellow-500 text-white py-2 rounded-lg font-semibold" data-i18n="calculate_save_btn">Kaydet</button></div></div><div id="contribution-results" class="mt-6 space-y-4"><h3 class="text-xl font-bold text-gray-800 border-b pb-2" data-i18n="group_contribution_score_title">Grup Katkı Puanı</h3><div id="current-contribution-card" class="p-4 bg-white rounded-xl shadow-md"></div><div id="lab-records-list" class="space-y-3"></div></div></section>
            <section id="module-view" class="tab-content hidden"><div class="bg-white p-4 rounded-xl shadow-lg mb-6 border-l-4 border-orange-500"><h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center border-b pb-2" data-i18n="module_dev_title"><svg class="w-6 h-6 mr-2 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 10-4 0v1a2 2 0 004 0V4zM19 4a2 2 0 10-4 0v1a2 2 0 004 0V4zM7 20h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v11a2 2 0 002 2z"></path></svg>Sanal Modül Geliştirme</h2><p class="text-sm text-gray-600 mb-4" data-i18n="module_dev_desc">Modülleri sürükleyip bırakarak deney düzenekleri inşa edin.</p><div id="module-palette" class="flex flex-wrap gap-3 p-3 bg-gray-100 rounded-lg mb-4"><div class="module bg-white text-gray-700 p-2 rounded-lg shadow-md text-xs font-semibold" draggable="true" data-type="sensor" data-name="pH_Sensor">pH Sensör</div><div class="module bg-white text-gray-700 p-2 rounded-lg shadow-md text-xs font-semibold" draggable="true" data-type="actuator" data-name="Pump">Su Pompası</div><div class="module bg-white text-gray-700 p-2 rounded-lg shadow-md text-xs font-semibold" draggable="true" data-type="input" data-name="Rain_Collector">Yağmur Toplayıcı</div><div class="module bg-white text-gray-700 p-2 rounded-lg shadow-md text-xs font-semibold" draggable="true" data-type="control" data-name="Microcontroller">Kontrolcü (IoT)</div><div class="module bg-white text-gray-700 p-2 rounded-lg shadow-md text-xs font-semibold" draggable="true" data-type="storage" data-name="Greywater_Tank">Gri Su Tankı</div></div><h3 class="text-md font-semibold text-gray-700 mb-2" data-i18n="virtual_kit_area">Sanal Kit Alanı</h3><div id="kit-canvas" class="rounded-lg shadow-inner relative"><p class="text-center text-gray-500 pt-16" data-i18n="drag_modules_here">Modülleri Buraya Sürükleyin</p></div><button onclick="clearKitCanvas()" class="w-full mt-4 bg-red-500 text-white py-2 rounded-lg font-semibold hover:bg-red-600" data-i18n="clear_canvas_btn">Kanvası Temizle</button></div></section>
        </main>
        
        <footer class="bg-gray-100 p-3 text-xs text-gray-600 text-center mt-auto z-10 relative"><p data-i18n="project_desc">Bu platform, su okuryazarlığı ile yeşil ve mavi ekonomi arasındaki ilişkiyi göstermeyi amaçlar.</p></footer>
    </div>

    <div id="message-box" class="fixed bottom-4 right-4 bg-red-500 text-white p-3 rounded-lg shadow-xl hidden z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, where, arrayUnion, arrayRemove, deleteDoc, updateDoc, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        const translations = { /* ... Çeviri metinleri ... */ };
        let app, db, auth, storage;
        let userId = null, userName = '', userSchool = '', userEmail = '', isGuest = true;
        let userLat = null, userLon = null;
        let userGroups = [], allUserMetadata = [], groupMap = {}; // groupMap eklendi
        let userMap = null, mapMarkers = []; 
        let isMapInitialized = false;
        let filesListener, labDataListener;

        const firebaseConfig = {
            apiKey: "AIzaSyAshVa6zGftQmBQcjo_HRHoOP92vb3kKgQ",
            authDomain: "stemcycle-g2b-innovation-efe5c.firebaseapp.com",
            projectId: "stemcycle-g2b-innovation-efe5c",
            storageBucket: "stemcycle-g2b-innovation-efe5c.appspot.com",
            appId: "1:79339752913:web:5379abf2794791b7bda4f0"
        };
        
        // --- Genel Fonksiyonlar ---
        function showMessage(message, isError = false) {
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.className = `fixed bottom-4 right-4 p-3 rounded-lg shadow-xl z-50 ${isError ? 'bg-red-500' : 'bg-green-500'} text-white opacity-100`;
            setTimeout(() => { box.classList.add('hidden'); box.classList.remove('opacity-100') }, 3000);
        }
        
        window.changeTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('tab-active'));
            document.getElementById(`${tabName}-view`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('tab-active');
            
            // HARİTA YENİDEN BOYUTLANDIRMA MANTIĞI
            if (tabName === 'groups') {
                if (!isMapInitialized) {
                    initializeMap(); // Haritayı sadece ilk tıklamada başlat
                } else {
                    // Harita zaten varsa, boyutunu gecikmeyle tazele (DOM'un güncellenmesi için)
                    setTimeout(() => { 
                        if (userMap) userMap.invalidateSize(); 
                    }, 10); 
                }
            }
        }

        // --- Başlangıç ve Kimlik Doğrulama ---
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig); 
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);
                
                onAuthStateChanged(auth, (user) => {
                    // Kullanıcı değiştiğinde veya ilk girişte tetiklenir
                    if (user && user.uid !== userId) {
                        userId = user.uid;
                        // Gerçek zamanlı dinleyicileri başlat
                        setupRealtimeListeners(); 
                        // Kullanıcı bilgilerini (localStorage'dan veya misafir olarak) al
                        getUserLocationAndMetadata(); 
                    } else if (!user && !auth.currentUser) { // Anonim giriş başarısızsa veya çıkış yapılmışsa
                        signInAnonymously(auth).catch(err => console.error("Anonim giriş hatası:", err));
                    }
                });

                // Sayfa ilk yüklendiğinde anonim kullanıcı yoksa giriş yapmayı dene
                if (!auth.currentUser) {
                     await signInAnonymously(auth);
                } else if (!userId) { // Eğer zaten bir kullanıcı varsa ama userId henüz set edilmemişse
                    userId = auth.currentUser.uid;
                    setupRealtimeListeners();
                    getUserLocationAndMetadata();
                }

            } catch (error) { console.error("Firebase Başlatma Hatası:", error); }
        }
        
        // GİRİŞ EKRANI FONKSİYONLARI
        window.registerUser = () => {
            const name = document.getElementById('user-name-input').value.trim();
            const school = document.getElementById('user-school-input').value.trim();
            if (!name || !school) return showMessage("Ad ve okul alanları zorunludur.", true);
            
            localStorage.setItem('user_name', name);
            localStorage.setItem('user_school', school);
            localStorage.setItem('user_email', document.getElementById('user-email-input').value.trim());
            
            isGuest = false;
            sessionStorage.removeItem('isGuest'); // Misafir oturumunu temizle
            document.getElementById('auth-modal').classList.add('hidden');
            
            // Eğer Firebase henüz başlatılmadıysa veya kullanıcı değiştiyse başlat/güncelle
            if (!userId) initializeFirebase(); 
            else getUserLocationAndMetadata(); 
        };

        window.loginUser = () => {
            localStorage.removeItem('user_name');
            localStorage.removeItem('user_school');
            localStorage.removeItem('user_email');
            sessionStorage.setItem('isGuest', 'true'); // Misafir oturumunu işaretle
            isGuest = true;
            document.getElementById('auth-modal').classList.add('hidden');

            if (!userId) initializeFirebase();
            else getUserLocationAndMetadata();
        };
        
        function getUserLocationAndMetadata() {
            if (isGuest) {
                userName = "Misafir";
                userSchool = "Görüntüleme";
                userLat = null; // Misafir konumu yok
                userLon = null;
                updateUserMetadata(false); // Konum almadan sadece UI'ı güncelle
            } else {
                userName = localStorage.getItem('user_name');
                userSchool = localStorage.getItem('user_school');
                userEmail = localStorage.getItem('user_email');

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(pos => {
                        userLat = pos.coords.latitude.toFixed(2);
                        userLon = pos.coords.longitude.toFixed(2);
                        updateUserMetadata(true); // Konumla birlikte güncelle
                    }, () => {
                        userLat = 41.01; userLon = 28.97; // Hata durumunda İstanbul
                        showMessage("Konum alınamadı, varsayılan konum kullanılıyor.", true);
                        updateUserMetadata(true);
                    }, { enableHighAccuracy: false, timeout: 5000, maximumAge: 60000 }); // Ayarlar eklendi
                } else {
                    userLat = 41.01; userLon = 28.97;
                    showMessage("Tarayıcı konum servisini desteklemiyor.", true);
                    updateUserMetadata(true);
                }
            }
        }

        async function updateUserMetadata(saveToDb) {
            // UI Güncellemesi
            document.getElementById('user-info').textContent = `${userName} (${userSchool})`;
            if (userLat && userLon) {
                document.getElementById('user-location').textContent = `Konum: ${userLat}, ${userLon}`;
            } else {
                document.getElementById('user-location').textContent = isGuest ? '' : 'Konum bekleniyor...';
            }

            // Veritabanı Güncellemesi (sadece kayıtlı kullanıcı ve konum varsa)
            if (saveToDb && !isGuest && userId && userLat && userLon) {
                 try {
                     await setDoc(doc(db, `artifacts/${firebaseConfig.projectId}/public/data/user_metadata`, userId), 
                        { name: userName, school: userSchool, email: userEmail, lat: userLat, lon: userLon, lastLogin: new Date().toISOString() }, 
                        { merge: true }
                    );
                 } catch (error) {
                     console.error("Kullanıcı veritabanı güncellenemedi:", error);
                 }
            }
             // Haritayı güncelle (veriler değişmiş olabilir)
            renderUserMap(allUserMetadata);
        }

        // --- Realtime Dinleyiciler ---
        function setupRealtimeListeners() {
            const projectId = firebaseConfig.projectId;
            onSnapshot(collection(db, `artifacts/${projectId}/public/data/groups`), 
                (snapshot) => updateAllUsersAndGroups(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))),
                (error) => console.error("Grup dinleme hatası:", error)
            );
            onSnapshot(collection(db, `artifacts/${projectId}/public/data/announcements`), 
                (snapshot) => renderAnnouncements(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))),
                (error) => console.error("Duyuru dinleme hatası:", error)
            );
            onSnapshot(collection(db, `artifacts/${projectId}/public/data/panels`), 
                (snapshot) => renderProjectGallery(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))),
                (error) => console.error("Pano dinleme hatası:", error)
            );
        }

        async function updateAllUsersAndGroups(groupsData) {
            try {
                const userSnapshot = await getDocs(collection(db, `artifacts/${firebaseConfig.projectId}/public/data/user_metadata`));
                allUserMetadata = userSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                groupMap = {};
                groupsData.forEach(g => {
                    (g.members || []).forEach(memberId => { // Güvenlik kontrolü
                        if (!groupMap[memberId]) groupMap[memberId] = [];
                        groupMap[memberId].push(g);
                    });
                });
                
                userGroups = groupsData.filter(g => g.members && g.members.includes(userId));

                renderAllUsers(); 
                renderAllGroups(groupsData); 
                renderUserMap(allUserMetadata); // Haritayı en son verilerle güncelle
                updateGroupSelectors(userGroups);
            } catch (error) {
                console.error("Kullanıcı/Grup verileri güncellenirken hata:", error);
            }
        }

        // --- Harita ---
        function initializeMap() {
            // Harita zaten başlatıldıysa veya Leaflet kütüphanesi yüklenmediyse çık
            if (isMapInitialized || typeof L === 'undefined') return; 
            
            const mapElement = document.getElementById('user-map');
            // Harita elementi DOM'da yoksa çık (örneğin sekme henüz render edilmediyse)
            if (!mapElement || !mapElement.offsetParent) { 
                 console.log("Harita elementi görünür değil, başlatma ertelendi.");
                 return;
             }

            try {
                // Eğer harita daha önce başka bir nedenle oluşturulduysa kaldır
                 if (userMap && userMap.remove) userMap.remove(); 
                
                userMap = L.map('user-map').setView([40, 35], 5); // Türkiye merkezli başla
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap'
                }).addTo(userMap);
                isMapInitialized = true;
                
                // Haritanın düzgün boyutlandırılması için kısa bir gecikme sonrası invalidateSize çağır
                setTimeout(() => {
                    if (userMap) {
                         userMap.invalidateSize();
                         renderUserMap(allUserMetadata); // Boyutlandırma sonrası markerları ekle
                     }
                }, 50); 

            } catch (e) {
                console.error("Harita başlatılamadı:", e);
                isMapInitialized = false; // Başlatma başarısız oldu
            }
        }

        function renderUserMap(users) {
            if (!isMapInitialized || !userMap) return; // Harita yoksa marker ekleme
            mapMarkers.forEach(m => m.remove()); mapMarkers = [];
            
            users.forEach(user => {
                // Kullanıcının konumu geçerliyse marker ekle
                if (user.lat && user.lon && !isNaN(user.lat) && !isNaN(user.lon)) {
                    const userGroupsInfo = groupMap[user.id] || [];
                    const isBlue = userGroupsInfo.some(g => g.economyFocus === 'Mavi');
                    const isGreen = userGroupsInfo.some(g => g.economyFocus === 'Yeşil');
                    
                    let color = '#808080'; 
                    if (isBlue && isGreen) color = '#ffb300'; 
                    else if (isBlue) color = '#00838f'; 
                    else if (isGreen) color = '#4caf50'; 
                    
                    const markerHtmlStyles = `background-color: ${color}; width: 1.5rem; height: 1.5rem; display: block; left: -0.75rem; top: -0.75rem; position: relative; border-radius: 1.5rem 1.5rem 0; transform: rotate(45deg); border: 2px solid #FFF; box-shadow: 0 0 5px rgba(0,0,0,0.5);`;
                    const customIcon = L.divIcon({ className: "custom-div-icon", html: `<div style="${markerHtmlStyles}"></div>`, iconSize: [24, 24], iconAnchor: [12, 24] });
                    
                    const userScore = user.puan || 0; 
                    const popupContent = `<div class="font-bold">${user.name} (${user.school || 'Okul Yok'})</div><div class="text-sm font-semibold text-accent-blue">Puan: ${userScore}</div>`;
                    
                    try {
                        const marker = L.marker([user.lat, user.lon], { icon: customIcon }).bindPopup(popupContent).addTo(userMap);
                        mapMarkers.push(marker);
                    } catch (e) {
                        console.error(`Marker eklenirken hata: Kullanıcı ${user.name}, Lat ${user.lat}, Lon ${user.lon}`, e);
                    }
                }
            });
             // Haritayı tüm markerları içerecek şekilde ayarla (eğer marker varsa)
             if (mapMarkers.length > 0) {
                 try {
                    const bounds = L.featureGroup(mapMarkers).getBounds();
                    if (bounds.isValid()) { // Geçerli sınırlar varsa
                        userMap.fitBounds(bounds, { padding: [30, 30], maxZoom: 10 }); // Kenarlardan boşluk bırak
                    }
                 } catch (e) { console.error("Harita sınırları ayarlanamadı:", e); }
             }
        }
        
        // --- Diğer Fonksiyonlar (Önceki kod gibi korunur) ---
        function renderAllUsers() {
             const userListEl = document.getElementById('all-users-list');
             if (!userListEl) return;
             userListEl.innerHTML = '';
             const threeDaysAgo = new Date(Date.now() - 3 * 24 * 60 * 60 * 1000);
             const sortedUsers = [...allUserMetadata].sort((a, b) => new Date(b.lastLogin || 0) - new Date(a.lastLogin || 0));
             
             sortedUsers.forEach(user => {
                 const isCurrentUser = user.id === userId;
                 const dateStr = user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Bilinmiyor';
                 const isActive = user.lastLogin && new Date(user.lastLogin) > threeDaysAgo;
                 let bgColor = 'bg-gray-50 border-gray-200';
                 let textColor = 'text-gray-800';
                 let statusText = '';
                 if (isCurrentUser) {
                     bgColor = 'bg-blue-100 border-blue-400';
                     textColor = 'text-blue-800';
                     statusText = `<span class="text-xs font-normal text-red-500">(Siz)</span>`;
                 } else if (isActive) {
                     bgColor = 'bg-green-100 border-green-400';
                     textColor = 'text-green-800';
                     statusText = `<span class="text-xs font-bold text-green-600 ml-1">(AKTİF)</span>`;
                 }
                 const userCard = document.createElement('div');
                 userCard.className = `p-2 rounded-lg border ${bgColor}`;
                 userCard.innerHTML = `<p class="font-semibold text-sm ${textColor}">${user.name} ${statusText}</p><p class="text-xs text-gray-600">${user.school || 'Okul Yok'} | Son Görülme: ${dateStr}</p>`;
                 userListEl.appendChild(userCard);
             });
         }
        function renderAllGroups(groups) { /* ... */ }
        window.createGroup = async () => { if(isGuest) return showMessage("Grup oluşturmak için kayıt olmalısınız.", true); const name = document.getElementById('new-group-name').value.trim(); if(!name) return; const focus = document.querySelector('input[name="economyFocus"]:checked').value; await addDoc(collection(db, `artifacts/${firebaseConfig.projectId}/public/data/groups`), { name, ownerId: userId, economyFocus: focus, stemCycleStatus: "Başlangıç", members: [userId], createdAt: new Date().toISOString() }); document.getElementById('new-group-name').value = ''; showMessage("Grup oluşturuldu!");}
        window.joinGroup = async (groupId) => { if(isGuest) return showMessage("Gruba katılmak için kayıt olmalısınız.", true); await updateDoc(doc(db, `artifacts/${firebaseConfig.projectId}/public/data/groups`, groupId), { members: arrayUnion(userId) }); showMessage("Gruba katıldınız!"); }
        window.leaveGroup = async (groupId) => { if(confirm('Gruptan ayrılmak istediğinize emin misiniz?')) { await updateDoc(doc(db, `artifacts/${firebaseConfig.projectId}/public/data/groups`, groupId), { members: arrayRemove(userId) }); showMessage("Gruptan ayrıldınız."); } }
        window.updateGroupStatus = async (groupId) => { const status = document.getElementById(`status-select-${groupId}`).value; await updateDoc(doc(db, `artifacts/${firebaseConfig.projectId}/public/data/groups`, groupId), { stemCycleStatus: status }); showMessage("Durum güncellendi."); }
        window.uploadFile = async () => { if(isGuest) return showMessage("Dosya yüklemek için kayıt olmalısınız.", true); const groupId = document.getElementById('group-select-files').value; const file = document.getElementById('file-input').files[0]; if(!groupId || !file) return showMessage("Grup ve dosya seçin.", true); const desc = document.getElementById('file-description').value; const storagePath = `artifacts/${firebaseConfig.projectId}/group_files/${groupId}/${Date.now()}_${file.name}`; const fileRef = ref(storage, storagePath); await uploadBytes(fileRef, file); const url = await getDownloadURL(fileRef); await addDoc(collection(db, `artifacts/${firebaseConfig.projectId}/public/data/files`), { groupId, fileName: file.name, fileUrl: url, description: desc, uploaderId: userId, uploaderName: userName, uploadedAt: new Date().toISOString() }); showMessage("Dosya yüklendi!"); document.getElementById('file-input').value = ''; document.getElementById('file-description').value = ''; }
        window.deleteFile = async (id, url) => { if(confirm('Dosyayı silmek istediğinize emin misiniz?')) { await deleteDoc(doc(db, `artifacts/${firebaseConfig.projectId}/public/data/files`, id)); try { await deleteObject(ref(storage, url)); } catch(e) { if(e.code !== 'storage/object-not-found') console.error("Storage silme hatası:", e);} showMessage("Dosya silindi."); } }
        function renderFiles(files) { const listEl = document.getElementById('group-files-list'); listEl.innerHTML = `<h3 class="text-xl font-bold text-gray-800 border-b pb-2">Grubun Dosyaları</h3>`; files.sort((a,b)=>new Date(b.uploadedAt)-new Date(a.uploadedAt)).forEach(f => { const item = document.createElement('div'); item.className='bg-white p-3 rounded-lg shadow-sm flex items-center justify-between'; item.innerHTML = `<div><a href="${f.fileUrl}" target="_blank" class="font-semibold hover:text-blue-600">${f.fileName}</a><p class="text-xs text-gray-500">${f.description||''}</p><p class="text-xs text-gray-400">Ykl: ${f.uploaderName} - ${new Date(f.uploadedAt).toLocaleDateString()}</p></div> ${f.uploaderId === userId ? `<button onclick="deleteFile('${f.id}', '${f.fileUrl}')" class="text-red-500 text-sm">Sil</button>` : ''}`; listEl.appendChild(item); }); }
        window.publishAnnouncement = async () => { if(isGuest) return showMessage("Duyuru için kayıt olmalısınız.", true); const title = document.getElementById('announcement-title').value.trim(); const content = document.getElementById('announcement-content').value.trim(); if(!title || !content) return; await addDoc(collection(db, `artifacts/${firebaseConfig.projectId}/public/data/announcements`), { title, content, publisherId: userId, publisherName: userName, publishedAt: new Date().toISOString() }); showMessage("Duyuru yayınlandı!"); document.getElementById('announcement-title').value = ''; document.getElementById('announcement-content').value = ''; }
        window.deleteAnnouncement = async (id) => { if(confirm('Duyuruyu silmek istediğinize emin misiniz?')) { await deleteDoc(doc(db, `artifacts/${firebaseConfig.projectId}/public/data/announcements`, id)); showMessage("Duyuru silindi."); } }
        function renderAnnouncements(announcements) { const listEl = document.getElementById('announcements-list'); listEl.innerHTML = `<h3 class="text-xl font-bold text-gray-800 border-b pb-2">Tüm Duyurular</h3>`; announcements.sort((a,b)=>new Date(b.publishedAt)-new Date(a.publishedAt)).forEach(ann => { const card = document.createElement('div'); card.className="bg-white p-4 rounded-lg shadow-sm announcement-card"; card.innerHTML = `<div class="flex justify-between items-start"><div><h4 class="font-bold text-lg">${ann.title}</h4><p class="text-xs text-gray-500">Yyn: ${ann.publisherName} - ${new Date(ann.publishedAt).toLocaleString()}</p></div>${ann.publisherId === userId ? `<button onclick="deleteAnnouncement('${ann.id}')" class="text-red-500 text-sm">Sil</button>` : ''}</div><p class="mt-2 text-gray-700">${ann.content.replace(/\n/g, '<br>')}</p>`; listEl.appendChild(card); }); }
        async function loadPanelForGroup(groupId) { const titleEl = document.getElementById('panel-title'), contentEl = document.getElementById('panel-content'), linkEl = document.getElementById('panel-link'); titleEl.value='';contentEl.value='';linkEl.value=''; if(!groupId) return; const docSnap = await getDoc(doc(db, `artifacts/${firebaseConfig.projectId}/public/data/panels`, groupId)); if(docSnap.exists()){ const d = docSnap.data(); titleEl.value=d.title||''; contentEl.value=d.content||''; linkEl.value=d.link||''; } }
        window.saveProjectPanel = async () => { if(isGuest) return showMessage("Pano için kayıt olmalısınız.", true); const groupId = document.getElementById('group-select-panel').value; const title = document.getElementById('panel-title').value.trim(); const content = document.getElementById('panel-content').value.trim(); if(!groupId || !title || !content) return showMessage("Grup, başlık ve içerik gerekli.", true); const link = document.getElementById('panel-link').value.trim(); await setDoc(doc(db, `artifacts/${firebaseConfig.projectId}/public/data/panels`, groupId), { groupId, title, content, link, authorId: userId, authorName: userName, lastUpdatedAt: new Date().toISOString() }, { merge: true }); showMessage("Pano kaydedildi!"); }
        function renderProjectGallery(panels) { const galleryEl = document.getElementById('project-gallery'); galleryEl.innerHTML = `<h3 class="text-xl font-bold text-gray-800 border-b pb-2">İnovasyon Galerisi</h3>`; panels.sort((a,b)=>new Date(b.lastUpdatedAt)-new Date(a.lastUpdatedAt)).forEach(p => { const card = document.createElement('div'); card.className="bg-white p-4 rounded-xl shadow-lg project-card"; card.innerHTML = `<h4 class="text-lg font-bold text-accent-blue">${p.title}</h4><p class="text-xs text-gray-500 mb-2">Yazar: ${p.authorName} | ${new Date(p.lastUpdatedAt).toLocaleDateString()}</p><p class="text-gray-700 text-sm mb-3">${p.content.replace(/\n/g, '<br>')}</p>${p.link ? `<a href="${p.link}" target="_blank" class="inline-block bg-green-500 text-white px-3 py-1 text-xs rounded-full hover:bg-green-600">Link</a>`:''}`; galleryEl.appendChild(card); }); }
        function listenToLabData(groupId) { if (labDataListener) labDataListener(); const resultsContainer = document.getElementById('contribution-results'); if (!groupId) { resultsContainer.classList.add('hidden'); return; } resultsContainer.classList.remove('hidden'); const q = query(collection(db, `artifacts/${firebaseConfig.projectId}/public/data/lab_records`), where("groupId", "==", groupId)); labDataListener = onSnapshot(q, (snapshot) => renderContributionResults(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })))); }
        window.calculateBlueContribution = async () => { if(isGuest) return showMessage("Veri girmek için kayıt olmalısınız.", true); const groupId = document.getElementById('group-select-lab').value; const name = document.getElementById('lab-name').value.trim(); const saved = parseFloat(document.getElementById('lab-value').value); const base = parseFloat(document.getElementById('lab-baseline').value); if(!groupId || !name || isNaN(saved) || isNaN(base) || base <= 0) return showMessage("Geçerli değerler girin.", true); const contribution = ((saved / base) * 100).toFixed(2); await addDoc(collection(db, `artifacts/${firebaseConfig.projectId}/public/data/lab_records`), { groupId, experimentName: name, savedWater: saved, baseline: base, contributionPercent: contribution, recordedById: userId, recordedByName: userName, recordedAt: new Date().toISOString() }); showMessage("Veri kaydedildi!"); document.getElementById('lab-name').value=''; document.getElementById('lab-value').value=''; document.getElementById('lab-baseline').value=''; }
        function renderContributionResults(records) { const cardEl = document.getElementById('current-contribution-card'), listEl = document.getElementById('lab-records-list'); listEl.innerHTML=''; if(records.length===0){ cardEl.innerHTML=`<p class="text-center text-gray-500">Veri yok.</p>`; return; } let totalSaved=0, totalBase=0; records.sort((a,b)=>new Date(b.recordedAt)-new Date(a.recordedAt)).forEach(rec => { totalSaved+=rec.savedWater; totalBase+=rec.baseline; const item = document.createElement('div'); item.className='bg-gray-50 p-3 rounded-lg flex justify-between items-center'; item.innerHTML = `<div><p class="font-semibold">${rec.experimentName}</p><p class="text-xs text-gray-600">Tsr: ${rec.savedWater}L / Bsl: ${rec.baseline}L (%${rec.contributionPercent})</p><p class="text-xs text-gray-400">${rec.recordedByName} - ${new Date(rec.recordedAt).toLocaleDateString()}</p></div> ${rec.recordedById === userId ? `<button onclick="deleteLabRecord('${rec.id}')" class="text-red-500 text-xs">Sil</button>` : ''}`; listEl.appendChild(item); }); const overall = totalBase > 0 ? ((totalSaved / totalBase) * 100).toFixed(2) : 0; cardEl.innerHTML = `<h4 class="text-md font-semibold text-center">Grup Performansı</h4><div class="text-center my-2"><p class="text-3xl font-bold text-accent-blue">%${overall}</p><p class="text-sm">Genel Katkı</p></div><p class="text-center text-sm text-gray-500">Toplam ${totalSaved.toLocaleString()}L tasarruf</p>`; }
        window.deleteLabRecord = async (recordId) => { if(confirm('Kaydı silmek istediğinize emin misiniz?')) { await deleteDoc(doc(db, `artifacts/${firebaseConfig.projectId}/public/data/lab_records`, recordId)); showMessage("Kayıt silindi."); } }
        
        function updateGroupSelectors(groups) {
            const optionsHTML = `<option value="">-- Grup Seçin --</option>` + groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            const selects = {
                'group-select-files': (gid) => { document.getElementById('file-upload-area').classList.toggle('hidden', !gid || isGuest); displayGroupFiles(gid); },
                'group-select-panel': (gid) => { document.getElementById('panel-editor-area').classList.toggle('hidden', !gid || isGuest); loadPanelForGroup(gid); },
                'group-select-lab': (gid) => { document.getElementById('lab-input-area').classList.toggle('hidden', !gid || isGuest); listenToLabData(gid); },
            };
            for (const id in selects) {
                const el = document.getElementById(id);
                if (el) { el.innerHTML = optionsHTML; el.onchange = (e) => selects[id](e.target.value); }
            }
        }
        
        function displayGroupFiles(groupId) {
            if(filesListener) filesListener();
            const listEl = document.getElementById('group-files-list');
            listEl.innerHTML = `<h3 class="text-xl font-bold text-gray-800 border-b pb-2">Grubun Dosyaları</h3>`; // Başlığı her zaman göster
            if(!groupId) { listEl.innerHTML += `<p class="text-gray-500 text-center py-4">Grup seçin.</p>`; return; }
            const q = query(collection(db, `artifacts/${firebaseConfig.projectId}/public/data/files`), where("groupId", "==", groupId));
            filesListener = onSnapshot(q, (snapshot) => renderFiles(snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}))));
        }

        function setupDragAndDrop() { /* ... */ }
        window.clearKitCanvas = () => { /* ... */ }

        // BAŞLANGIÇ
        window.onload = () => {
            // Oturum durumuna göre giriş modalını göster veya Firebase'i başlat
            if (localStorage.getItem('user_name')) {
                isGuest = false;
                initializeFirebase();
            } else if (sessionStorage.getItem('isGuest')) {
                isGuest = true;
                initializeFirebase();
            } else {
                 document.getElementById('auth-modal').classList.remove('hidden'); // Giriş yapılmamışsa modalı göster
            }
            setupDragAndDrop(); // Modül sekmesi için JS'yi yükle
        };
    </script>
</body>
</html>


