<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STEMCycle G2B Lab Hub</title>
    <!-- Tailwind CSS YÃ¼klemesi -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font YÃ¼klemesi -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet (Harita) CSS YÃ¼klemesi -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/SJPMeIegerwBLpT6A="
     crossorigin=""/>
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #e8f5e9; 
        } 
        
        #app {
            position: relative;
            z-index: 10;
        }

        #app::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://firebasestorage.googleapis.com/v0/b/stemcycle-g2b-innovation-efe5c.appspot.com/o/assets%2FPoster1.jpg?alt=media&token=16200cfa-135e-4b68-8094-1a938c8f0c3a'); 
            background-size: cover;
            background-position: center;
            opacity: 0.15;
            z-index: 0;
            pointer-events: none;
        }
        
        #auth-modal.has-background .modal-content {
            background-image: url('https://firebasestorage.googleapis.com/v0/b/stemcycle-g2b-innovation-efe5c.appspot.com/o/assets%2FPoster1.jpg?alt=media&token=16200cfa-135e-4b68-8094-1a938c8f0c3a');
            background-size: cover;
            background-position: center;
            color: white; 
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        
        #auth-modal.has-background .modal-inner-content {
            background-color: rgba(255, 255, 255, 0.97); 
            padding: 1.5rem;
            border-radius: 0.75rem;
            color: #1f2937;
        }

        .header-blue { background-color: #00796b; } 
        .accent-blue { background-color: #00838f; } 
        .accent-green { background-color: #4caf50; } 
        .tab-active { border-bottom: 3px solid #00838f; color: #00838f; font-weight: 600; }
        .container-fluid { max-width: 100vw; overflow-x: hidden; }
        .announcement-card { border-left: 4px solid #ffb300; }
        .project-card { border-top: 5px solid #00838f; }
        .blue-border { border-left-color: #00838f; }
        .green-border { border-left-color: #4caf50; }
        .lab-accent { background-color: #ffb300; }
        
        #user-map { height: 300px; width: 100%; border-radius: 12px; margin-bottom: 1.5rem; z-index: 5; }
        .map-manual-select #user-map { cursor: crosshair; }
        
        .module {
            cursor: grab;
            user-select: none;
            transition: transform 0.1s;
        }
        .module:active { cursor: grabbing; }
        #kit-canvas { 
            min-height: 250px; 
            background-color: #e2e8f0; 
            border: 2px dashed #94a3b8;
            position: relative;
        }
        
        .custom-div-icon {
            background-color: transparent !important;
            border: none !important;
            text-shadow: 0 0 3px #fff, 0 0 5px #000;
        }
        
        /* Tema Renkleri Buton */
        .btn-theme {
            background-image: linear-gradient(to right, #4caf50 , #00838f);
            color: white;
            transition: transform 0.2s;
        }
        .btn-theme:hover {
            transform: scale(1.03);
        }
        
    </style>
    
    <!-- Leaflet (Harita) JS YÃ¼klemesi -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20n6a9c8z2K4c40y89B7c191a3c638c1192d6e355="
     crossorigin=""></script>

    <!-- Tone.js (Ses Efektleri) YÃ¼klemesi -->
    <script src="https://unpkg.com/@tonejs/tone"></script>
</head>
<body class="container-fluid min-h-screen">

    <!-- Ana Uygulama AlanÄ± -->
    <div id="app" class="flex flex-col min-h-screen">
        
        <!-- Hesap OluÅŸturma/GiriÅŸ ModalÄ± -->
        <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 has-background">
            <div class="modal-content p-0 rounded-xl shadow-2xl w-full max-w-sm">
                
                <div class="modal-inner-content">
                    <!-- YENÄ° BUTON: Proje SayfasÄ± -->
                    <a href="https://school-education.ec.europa.eu/en/etwinning/projects/stemcycle-g2b-green-blue-innovation-lab-sustainable-vocational-education" 
                       target="_blank" 
                       rel="noopener noreferrer"
                       class="block w-full btn-theme text-white py-2 px-4 rounded-lg font-semibold text-center mb-5 shadow-md">
                        Proje SayfamÄ±zÄ± Ziyaret Et
                    </a>
                    
                    <div class="flex border-b mb-4">
                        <button id="login-tab-btn" onclick="switchAuthTab('login')" class="flex-1 py-2 font-semibold text-center text-accent-blue border-b-2 border-accent-blue">GiriÅŸ Yap</button>
                        <button id="register-tab-btn" onclick="switchAuthTab('register')" class="flex-1 py-2 font-semibold text-center text-gray-500">KayÄ±t Ol</button>
                    </div>

                    <!-- GÄ°RÄ°Åž FORMU -->
                    <div id="login-form">
                        <h2 class="text-xl font-bold mb-4 text-center text-accent-blue">STEMCycle Hub GiriÅŸi</h2>
                        <input type="email" id="login-email" placeholder="E-posta Adresiniz" class="w-full p-2 border rounded-lg mb-3">
                        <input type="password" id="login-password" placeholder="Åžifreniz" class="w-full p-2 border rounded-lg mb-4">
                        <button onclick="loginWithEmail()" class="w-full accent-blue text-white py-2 rounded-lg font-semibold hover:bg-blue-700">GiriÅŸ Yap</button>
                        <div class="my-4 text-center text-gray-500">veya</div>
                        <button onclick="loginAsGuest()" class="w-full bg-gray-500 text-white py-2 rounded-lg font-semibold hover:bg-gray-600">Misafir Olarak Devam Et</button>
                    </div>

                    <!-- KAYIT FORMU -->
                    <div id="register-form" class="hidden">
                        <h2 class="text-xl font-bold mb-4 text-center text-accent-blue">Yeni Hesap OluÅŸtur</h2>
                        <input type="text" id="register-name" placeholder="AdÄ±nÄ±z SoyadÄ±nÄ±z" class="w-full p-2 border rounded-lg mb-3">
                        <input type="email" id="register-email" placeholder="E-posta Adresiniz" class="w-full p-2 border rounded-lg mb-3">
                        <input type="password" id="register-password" placeholder="Yeni Åžifre" class="w-full p-2 border rounded-lg mb-4">
                        <button onclick="registerWithEmail()" class="w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700">KayÄ±t Ol</button>
                    </div>

                     <!-- YENÄ° BUTON: ESEP Ã–ÄŸrenci GiriÅŸi -->
                     <a href="https://school-education.ec.europa.eu/en/pupil-login" 
                        target="_blank" 
                        rel="noopener noreferrer"
                        class="block w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-semibold text-center mt-5 hover:bg-gray-300 text-sm">
                        ESEP Ã–ÄŸrenci GiriÅŸi
                     </a>
                </div>
                
                <div class="p-4 flex flex-wrap justify-center items-center space-x-2 bg-black bg-opacity-30 rounded-b-xl mt-auto">
                    <img src="https://firebasestorage.googleapis.com/v0/b/stemcycle-g2b-innovation-efe5c.appspot.com/o/assets%2FLogo1.png?alt=media&token=e516353d-8839-4469-8051-7096d445070e" alt="Logo 1" class="w-8 h-8 rounded-full opacity-80">
                    <img src="https://firebasestorage.googleapis.com/v0/b/stemcycle-g2b-innovation-efe5c.appspot.com/o/assets%2FLogo2.png?alt=media&token=25a40a24-9464-42b7-8728-c119b940e704" alt="Logo 2" class="w-8 h-8 rounded-full opacity-80">
                    <img src="https://firebasestorage.googleapis.com/v0/b/stemcycle-g2b-innovation-efe5c.appspot.com/o/assets%2FLogo3.png?alt=media&token=2bf28b03-57f4-41d9-8664-94a86b36a147" alt="Logo 3" class="w-8 h-8 rounded-full opacity-80">
                    <img src="https://firebasestorage.googleapis.com/v0/b/stemcycle-g2b-innovation-efe5c.appspot.com/o/assets%2FLogo4.png?alt=media&token=1d741f01-f2f2-4919-8686-2a6288593301" alt="Logo 4" class="w-8 h-8 rounded-full opacity-80">
                    <img src="https://firebasestorage.googleapis.com/v0/b/stemcycle-g2b-innovation-efe5c.appspot.com/o/assets%2FeTwinning-LogoHorizontal_CMYK.png?alt=media&token=9c173bd9-d41c-433b-826a-8be364b4c10c" alt="eTwinning Logosu" class="h-8 opacity-80">
                    <img src="https://firebasestorage.googleapis.com/v0/b/stemcycle-g2b-innovation-efe5c.appspot.com/o/assets%2FCodeWeek.jpg?alt=media&token=09c4d914-5dcb-497b-91d1-4171e54bf83f" alt="CodeWeek Logosu" class="w-8 h-8 rounded-full opacity-80">
                </div>
            </div>
        </div>

        <!-- BaÅŸlÄ±k ve KullanÄ±cÄ± Bilgisi -->
        <header class="header-blue text-white p-4 shadow-lg sticky top-0 z-10">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <h1 class="text-base sm:text-xl font-bold flex items-center">
                        <svg class="w-6 h-6 mr-2 text-accent-green" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9h-9m-9 0a9 9 0 019-9m-9 9h6m-9 9a9 9 0 019-9m-9 9a9 9 0 009 9m9-9a9 9 0 01-9 9m9-9h-9m-9 0a9 9 0 019-9m-9 9h6"></path></svg>
                        <span class="text-xl sm:text-2xl font-extrabold mr-2" data-i18n="app_main_title">STEMCycle G2B Lab Hub</span>
                        <span class="text-sm font-light italic hidden sm:block" data-i18n="app_subtitle">BluEcoInVET</span>
                    </h1>
                </div>
                
                <div class="flex items-center space-x-4">
                    <select id="language-select" class="bg-white text-gray-800 text-xs font-semibold p-1 rounded-md cursor-pointer hover:bg-gray-200" onchange="changeLanguage(this.value);">
                        <option value="tr">TR</option>
                        <option value="en">EN</option>
                    </select>
                    
                    <div id="user-display" class="hidden items-center space-x-3">
                        <div class="text-sm text-right">
                            <p id="user-info" class="font-semibold truncate"></p>
                            <p id="user-location" class="text-xs opacity-70 truncate"></p>
                        </div>
                         <button onclick="logoutUser()" class="bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-2 rounded">Ã‡Ä±kÄ±ÅŸ Yap</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Sekmeler -->
        <nav id="main-nav" class="bg-white shadow-md p-2 flex justify-around text-gray-600 sticky top-[68px] sm:top-[68px] z-10 overflow-x-auto whitespace-nowrap">
            <button id="tab-groups" onclick="changeTab('groups')" class="px-2 py-2 text-xs sm:text-sm flex-shrink-0 tab-active" data-i18n="tab_groups">Gruplar</button>
            <button id="tab-profile" onclick="changeTab('profile')" class="px-2 py-2 text-xs sm:text-sm flex-shrink-0" data-i18n="tab_profile">Profil</button>
            <button id="tab-files" onclick="changeTab('files')" class="px-2 py-2 text-xs sm:text-sm flex-shrink-0" data-i18n="tab_files">Dosyalar</button>
            <button id="tab-announcements" onclick="changeTab('announcements')" class="px-2 py-2 text-xs sm:text-sm flex-shrink-0" data-i18n="tab_announcements">Duyurular</button>
            <button id="tab-gallery" onclick="changeTab('gallery')" class="px-2 py-2 text-xs sm:text-sm flex-shrink-0" data-i18n="tab_boards">Panolar</button>
            <button id="tab-lab" onclick="changeTab('lab')" class="px-2 py-2 text-xs sm:text-sm flex-shrink-0" data-i18n="tab_lab_data">LAB Veri</button>
            <button id="tab-module" onclick="changeTab('module')" class="px-2 py-2 text-xs sm:text-sm flex-shrink-0" data-i18n="tab_module">
                <svg class="w-5 h-5 inline-block sm:mr-1 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 10-4 0v1a2 2 0 004 0V4zM19 4a2 2 0 10-4 0v1a2 2 0 004 0V4zM7 20h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v11a2 2 0 002 2z"></path></svg>
                ModÃ¼l
            </button>
        </nav>

        <!-- Ana Ä°Ã§erik AlanÄ± -->
        <main id="main-content" class="flex-grow p-4 space-y-6 z-10 relative">
            <!-- Ä°Ã§erik Dinamik Olarak Buraya YÃ¼klenecek -->
        </main>
        
        <footer class="bg-gray-100 p-3 text-xs text-gray-600 text-center mt-auto z-10 relative">
            <p data-i18n="project_desc"><strong>Proje AÃ§Ä±klamasÄ±:</strong> Bu platform, Karasal Sistemlerde Suya DayalÄ± Ã‡Ã¶zÃ¼mlerin (YeÅŸil Ekonomi) Mavi Ekonomiye Etkisini, Su Analizi OkuryazarlÄ±ÄŸÄ± ile iliÅŸkilendirerek gÃ¶stermeyi amaÃ§lar.</p>
            <p class="mt-1">STEMCycle G2B â€“ Green to Blue Innovation Lab | Copyright &copy; 2025</p>
        </footer>
    </div>

    <div id="message-box" class="fixed bottom-4 right-4 bg-red-500 text-white p-3 rounded-lg shadow-xl hidden transition-opacity duration-300 opacity-0 z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, signInAnonymously, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, where, arrayUnion, arrayRemove, deleteDoc, updateDoc, getDocs, orderBy, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        const translations = {
            tr: {
                app_main_title: "STEMCycle G2B Lab Hub", app_subtitle: "BluEcoInVET",
                tab_groups: "Gruplar", tab_profile: "Profil", tab_files: "Dosyalar", tab_announcements: "Duyurular", tab_boards: "Panolar", tab_lab_data: "LAB Veri", tab_module: "ModÃ¼l",
                map_title: "G2B Etki HaritasÄ±", profile_title: "Profilimi DÃ¼zenle",
                project_desc: "Proje AÃ§Ä±klamasÄ±: Bu platform, Karasal Sistemlerde Suya DayalÄ± Ã‡Ã¶zÃ¼mlerin (YeÅŸil Ekonomi) Mavi Ekonomiye Etkisini, Su Analizi OkuryazarlÄ±ÄŸÄ± ile iliÅŸkilendirerek gÃ¶stermeyi amaÃ§lar."
            },
            en: {
                app_main_title: "STEMCycle G2B Lab Hub", app_subtitle: "BluEcoInVET",
                tab_groups: "Groups", tab_profile: "Profile", tab_files: "Files", tab_announcements: "Announcements", tab_boards: "Boards", tab_lab_data: "LAB Data", tab_module: "Module",
                map_title: "G2B Impact Map", profile_title: "Edit My Profile",
                project_desc: "Project Description: This platform aims to demonstrate the impact of Water-Based Solutions in Terrestrial Systems (Green Economy) on the Blue Economy, associating it with Water Analysis Literacy."
            }
        };

        let currentLanguage = 'tr'; 
        let globalAllGroupsData = [], allUserMetadata = [];
        let app, db, auth, storage;
        let userId = null, userName = '', userSchool = '', userEmail = '', userIcon = '';
        let userLat = null, userLon = null;
        let isGuest = false;
        let userMap = null, mapMarkers = [];
        let listeners = {}; 
        
        const authModalEl = document.getElementById('auth-modal');
        
        const projectId = "stemcycle-g2b-innovation-efe5c"; 
        const apiKey = "AIzaSyAshVa6zGftQmBQcjo_HRHoOP92vb3kKgQ"; 
        const authDomain = "stemcycle-g2b-innovation-efe5c.firebaseapp.com";
        const storageBucket = "stemcycle-g2b-innovation-efe5c.appspot.com";
        const firebaseConfig = { apiKey, authDomain, projectId, storageBucket, appId: "1:79339752913:web:5379abf2794791b7bda4f0" };
        
        function showMessage(message, isError = false) {
             const box = document.getElementById('message-box');
            box.textContent = message;
            box.classList.remove('hidden', 'opacity-0');
            box.classList.add('opacity-100', isError ? 'bg-red-500' : 'bg-green-500');
            setTimeout(() => {
                box.classList.add('opacity-0');
                setTimeout(() => box.classList.add('hidden'), 300);
            }, 3000);
        }

        window.changeLanguage = (lang) => {
            currentLanguage = lang;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
        };

        window.switchAuthTab = (tab) => {
            const loginTab = document.getElementById('login-tab-btn');
            const registerTab = document.getElementById('register-tab-btn');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');

            if (tab === 'login') {
                loginTab.classList.add('text-accent-blue', 'border-accent-blue'); loginTab.classList.remove('text-gray-500');
                registerTab.classList.remove('text-accent-blue', 'border-accent-blue'); registerTab.classList.add('text-gray-500');
                loginForm.classList.remove('hidden'); registerForm.classList.add('hidden');
            } else {
                registerTab.classList.add('text-accent-blue', 'border-accent-blue'); registerTab.classList.remove('text-gray-500');
                loginTab.classList.remove('text-accent-blue', 'border-accent-blue'); loginTab.classList.add('text-gray-500');
                registerForm.classList.remove('hidden'); loginForm.classList.add('hidden');
            }
        };
        
        async function initializeAppAndAuth() {
            try {
                if (!app) {
                    app = initializeApp(firebaseConfig); 
                    db = getFirestore(app);
                    auth = getAuth(app);
                    storage = getStorage(app);
                }
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isGuest = user.isAnonymous;
                        
                        loadMainContent();

                        if (!isGuest) {
                           await fetchUserProfile(user.uid);
                        } else {
                            updateUserInfoUI();
                        }
                        
                        authModalEl.classList.add('hidden');
                        document.getElementById('user-display').classList.remove('hidden');
                        document.getElementById('user-display').classList.add('flex');
                        
                        setupRealtimeListeners();

                    } else {
                        userId = null; isGuest = true;
                        authModalEl.classList.remove('hidden');
                        document.getElementById('user-display').classList.add('hidden');
                        document.getElementById('user-display').classList.remove('flex');
                        resetUIForLogout();
                        updateUserInfoUI();
                    }
                    toggleGuestRestrictions();
                });
            } catch (error) {
                console.error("Firebase baÅŸlatma hatasÄ±:", error);
                showMessage("Uygulama baÅŸlatÄ±lamadÄ±.", true);
            }
        }

        async function fetchUserProfile(uid) {
            const userRef = doc(db, `artifacts/${projectId}/public/data/user_metadata`, uid);
            const docSnap = await getDoc(userRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                userName = data.name || 'Ä°simsiz'; userEmail = data.email || '';
                userSchool = data.school || ''; userIcon = data.icon || 'ðŸ‘¤';
                userLat = data.lat || null; userLon = data.lon || null;
            } else { 
                console.log("KullanÄ±cÄ± profili bulunamadÄ±."); 
                userName = auth.currentUser?.displayName || 'Yeni KullanÄ±cÄ±';
                userEmail = auth.currentUser?.email || '';
            }
            updateUserInfoUI();
            
            const profileNameEl = document.getElementById('profile-name');
            if (profileNameEl) { 
                profileNameEl.value = userName;
                document.getElementById('profile-email').value = userEmail;
                document.getElementById('profile-school').value = userSchool;
                document.getElementById('profile-icon').value = userIcon;
            }
        }

        window.registerWithEmail = async () => {
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            if (!name || !email || !password) return showMessage("TÃ¼m alanlar zorunludur.", true);

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                await updateProfile(user, { displayName: name });

                const userRef = doc(db, `artifacts/${projectId}/public/data/user_metadata`, user.uid);
                await setDoc(userRef, {
                    name: name,
                    email: email,
                    school: '',
                    icon: 'ðŸ‘¤',
                    lat: 0.00,
                    lon: 0.00,
                    joinedAt: serverTimestamp(),
                    lastLogin: serverTimestamp(),
                    puan: 0
                });
                showMessage("KayÄ±t baÅŸarÄ±lÄ±! GiriÅŸ yapÄ±ldÄ±.", false);
            } catch (error) {
                console.error("KayÄ±t hatasÄ±:", error);
                showMessage(`KayÄ±t baÅŸarÄ±sÄ±z: ${error.message}`, true);
            }
        };

        window.loginWithEmail = async () => {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            if (!email || !password) return showMessage("E-posta ve ÅŸifre zorunludur.", true);

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage("GiriÅŸ baÅŸarÄ±lÄ±!", false);
            } catch (error) {
                console.error("GiriÅŸ hatasÄ±:", error);
                showMessage(`GiriÅŸ baÅŸarÄ±sÄ±z: ${error.message}`, true);
            }
        };
        
        window.loginAsGuest = async () => {
            try {
                if(!auth.currentUser) {
                    await signInAnonymously(auth);
                }
                showMessage("Misafir olarak giriÅŸ yapÄ±ldÄ±.", false);
            } catch (error) {
                console.error("Misafir giriÅŸi hatasÄ±:", error);
                showMessage("Misafir giriÅŸi baÅŸarÄ±sÄ±z oldu.", true);
            }
        };

        window.logoutUser = async () => {
            try { 
                const wasGuest = auth.currentUser?.isAnonymous;
                await signOut(auth); 
                if (wasGuest) {
                    authModalEl.classList.remove('hidden');
                }
                showMessage("BaÅŸarÄ±yla Ã§Ä±kÄ±ÅŸ yapÄ±ldÄ±.", false); 
            } 
            catch(error) { console.error("Ã‡Ä±kÄ±ÅŸ hatasÄ±:", error); }
        };

        window.updateUserProfile = async () => {
            if (isGuest || !userId) return showMessage("Bu Ã¶zellik iÃ§in kayÄ±tlÄ± Ã¼ye olmalÄ±sÄ±nÄ±z.", true);
            const newSchool = document.getElementById('profile-school').value.trim();
            const newIcon = document.getElementById('profile-icon').value.trim();
            try {
                const userRef = doc(db, `artifacts/${projectId}/public/data/user_metadata`, userId);
                await updateDoc(userRef, {
                    school: newSchool,
                    icon: newIcon || 'ðŸ‘¤'
                });
                userSchool = newSchool;
                userIcon = newIcon || 'ðŸ‘¤';
                updateUserInfoUI();
                showMessage("Profil baÅŸarÄ±yla gÃ¼ncellendi!", false);
            } catch (error) {
                console.error("Profil gÃ¼ncelleme hatasÄ±:", error);
                showMessage("Profil gÃ¼ncellenemedi.", true);
            }
        };

        function updateUserInfoUI() {
             const userInfoEl = document.getElementById('user-info');
             const userLocationEl = document.getElementById('user-location');
             if(!userInfoEl || !userLocationEl) return;

             if (isGuest) {
                 userInfoEl.textContent = "Misafir KullanÄ±cÄ±";
                 userLocationEl.textContent = "GÃ¶rÃ¼ntÃ¼leme Modu";
             } else if (userId) {
                 userInfoEl.textContent = `${userIcon} ${userName}`;
                 userLocationEl.textContent = userSchool || "Okul belirtilmemiÅŸ";
             } else {
                 userInfoEl.textContent = "GiriÅŸ yapÄ±lmadÄ±";
                 userLocationEl.textContent = "";
             }
        }
        
        function resetUIForLogout() {
             Object.values(listeners).forEach(unsubscribe => unsubscribe());
             listeners = {};
             document.getElementById('main-content').innerHTML = '';
             document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('tab-active'));
             const groupsTab = document.getElementById('tab-groups');
             if(groupsTab) groupsTab.classList.add('tab-active');
        }

        function toggleGuestRestrictions() {
            const profileTab = document.getElementById('tab-profile');
            if(profileTab) profileTab.style.display = isGuest ? 'none' : 'flex';
            if (isGuest && profileTab && profileTab.classList.contains('tab-active')) {
                changeTab('groups');
            }
        }
        
        function setupRealtimeListeners() {
            Object.values(listeners).forEach(unsubscribe => unsubscribe());
            listeners = {};
            
            listeners.users = onSnapshot(collection(db, `artifacts/${projectId}/public/data/user_metadata`), (snapshot) => {
                allUserMetadata = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateCurrentViewData();
            });

            listeners.groups = onSnapshot(collection(db, `artifacts/${projectId}/public/data/groups`), (snapshot) => {
                globalAllGroupsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data()}));
                updateCurrentViewData();
            });
        }

        function updateCurrentViewData() {
            const currentView = document.querySelector('.tab-content:not(.hidden)');
            if (currentView) {
                switch(currentView.id) {
                    case 'groups-view':
                        renderAllGroups(globalAllGroupsData);
                        renderAllUsers();
                        renderUserMap(allUserMetadata, globalAllGroupsData);
                        break;
                    case 'files-view':
                        updateFileGroupSelector();
                        break;
                    case 'gallery-view':
                        updatePanelGroupSelector();
                        break;
                    case 'lab-view':
                        updateLabGroupSelector();
                        break;
                    case 'module-view':
                        updateKitGroupSelector();
                        break;
                }
            }
        }
        
        function loadMainContent() {
            const mainContent = document.getElementById('main-content');
            if (!mainContent.innerHTML.trim()) { 
                mainContent.innerHTML = `
                    <section id="groups-view" class="tab-content"></section>
                    <section id="profile-view" class="tab-content hidden"></section>
                    <section id="files-view" class="tab-content hidden"></section>
                    <section id="announcements-view" class="tab-content hidden"></section>
                    <section id="gallery-view" class="tab-content hidden"></section>
                    <section id="lab-view" class="tab-content hidden"></section>
                    <section id="module-view" class="tab-content hidden"></section>
                `;
            }
            changeTab('groups');
        }
        
        // --- VIEW LOADERS (TÃœMÃœ EKLENDÄ°) ---
        function loadGroupsView() {
            const view = document.getElementById('groups-view');
            if(!view) return;
            view.innerHTML = `
                <div class="bg-white p-4 rounded-xl shadow-lg mb-6 map-container">
                    <div class="flex justify-between items-center border-b pb-2 mb-4">
                        <h2 class="text-xl font-bold text-gray-800 flex items-center" data-i18n="map_title">G2B Etki HaritasÄ±</h2>
                        <button id="manual-location-btn" onclick="enableManualLocationSet()" class="text-xs bg-blue-100 text-blue-700 font-semibold py-1 px-3 rounded-lg hover:bg-blue-200 transition">Konumu Ayarla</button>
                    </div>
                    <div id="user-map"><p class="text-center text-gray-500 py-16">Harita yÃ¼kleniyor...</p></div>
                </div>
                <div id="group-management-ui" class="bg-white p-4 rounded-xl shadow-lg mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center border-b pb-2">Grup OluÅŸtur / KatÄ±l</h2>
                     <input type="text" id="new-group-name" placeholder="Yeni Grup AdÄ±" class="w-full p-2 border rounded-lg mb-3">
                     <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Proje Odak NoktasÄ±:</label><div class="flex space-x-4"><label class="inline-flex items-center"><input type="radio" name="economyFocus" value="Mavi" checked class="form-radio text-accent-blue"><span class="ml-2 font-medium text-accent-blue">Mavi Ekonomi</span></label><label class="inline-flex items-center"><input type="radio" name="economyFocus" value="YeÅŸil" class="form-radio text-accent-green"><span class="ml-2 font-medium text-accent-green">YeÅŸil Ekonomi</span></label></div></div>
                    <button onclick="createGroup()" class="w-full accent-blue text-white py-2 rounded-lg font-semibold">Grup OluÅŸtur</button>
                </div>
                <div id="all-groups-list" class="space-y-4 mb-8"></div>
                <div id="user-list-container" class="bg-white p-4 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Aktif KullanÄ±cÄ±lar</h2>
                    <div id="all-users-list" class="space-y-2 max-h-64 overflow-y-auto"></div>
                </div>`;
            initializeMap();
            if (isGuest) {
                const groupManagementUI = document.getElementById('group-management-ui');
                groupManagementUI.querySelector('button').disabled = true;
                groupManagementUI.querySelector('input').disabled = true;
                groupManagementUI.style.opacity = '0.6';
                document.getElementById('manual-location-btn').style.display = 'none';
            }
            renderAllGroups(globalAllGroupsData);
            renderAllUsers();
            renderUserMap(allUserMetadata, globalAllGroupsData);
        }

        function loadProfileView() {
             const view = document.getElementById('profile-view');
             if(!view) return;
             view.innerHTML = `<div class="bg-white p-4 rounded-xl shadow-lg max-w-lg mx-auto">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2" data-i18n="profile_title">Profilimi DÃ¼zenle</h2>
                    <div class="space-y-4">
                        <div><label class="block text-sm font-medium text-gray-700">Ä°sim Soyisim</label><input type="text" id="profile-name" class="mt-1 w-full p-2 border rounded-lg bg-gray-100" readonly></div>
                        <div><label class="block text-sm font-medium text-gray-700">E-posta</label><input type="email" id="profile-email" class="mt-1 w-full p-2 border rounded-lg bg-gray-100" readonly></div>
                        <div><label class="block text-sm font-medium text-gray-700">Okul / Ãœlke</label><input type="text" id="profile-school" class="mt-1 w-full p-2 border rounded-lg" placeholder="Okulunuz / Ãœlkeniz"></div>
                         <div><label class="block text-sm font-medium text-gray-700">Profil Simgesi (Emoji)</label><input type="text" id="profile-icon" class="mt-1 w-full p-2 border rounded-lg" placeholder="ðŸš€, ðŸŒ³, ðŸ’§, vb."></div>
                        <button onclick="updateUserProfile()" class="w-full accent-green text-white py-2 rounded-lg font-semibold hover:bg-green-600">Profili GÃ¼ncelle</button>
                    </div>
                </div>`;
            fetchUserProfile(userId);
        }

        function loadFilesView() {
            const view = document.getElementById('files-view');
            if (!view) return;
            view.innerHTML = `<div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-gray-400">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Dosya ve Link PaylaÅŸÄ±mÄ±</h2>
                    <p class="text-sm text-gray-600 mb-4">LÃ¼tfen dosya paylaÅŸmak istediÄŸiniz grubu seÃ§in.</p>
                    <select id="group-select-files" class="w-full p-2 border rounded-lg mb-4"></select>
                    <div id="file-upload-area" class="hidden">
                         <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">PaylaÅŸÄ±m TÃ¼rÃ¼:</label>
                            <div class="flex space-x-4">
                                <label class="inline-flex items-center"><input type="radio" name="uploadType" value="file" onchange="toggleFileInput('file')" checked class="form-radio text-accent-blue"><span class="ml-2">Dosya YÃ¼kle</span></label>
                                <label class="inline-flex items-center"><input type="radio" name="uploadType" value="url" onchange="toggleFileInput('url')" class="form-radio text-accent-blue"><span class="ml-2">Link Ekle</span></label>
                            </div>
                        </div>
                        <input type="file" id="file-input" class="w-full p-2 border border-gray-300 rounded-lg mb-3">
                        <input type="url" id="url-input" placeholder="http://tinkercad.com/proje-linki" class="w-full p-2 border border-gray-300 rounded-lg mb-3 hidden">
                        <input type="text" id="file-description" placeholder="AÃ§Ä±klama" class="w-full p-2 border border-gray-300 rounded-lg mb-3">
                        <button id="upload-btn" onclick="uploadFile()" class="w-full accent-blue text-white py-2 rounded-lg font-semibold hover:bg-blue-600">YÃ¼kle</button>
                    </div>
                </div>
                <div id="group-files-list" class="mt-6 space-y-4"><p class="text-gray-500 text-center py-8">DosyalarÄ± gÃ¶rmek iÃ§in bir grup seÃ§in.</p></div>`;
            
            updateFileGroupSelector();
             if (isGuest) {
                document.getElementById('file-upload-area').style.display = 'none';
             }
        }
        
        function loadAnnouncementsView() {
             const view = document.getElementById('announcements-view');
             if(!view) return;
             view.innerHTML = ` <div id="announcement-form-container" class="bg-white p-4 rounded-xl shadow-lg mb-6 border-l-4 border-orange-500">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Yeni Duyuru YayÄ±nla</h2>
                    <input type="text" id="announcement-title" placeholder="Duyuru BaÅŸlÄ±ÄŸÄ±" class="w-full p-2 border rounded-lg mb-3">
                    <textarea id="announcement-content" placeholder="Duyuru Metni" rows="3" class="w-full p-2 border rounded-lg mb-3"></textarea>
                    <button onclick="publishAnnouncement()" class="w-full lab-accent text-white py-2 rounded-lg font-semibold hover:bg-orange-600">YayÄ±nla</button>
                </div>
                <div id="announcements-list" class="space-y-4">
                    <h3 class="text-xl font-bold text-gray-800 border-b pb-2">TÃ¼m Proje DuyurularÄ±</h3>
                </div>`;
            if(isGuest) {
                document.getElementById('announcement-form-container').style.display = 'none';
            }
             if(listeners.announcements) listeners.announcements();
             listeners.announcements = onSnapshot(query(collection(db, `artifacts/${projectId}/public/data/announcements`), orderBy('createdAt', 'desc')), (snapshot) => {
                 renderAnnouncements(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
             });
        }
        
        function loadGalleryView() {
            const view = document.getElementById('gallery-view');
            if (!view) return;
            view.innerHTML = `<div class="bg-white p-4 rounded-xl shadow-lg border-l-4 border-teal-500">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Grup Proje Panosu</h2>
                    <select id="group-select-panel" class="w-full p-2 border rounded-lg mb-4"></select>
                    <div id="panel-editor-area" class="hidden">
                        <input type="text" id="panel-title" placeholder="Pano BaÅŸlÄ±ÄŸÄ± (Ã–rn: AkÄ±llÄ± Su YÃ¶netimi)" class="w-full p-2 border rounded-lg mb-3">
                        <textarea id="panel-content" placeholder="Proje detaylarÄ±, YeÅŸil/Mavi Ekonomi baÄŸlantÄ±sÄ±..." rows="5" class="w-full p-2 border rounded-lg mb-3"></textarea>
                        <input type="url" id="panel-link" placeholder="Tinkercad veya Sunum Linki" class="w-full p-2 border rounded-lg mb-3">
                        <button onclick="saveProjectPanel()" class="w-full accent-green text-white py-2 rounded-lg font-semibold hover:bg-green-600">Panoyu Kaydet/GÃ¼ncelle</button>
                    </div>
                </div>
                <div id="project-gallery" class="mt-6 space-y-4">
                    <h3 class="text-xl font-bold text-gray-800 border-b pb-2">Ä°novasyon Galerisi</h3>
                </div>`;
            
            updatePanelGroupSelector();
            if(isGuest) {
                document.getElementById('panel-editor-area').style.display = 'none';
            }
            if(listeners.panels) listeners.panels();
            listeners.panels = onSnapshot(query(collection(db, `artifacts/${projectId}/public/data/panels`), orderBy('updatedAt', 'desc')), (snapshot) => {
                 renderProjectGallery(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
             });
        }

        function loadLabView() {
            const view = document.getElementById('lab-view');
            if(!view) return;
            view.innerHTML = `<div class="bg-white p-4 rounded-xl shadow-lg border-l-4 lab-accent">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">LAB SonuÃ§larÄ± Takibi</h2>
                    <p class="text-sm text-gray-600 mb-4">Deney/simÃ¼lasyon sonuÃ§larÄ±nÄ± girerek Mavi Ekonomi etkinizi takip edin.</p>
                    <select id="group-select-lab" class="w-full p-2 border rounded-lg mb-4"></select>
                    <div id="lab-input-area" class="hidden">
                        <input type="text" id="lab-name" placeholder="Deney AdÄ± (Ã–rn: Gri Su Geri DÃ¶nÃ¼ÅŸÃ¼m)" class="w-full p-2 border rounded-lg mb-3">
                        <input type="number" id="lab-value" placeholder="Tasarruf Edilen Su (Litre/Ay)" class="w-full p-2 border rounded-lg mb-3">
                        <input type="number" id="lab-baseline" placeholder="Temel TÃ¼ketim (Litre/Ay, Ã–rn: 1000)" class="w-full p-2 border rounded-lg mb-3">
                        <button onclick="calculateBlueContribution()" class="w-full lab-accent text-white py-2 rounded-lg font-semibold hover:bg-orange-600">KatkÄ±yÄ± Hesapla ve Kaydet</button>
                    </div>
                </div>
                <div id="contribution-results" class="mt-6 space-y-4">
                    <h3 class="text-xl font-bold text-gray-800 border-b pb-2">Grup KatkÄ± PuanlarÄ± ve GeÃ§miÅŸi</h3>
                    <div id="lab-records-list" class="space-y-3"></div>
                </div>`;
            
            updateLabGroupSelector();
            if(isGuest) {
                document.getElementById('lab-input-area').style.display = 'none';
            }
        }
        
        function loadModuleView() {
            const view = document.getElementById('module-view');
            if(!view) return;
            view.innerHTML = `<div class="bg-white p-4 rounded-xl shadow-lg mb-6 border-l-4 border-orange-500">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center border-b pb-2">Sanal ModÃ¼l GeliÅŸtirme</h2>
                    <p class="text-sm text-gray-600 mb-4">ModÃ¼lleri sÃ¼rÃ¼kleyip, Sanal Kit AlanÄ±na bÄ±rakarak deney dÃ¼zeneklerinizi inÅŸa edin.</p>
                    <div id="create-custom-module" class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <h3 class="text-sm font-semibold text-blue-700 mb-2">Kendi ModÃ¼lÃ¼nÃ¼ OluÅŸtur</h3>
                        <div class="flex space-x-2">
                             <input type="text" id="custom-module-name" placeholder="ModÃ¼l AdÄ± (Ã–rn: TDS Ã–lÃ§er)" class="w-1/2 p-2 border rounded-lg text-xs">
                             <select id="custom-module-type" class="w-1/4 p-2 border rounded-lg text-xs">
                                 <option value="sensor">SensÃ¶r</option><option value="actuator">AktÃ¼atÃ¶r</option><option value="input">GiriÅŸ</option><option value="control">Kontrol</option><option value="storage">Depolama</option>
                             </select>
                            <button onclick="createCustomModule()" class="w-1/4 bg-blue-500 text-white py-2 rounded-lg font-semibold hover:bg-blue-600 text-xs">BloÄŸu Ekle</button>
                        </div>
                    </div>
                    <div id="module-palette" class="flex flex-wrap gap-3 p-3 bg-gray-100 rounded-lg mb-4">
                        <div class="module bg-white text-gray-700 p-2 rounded-lg shadow-md text-xs font-semibold" draggable="true" data-type="sensor" data-name="pH_Sensor">pH SensÃ¶r</div>
                        <div class="module bg-white text-gray-700 p-2 rounded-lg shadow-md text-xs font-semibold" draggable="true" data-type="actuator" data-name="Pump">Su PompasÄ±</div>
                        <div class="module bg-white text-gray-700 p-2 rounded-lg shadow-md text-xs font-semibold" draggable="true" data-type="input" data-name="Rain_Collector">YaÄŸmur ToplayÄ±cÄ±</div>
                        <div class="module bg-white text-gray-700 p-2 rounded-lg shadow-md text-xs font-semibold" draggable="true" data-type="control" data-name="Microcontroller">KontrolcÃ¼ (IoT)</div>
                        <div class="module bg-white text-gray-700 p-2 rounded-lg shadow-md text-xs font-semibold" draggable="true" data-type="storage" data-name="Greywater_Tank">Gri Su TankÄ±</div>
                    </div>
                    <div class="flex space-x-2 mb-4">
                        <select id="group-select-kit" class="w-1/3 p-2 border rounded-lg text-sm"><option value="">-- Grup SeÃ§in --</option></select>
                        <select id="saved-kits-select" class="w-1/3 p-2 border rounded-lg text-sm"><option value="">-- KayÄ±tlÄ± Kitler --</option></select>
                        <button onclick="loadSavedKit()" class="w-1/3 bg-blue-500 text-white py-2 rounded-lg font-semibold hover:bg-blue-600 text-xs">Kiti YÃ¼kle</button>
                    </div>
                    <h3 class="text-md font-semibold text-gray-700 mb-2">Sanal Kit Ä°nÅŸa AlanÄ±</h3>
                    <div id="kit-canvas" class="rounded-lg shadow-inner relative">
                        <p class="text-center text-gray-500 pt-16">ModÃ¼lleri Buraya SÃ¼rÃ¼kleyin</p>
                    </div>
                    <div class="flex space-x-2 mt-4">
                        <button onclick="saveKitCanvas()" class="w-1/2 bg-accent-blue text-white py-2 rounded-lg font-semibold hover:bg-blue-600">Kiti Kaydet</button>
                        <button onclick="clearKitCanvas()" class="w-1/2 bg-red-500 text-white py-2 rounded-lg font-semibold hover:bg-red-600">Temizle</button>
                    </div>
                </div>`;
            
            if(isGuest) {
                document.getElementById('create-custom-module').style.display = 'none';
                document.querySelector('#module-view button[onclick="saveKitCanvas()"]').style.display = 'none';
                document.querySelector('#module-view button[onclick="clearKitCanvas()"]').style.display = 'none';
            }
            updateKitGroupSelector();
            setupDragAndDrop();

            if(listeners.customModules) listeners.customModules();
            listeners.customModules = onSnapshot(collection(db, `artifacts/${projectId}/public/data/custom_modules`), (snapshot) => {
                 renderCustomModules(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
             });
        }

        window.changeTab = (tabName) => {
             document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('tab-active'));
             const tabButton = document.getElementById(`tab-${tabName}`);
             if(tabButton) tabButton.classList.add('tab-active');
             
             document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
             const view = document.getElementById(`${tabName}-view`);
             if (view) view.classList.remove('hidden');

             const viewLoaders = {
                 'groups': loadGroupsView,
                 'profile': loadProfileView,
                 'files': loadFilesView,
                 'announcements': loadAnnouncementsView,
                 'gallery': loadGalleryView,
                 'lab': loadLabView,
                 'module': loadModuleView,
             };
             
             if(viewLoaders[tabName]) {
                 viewLoaders[tabName]();
             } else {
                 if(view) view.innerHTML = `<p class="text-center text-gray-500 py-16">'${tabName}' sekmesi yapÄ±m aÅŸamasÄ±ndadÄ±r.</p>`;
             }
        };

        function initializeMap() {
             if (userMap) { userMap.remove(); userMap = null; }
             if (typeof window.L?.map !== 'function' || !document.getElementById('user-map')) {
                 setTimeout(initializeMap, 150); return;
             }
             const mapContainer = document.getElementById('user-map');
             if (mapContainer && !mapContainer._leaflet_id) {
                 userMap = window.L.map('user-map').setView([30, 20], 3);
                 window.L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(userMap);
             }
        }
        
        window.enableManualLocationSet = () => {
            if(isGuest || !userMap) return;
            const mapContainer = document.querySelector('.map-container');
            mapContainer.classList.add('map-manual-select');
            showMessage("LÃ¼tfen haritada konumunuzu seÃ§in.", false);
            userMap.once('click', async (e) => {
                const { lat, lng } = e.latlng;
                userLat = lat.toFixed(4);
                userLon = lng.toFixed(4);
                try {
                     const userRef = doc(db, `artifacts/${projectId}/public/data/user_metadata`, userId);
                     await updateDoc(userRef, { lat: userLat, lon: userLon });
                     showMessage("Konum baÅŸarÄ±yla gÃ¼ncellendi!", false);
                } catch(error) {
                    console.error("Konum gÃ¼ncelleme hatasÄ±:", error);
                    showMessage("Konum gÃ¼ncellenemedi.", true);
                } finally {
                     mapContainer.classList.remove('map-manual-select');
                }
            });
        };
        
        function renderUserMap(users, groups) { 
            if (!userMap) { setTimeout(() => renderUserMap(users, groups), 150); return; }
            mapMarkers.forEach(marker => marker.remove());
            mapMarkers = [];
            
            const groupMap = {};
            groups.forEach(g => {
                g.members.forEach(memberId => {
                    if (!groupMap[memberId]) groupMap[memberId] = [];
                    groupMap[memberId].push(g.name);
                });
            });

            let validLocationsExist = false;
            users.forEach(user => {
                const lat = parseFloat(user.lat);
                const lon = parseFloat(user.lon);
                if (isNaN(lat) || isNaN(lon) || (lat === 0 && lon === 0)) return;
                
                validLocationsExist = true;
                const popupContent = `
                    <div class="font-bold text-base">${user.icon || 'ðŸ‘¤'} ${user.name}</div>
                    <div class="text-sm text-gray-700">${user.school || 'Okul BelirtilmemiÅŸ'}</div>
                    <div class="text-xs text-gray-500 mt-1">Gruplar: ${groupMap[user.id]?.join(', ') || 'Yok'}</div>
                `;
                 const customIcon = window.L.divIcon({
                    className: "custom-div-icon",
                    html: `<div style="font-size: 24px;">${user.icon || 'ðŸ‘¤'}</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 30]
                });

                const marker = window.L.marker([lat, lon], { icon: customIcon }).bindPopup(popupContent).addTo(userMap);
                mapMarkers.push(marker);
            });

            if (validLocationsExist && document.getElementById('groups-view')?.offsetParent !== null) {
                 const bounds = window.L.featureGroup(mapMarkers).getBounds();
                 if (bounds.isValid()) { userMap.fitBounds(bounds, { padding: [50, 50], maxZoom: 12 }); }
            } else if (userMap) {
                userMap.setView([30, 20], 3);
            }
        }
        
        function renderAllUsers() { 
            const userListEl = document.getElementById('all-users-list');
            if(!userListEl) return;
            userListEl.innerHTML = '';
            if (allUserMetadata.length === 0) {
                 userListEl.innerHTML = `<p class="text-gray-500 text-center py-4">Sisteme kayÄ±tlÄ± kullanÄ±cÄ± bulunamadÄ±.</p>`;
                 return;
            }
            const threeDaysAgo = new Date(Date.now() - 3 * 24 * 60 * 60 * 1000);
            
            const sortedUsers = [...allUserMetadata].sort((a, b) => {
                const dateA = a.lastLogin?.toDate ? a.lastLogin.toDate() : new Date(0);
                const dateB = b.lastLogin?.toDate ? b.lastLogin.toDate() : new Date(0);
                return dateB - dateA;
            });

            sortedUsers.forEach(user => {
                const isCurrentUser = user.id === userId;
                const lastLoginDate = user.lastLogin?.toDate ? user.lastLogin.toDate() : new Date(0);
                const joinedDate = user.joinedAt?.toDate ? user.joinedAt.toDate() : null;
                const dateStr = joinedDate ? joinedDate.toLocaleDateString('tr-TR') : 'Bilinmiyor';
                const isActive = lastLoginDate > threeDaysAgo;
                
                const userCard = document.createElement('div');
                userCard.className = `p-2 rounded-lg flex items-center space-x-2 ${isActive ? 'bg-green-100 border border-green-300' : 'bg-gray-50'}`;
                userCard.innerHTML = `
                    <span class="text-lg">${user.icon || 'ðŸ‘¤'}</span>
                    <div>
                        <p class="font-semibold text-sm ${isCurrentUser ? 'text-blue-700' : 'text-gray-800'}">
                            ${user.name} ${isCurrentUser ? `<span class="text-xs font-normal text-red-500">(Siz)</span>` : ''}
                            ${isActive && !isCurrentUser ? `<span class="text-xs font-bold text-green-600 ml-1">(AKTÄ°F)</span>` : ''}
                        </p>
                        <p class="text-xs text-gray-600">${user.school || 'Okul BelirtilmemiÅŸ'} | KatÄ±lÄ±m: ${dateStr}</p>
                    </div>`;
                userListEl.appendChild(userCard);
            });
        }
        
        function renderAllGroups(groups) {
             const allGroupsListEl = document.getElementById('all-groups-list');
            if(!allGroupsListEl) return;
            allGroupsListEl.innerHTML = '';
            if (groups.length === 0) {
                allGroupsListEl.innerHTML = `<p class="text-gray-500 text-center py-8">HenÃ¼z oluÅŸturulmuÅŸ bir grup yok.</p>`;
                return;
            }
            groups.forEach(group => {
                const isMember = group.members.includes(userId);
                const memberListHtml = group.members.map(memberId => {
                    const metadata = allUserMetadata.find(u => u.id === memberId) || { name: `ID:${memberId.substring(0, 5)}`, school: 'Bilinmiyor', icon: 'ðŸ‘¤' };
                    return `<li class="flex items-center text-xs text-gray-700 py-0.5"><span class="mr-2">${metadata.icon}</span><span class="font-medium">${metadata.name}</span> <span class="text-gray-500 ml-1">(${metadata.school})</span></li>`;
                }).join('');

                let buttonHTML = '';
                if (!isGuest) {
                    if (isMember) { 
                        buttonHTML = `<button onclick="leaveGroup('${group.id}')" class="text-xs text-red-600 hover:text-red-800 font-medium p-1 rounded-md border border-red-300 transition">Gruptan AyrÄ±l</button>`; 
                    } else { 
                        buttonHTML = `<button onclick="joinGroup('${group.id}')" class="text-xs text-green-600 hover:text-green-800 font-medium p-1 rounded-md border border-green-300 transition">Gruba KatÄ±l</button>`; 
                    }
                }
                
                const card = document.createElement('div');
                card.className = `p-4 rounded-xl shadow-md space-y-2 bg-white border-l-4 ${group.economyFocus === 'YeÅŸil' ? 'border-green-500' : 'border-blue-500'}`;
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h3 class="text-lg font-semibold text-gray-800">${group.name}</h3>
                        <span class="text-xs font-semibold px-2 py-0.5 rounded text-white ${group.economyFocus === 'YeÅŸil' ? 'bg-accent-green' : 'bg-accent-blue'}">
                            Odak: ${group.economyFocus} Ekonomi
                        </span>
                    </div>
                    <h4 class="text-sm font-semibold text-gray-700 mt-3 border-t pt-2">Ãœyeler (${group.members.length}):</h4>
                    <ul class="list-none space-y-1 pl-0 max-h-20 overflow-y-auto">${memberListHtml}</ul>
                    <div class="flex space-x-2 pt-2 border-t mt-3">${buttonHTML}</div>`;
                allGroupsListEl.appendChild(card);
            });
        }
        
        // --- FILES TAB ---
        function updateFileGroupSelector() {
            const selectEl = document.getElementById('group-select-files');
            if (!selectEl) return;
            const myGroups = globalAllGroupsData.filter(g => g.members.includes(userId));
            selectEl.innerHTML = `<option value="">-- Grup SeÃ§in --</option>` + myGroups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            selectEl.onchange = (e) => displayGroupFiles(e.target.value);
        }
        function displayGroupFiles(groupId) {
            const uploadArea = document.getElementById('file-upload-area');
            const fileList = document.getElementById('group-files-list');
            if(!uploadArea || !fileList) return;
            uploadArea.classList.toggle('hidden', !groupId || isGuest);
            if (listeners.files) listeners.files();
            if (!groupId) { fileList.innerHTML = `<p class="text-gray-500 text-center py-8">DosyalarÄ± gÃ¶rmek iÃ§in bir grup seÃ§in.</p>`; return; }
            const q = query(collection(db, `artifacts/${projectId}/public/data/files`), where("groupId", "==", groupId), orderBy("uploadedAt", "desc"));
            listeners.files = onSnapshot(q, (snapshot) => renderGroupFiles(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
        }
        window.toggleFileInput = (type) => {
            document.getElementById('file-input').classList.toggle('hidden', type !== 'file');
            document.getElementById('url-input').classList.toggle('hidden', type !== 'url');
        }
        window.uploadFile = async () => {
            if (isGuest) return;
            const groupId = document.getElementById('group-select-files').value;
            const description = document.getElementById('file-description').value.trim();
            const uploadType = document.querySelector('input[name="uploadType"]:checked').value;
            if (!groupId) return showMessage("LÃ¼tfen bir grup seÃ§in.", true);
            try {
                let fileUrl = '', fileName = '', fileType = '';
                if (uploadType === 'url') {
                    fileUrl = document.getElementById('url-input').value.trim();
                    if(!fileUrl.startsWith('http')) return showMessage("LÃ¼tfen geÃ§erli bir link girin.", true);
                    fileName = description || fileUrl; fileType = 'link';
                } else {
                    const file = document.getElementById('file-input').files[0];
                    if (!file) return showMessage("LÃ¼tfen bir dosya seÃ§in.", true);
                    const storageRef = ref(storage, `artifacts/${projectId}/group_files/${groupId}/${Date.now()}-${file.name}`);
                    await uploadBytes(storageRef, file);
                    fileUrl = await getDownloadURL(storageRef);
                    fileName = file.name; fileType = file.type;
                }
                const docRef = doc(collection(db, `artifacts/${projectId}/public/data/files`));
                await setDoc(docRef, { 
                    groupId, uploaderId: userId, uploaderName: userName, 
                    fileName, description, fileUrl, fileType, 
                    uploadedAt: serverTimestamp() 
                });
                showMessage("BaÅŸarÄ±yla paylaÅŸÄ±ldÄ±!", false);
                document.getElementById('file-description').value = ''; 
                document.getElementById('url-input').value = ''; 
                document.getElementById('file-input').value = '';
            } catch(e) { console.error("Dosya yÃ¼kleme hatasÄ±: ", e); showMessage("Dosya yÃ¼klenemedi.", true); }
        }
        window.deleteFile = async (fileId, fileUrl, fileType) => {
            if(isGuest || !confirm("Bu dosyayÄ± kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz?")) return;
            try {
                await deleteDoc(doc(db, `artifacts/${projectId}/public/data/files`, fileId));
                if (fileType !== 'link' && fileUrl) {
                    const storageRef = ref(storage, fileUrl);
                    await deleteObject(storageRef);
                }
                showMessage("Dosya baÅŸarÄ±yla silindi.", false);
            } catch (error) { console.error("Dosya silme hatasÄ±:", error); showMessage("Dosya silinemedi.", true); }
        };
        function renderGroupFiles(files) {
            const fileListEl = document.getElementById('group-files-list');
            if(!fileListEl) return;
            if (files.length === 0) { fileListEl.innerHTML = `<p class="text-gray-500 text-center py-8">Bu grupta henÃ¼z dosya paylaÅŸÄ±lmamÄ±ÅŸ.</p>`; return; }
            fileListEl.innerHTML = '';
            files.forEach(file => {
                const dateStr = file.uploadedAt?.toDate().toLocaleString('tr-TR') || '';
                const isOwner = file.uploaderId === userId;
                const card = document.createElement('div');
                card.className = "p-4 bg-white rounded-lg shadow-md flex items-center justify-between";
                card.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="text-2xl">${file.fileType === 'link' ? 'ðŸ”—' : 'ðŸ“„'}</div>
                        <div>
                            <a href="${file.fileUrl}" target="_blank" rel="noopener noreferrer" class="font-bold text-accent-blue hover:underline">${file.fileName}</a>
                            <p class="text-sm text-gray-600">${file.description}</p>
                            <p class="text-xs text-gray-400">YÃ¼kleyen: ${file.uploaderName} - ${dateStr}</p>
                        </div>
                    </div>
                    ${!isGuest && isOwner ? `<button onclick="deleteFile('${file.id}', '${file.fileUrl}', '${file.fileType}')" class="text-xs bg-red-100 text-red-700 font-semibold py-1 px-2 rounded-lg hover:bg-red-200">Sil</button>` : ''}
                `;
                fileListEl.appendChild(card);
            });
        }
        
        // --- ANNOUNCEMENTS TAB ---
        window.publishAnnouncement = async () => {
            if(isGuest) return;
            const title = document.getElementById('announcement-title').value.trim();
            const content = document.getElementById('announcement-content').value.trim();
            if(!title || !content) return showMessage("BaÅŸlÄ±k ve iÃ§erik boÅŸ olamaz.", true);
            try {
                 await setDoc(doc(collection(db, `artifacts/${projectId}/public/data/announcements`)), {
                     title, content, authorId: userId, authorName: userName, createdAt: serverTimestamp()
                 });
                 document.getElementById('announcement-title').value = '';
                 document.getElementById('announcement-content').value = '';
                 showMessage("Duyuru baÅŸarÄ±yla yayÄ±nlandÄ±.", false);
            } catch(e) { console.error(e); showMessage("Duyuru yayÄ±nlanamadÄ±.", true); }
        };
        function renderAnnouncements(announcements) {
             const listEl = document.getElementById('announcements-list');
             if(!listEl) return;
             const heading = listEl.querySelector('h3');
             listEl.innerHTML = '';
             if(heading) listEl.appendChild(heading);
             if(announcements.length === 0) { listEl.innerHTML += `<p class="text-gray-500 text-center py-8">HenÃ¼z duyuru yok.</p>`; return; }
             announcements.forEach(ann => {
                const dateStr = ann.createdAt?.toDate().toLocaleString('tr-TR') || '';
                const card = document.createElement('div');
                card.className = 'p-4 bg-white rounded-xl shadow-md announcement-card';
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <h4 class="font-bold text-lg text-gray-800">${ann.title}</h4>
                        ${!isGuest && ann.authorId === userId ? `<button onclick="deleteAnnouncement('${ann.id}')" class="text-xs text-red-500 hover:text-red-700">Sil</button>` : ''}
                    </div>
                    <p class="text-gray-700 my-2">${ann.content}</p>
                    <p class="text-xs text-gray-500 text-right">YayÄ±nlayan: ${ann.authorName} - ${dateStr}</p>
                `;
                listEl.appendChild(card);
             });
        }
        window.deleteAnnouncement = async (id) => {
            if(isGuest || !confirm("Bu duyuruyu silmek istediÄŸinizden emin misiniz?")) return;
            await deleteDoc(doc(db, `artifacts/${projectId}/public/data/announcements`, id));
        };

        // --- GALLERY TAB ---
        function updatePanelGroupSelector() {
            const selectEl = document.getElementById('group-select-panel');
            if(!selectEl) return;
            const myGroups = globalAllGroupsData.filter(g => g.members.includes(userId));
            selectEl.innerHTML = `<option value="">-- Grup SeÃ§in --</option>` + myGroups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            selectEl.onchange = (e) => loadPanelForGroup(e.target.value);
        }
        async function loadPanelForGroup(groupId) {
            const editor = document.getElementById('panel-editor-area');
            if(!editor) return;
            editor.classList.toggle('hidden', !groupId || isGuest);
            if(!groupId) return;
            const docRef = doc(db, `artifacts/${projectId}/public/data/panels`, groupId);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('panel-title').value = data.title || '';
                document.getElementById('panel-content').value = data.content || '';
                document.getElementById('panel-link').value = data.link || '';
            } else {
                document.getElementById('panel-title').value = '';
                document.getElementById('panel-content').value = '';
                document.getElementById('panel-link').value = '';
            }
        }
        window.saveProjectPanel = async () => {
            if(isGuest) return;
            const groupId = document.getElementById('group-select-panel').value;
            if(!groupId) return showMessage("LÃ¼tfen bir grup seÃ§in.", true);
            const title = document.getElementById('panel-title').value.trim();
            const content = document.getElementById('panel-content').value.trim();
            const link = document.getElementById('panel-link').value.trim();
            const group = globalAllGroupsData.find(g => g.id === groupId);
            try {
                const docRef = doc(db, `artifacts/${projectId}/public/data/panels`, groupId);
                await setDoc(docRef, {
                    groupId, title, content, link,
                    groupName: group?.name || 'Bilinmeyen Grup',
                    updatedAt: serverTimestamp(),
                    updatedBy: userName
                }, { merge: true });
                showMessage("Pano baÅŸarÄ±yla kaydedildi!", false);
            } catch(e) { console.error(e); showMessage("Pano kaydedilemedi.", true); }
        }
        function renderProjectGallery(panels) {
            const galleryEl = document.getElementById('project-gallery');
            if(!galleryEl) return;
            const heading = galleryEl.querySelector('h3');
            galleryEl.innerHTML = '';
            if(heading) galleryEl.appendChild(heading);
            if(panels.length === 0) { galleryEl.innerHTML += `<p class="text-gray-500 text-center py-8">HenÃ¼z proje panosu yok.</p>`; return; }
            panels.forEach(panel => {
                const dateStr = panel.updatedAt?.toDate().toLocaleString('tr-TR') || '';
                const card = document.createElement('div');
                card.className = "p-4 bg-white rounded-xl shadow-md project-card";
                card.innerHTML = `
                    <h4 class="font-bold text-lg text-accent-blue">${panel.title || 'BaÅŸlÄ±ksÄ±z Pano'}</h4>
                    <p class="text-sm font-semibold text-gray-600 mb-2">${panel.groupName}</p>
                    <p class="text-gray-700 my-2">${panel.content || 'Ä°Ã§erik yok.'}</p>
                    ${panel.link ? `<a href="${panel.link}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline text-sm font-medium">Proje Linki</a>` : ''}
                    <p class="text-xs text-gray-500 text-right mt-2">Son GÃ¼ncelleme: ${panel.updatedBy} - ${dateStr}</p>
                `;
                galleryEl.appendChild(card);
            });
        }
        
        // --- LAB TAB ---
        function updateLabGroupSelector() {
            const selectEl = document.getElementById('group-select-lab');
            if(!selectEl) return;
            const myGroups = globalAllGroupsData.filter(g => g.members.includes(userId));
            selectEl.innerHTML = `<option value="">-- Grup SeÃ§in --</option>` + myGroups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            selectEl.onchange = (e) => listenToLabData(e.target.value);
        }
        function listenToLabData(groupId) {
            const inputArea = document.getElementById('lab-input-area');
            const resultsList = document.getElementById('lab-records-list');
            if(!inputArea || !resultsList) return;
            inputArea.classList.toggle('hidden', !groupId || isGuest);
            if(listeners.lab) listeners.lab();
            if(!groupId) { resultsList.innerHTML = `<p class="text-gray-500 text-center py-8">Verileri gÃ¶rmek iÃ§in bir grup seÃ§in.</p>`; return; }
            const q = query(collection(db, `artifacts/${projectId}/public/data/lab_records`), where("groupId", "==", groupId), orderBy("createdAt", "desc"));
            listeners.lab = onSnapshot(q, (snapshot) => renderContributionResults(snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}))));
        }
        window.calculateBlueContribution = async () => {
            if(isGuest) return;
            const groupId = document.getElementById('group-select-lab').value;
            if(!groupId) return showMessage("LÃ¼tfen bir grup seÃ§in.", true);
            const labName = document.getElementById('lab-name').value.trim();
            const saved = parseFloat(document.getElementById('lab-value').value);
            const baseline = parseFloat(document.getElementById('lab-baseline').value);
            if(!labName || isNaN(saved) || isNaN(baseline) || baseline === 0) return showMessage("LÃ¼tfen tÃ¼m alanlarÄ± geÃ§erli sayÄ±larla doldurun (Temel TÃ¼ketim 0 olamaz).", true);
            const contribution = (saved / baseline) * 100;
            try {
                await setDoc(doc(collection(db, `artifacts/${projectId}/public/data/lab_records`)), {
                    groupId, labName, saved, baseline, contribution,
                    authorId: userId, authorName: userName, createdAt: serverTimestamp()
                });
                showMessage(`KatkÄ± hesaplandÄ±: %${contribution.toFixed(2)}. SonuÃ§ kaydedildi!`, false);
                document.getElementById('lab-name').value = '';
                document.getElementById('lab-value').value = '';
                document.getElementById('lab-baseline').value = '';
            } catch(e) { console.error(e); showMessage("SonuÃ§ kaydedilemedi.", true); }
        }
        function renderContributionResults(records) {
            const listEl = document.getElementById('lab-records-list');
            if(!listEl) return;
            if(records.length === 0) { listEl.innerHTML = `<p class="text-gray-500 text-center py-8">Bu grup iÃ§in henÃ¼z LAB verisi girilmemiÅŸ.</p>`; return; }
            listEl.innerHTML = '';
            let totalContribution = 0;
            records.forEach(rec => {
                totalContribution += rec.contribution;
                const dateStr = rec.createdAt?.toDate().toLocaleString('tr-TR') || '';
                const card = document.createElement('div');
                card.className = "p-3 bg-white rounded-lg shadow-md";
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-md text-gray-800">${rec.labName}</p>
                            <p class="text-sm text-gray-600">KatkÄ± PuanÄ±: <span class="font-bold text-lg text-green-600">%${rec.contribution.toFixed(2)}</span></p>
                            <p class="text-xs text-gray-500 mt-1">(Tasarruf: ${rec.saved}L / Temel: ${rec.baseline}L)</p>
                        </div>
                        ${!isGuest && rec.authorId === userId ? `<button onclick="deleteLabRecord('${rec.id}')" class="text-xs bg-red-100 text-red-700 font-semibold py-1 px-2 rounded-lg hover:bg-red-200">Sil</button>` : ''}
                    </div>
                    <p class="text-xs text-gray-500 text-right mt-2">Giren: ${rec.authorName} - ${dateStr}</p>
                `;
                listEl.appendChild(card);
            });
        }
        window.deleteLabRecord = async (id) => {
            if(isGuest || !confirm("Bu kaydÄ± silmek istediÄŸinizden emin misiniz?")) return;
            await deleteDoc(doc(db, `artifacts/${projectId}/public/data/lab_records`, id));
        };

        // --- MODULE TAB ---
        function updateKitGroupSelector() {
            const selectEl = document.getElementById('group-select-kit');
            if(!selectEl) return;
            const myGroups = globalAllGroupsData.filter(g => g.members.includes(userId));
            selectEl.innerHTML = `<option value="">-- Grup SeÃ§in --</option>` + myGroups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            selectEl.onchange = (e) => listenToSavedKits(e.target.value);
        }
        function listenToSavedKits(groupId) {
            const selectEl = document.getElementById('saved-kits-select');
            if(!selectEl) return;
            if(listeners.kits) listeners.kits();
            if(!groupId) { selectEl.innerHTML = `<option value="">-- KayÄ±tlÄ± Kitler --</option>`; return; }
            const q = query(collection(db, `artifacts/${projectId}/public/data/kits`), where("groupId", "==", groupId));
            listeners.kits = onSnapshot(q, (snapshot) => {
                selectEl.innerHTML = `<option value="">-- KayÄ±tlÄ± Kitler --</option>` + snapshot.docs.map(doc => `<option value="${doc.id}">${doc.data().kitName}</option>`).join('');
            });
        }
        window.createCustomModule = async () => {
            if(isGuest) return;
            const name = document.getElementById('custom-module-name').value.trim();
            const type = document.getElementById('custom-module-type').value;
            if(!name) return showMessage("ModÃ¼l adÄ± boÅŸ olamaz.", true);
            try {
                await setDoc(doc(collection(db, `artifacts/${projectId}/public/data/custom_modules`)), { name, type, createdBy: userId });
                document.getElementById('custom-module-name').value = '';
                showMessage("Ã–zel modÃ¼l eklendi!", false);
            } catch(e) { console.error(e); showMessage("ModÃ¼l eklenemedi.", true); }
        }
        function renderCustomModules(modules) {
            const palette = document.getElementById('module-palette');
            if(!palette) return;
            palette.querySelectorAll('.custom-module').forEach(el => el.remove()); // Eskileri temizle
            modules.forEach(module => {
                const moduleEl = document.createElement('div');
                moduleEl.className = 'module custom-module bg-blue-100 text-blue-800 p-2 rounded-lg shadow-md text-xs font-semibold border border-blue-300';
                moduleEl.draggable = true;
                moduleEl.dataset.type = module.type;
                moduleEl.dataset.name = module.name;
                moduleEl.textContent = module.name;
                palette.appendChild(moduleEl);
            });
            setupDragAndDrop();
        }
        function setupDragAndDrop() {
            const canvas = document.getElementById('kit-canvas');
            if(!canvas) return;
            document.querySelectorAll('#module-palette .module').forEach(module => {
                module.ondragstart = (e) => {
                    e.dataTransfer.setData('text/plain', JSON.stringify({ name: module.dataset.name, type: module.dataset.type, text: module.textContent }));
                };
            });
            canvas.ondragover = (e) => e.preventDefault();
            canvas.ondrop = (e) => {
                e.preventDefault();
                const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                const placeholder = canvas.querySelector('p');
                if(placeholder) placeholder.style.display = 'none';
                const newModule = document.createElement('div');
                newModule.className = 'module absolute bg-white text-gray-700 p-2 rounded-lg shadow-lg text-xs font-semibold';
                newModule.textContent = data.text;
                newModule.dataset.name = data.name;
                newModule.dataset.type = data.type;
                const rect = canvas.getBoundingClientRect();
                let x = e.clientX - rect.left - 40, y = e.clientY - rect.top - 15;
                x = Math.max(0, Math.min(x, rect.width - 80)); 
                y = Math.max(0, Math.min(y, rect.height - 30));
                newModule.style.left = `${x}px`; newModule.style.top = `${y}px`;
                canvas.appendChild(newModule);
            };
        }
        window.clearKitCanvas = () => {
             document.getElementById('kit-canvas').innerHTML = `<p class="text-center text-gray-500 pt-16">ModÃ¼lleri Buraya SÃ¼rÃ¼kleyin</p>`;
        }
        window.saveKitCanvas = async () => {
            if(isGuest) return;
            const groupId = document.getElementById('group-select-kit').value;
            if(!groupId) return showMessage("LÃ¼tfen kiti kaydetmek iÃ§in bir grup seÃ§in.", true);
            const kitName = prompt("Kit iÃ§in bir isim girin:", "Yeni Deney Kiti");
            if(!kitName) return;
            const modules = [];
            document.querySelectorAll('#kit-canvas .module').forEach(m => {
                modules.push({ name: m.dataset.name, type: m.dataset.type, text: m.textContent, x: m.style.left, y: m.style.top });
            });
            if(modules.length === 0) return showMessage("Kaydetmek iÃ§in kanvas boÅŸ olamaz.", true);
            try {
                await setDoc(doc(collection(db, `artifacts/${projectId}/public/data/kits`)), {
                    groupId, kitName, modules, createdAt: serverTimestamp(), authorId: userId
                });
                showMessage("Kit baÅŸarÄ±yla kaydedildi!", false);
            } catch(e) { console.error(e); showMessage("Kit kaydedilemedi.", true); }
        }
        window.loadSavedKit = async () => {
            const kitId = document.getElementById('saved-kits-select').value;
            if(!kitId) return;
            const docRef = doc(db, `artifacts/${projectId}/public/data/kits`, kitId);
            const docSnap = await getDoc(docRef);
            if(docSnap.exists()) {
                const canvas = document.getElementById('kit-canvas');
                clearKitCanvas();
                const placeholder = canvas.querySelector('p');
                if(placeholder) placeholder.style.display = 'none';
                const kit = docSnap.data();
                kit.modules.forEach(m => {
                    const newModule = document.createElement('div');
                    newModule.className = 'module absolute bg-white text-gray-700 p-2 rounded-lg shadow-lg text-xs font-semibold';
                    newModule.textContent = m.text;
                    newModule.dataset.name = m.name;
                    newModule.dataset.type = m.type;
                    newModule.style.left = m.x;
                    newModule.style.top = m.y;
                    canvas.appendChild(newModule);
                });
            }
        }

        // --- DATA MANIPULATION (GROUPS) ---
        window.createGroup = async () => {
             if (isGuest || !userId) return showMessage("Bu Ã¶zellik iÃ§in kayÄ±tlÄ± Ã¼ye olmalÄ±sÄ±nÄ±z.", true);
             const name = document.getElementById('new-group-name').value.trim();
             if(!name) return showMessage("Grup adÄ± boÅŸ olamaz.", true);
             const focus = document.querySelector('input[name="economyFocus"]:checked').value;
             try {
                const newGroupRef = doc(collection(db, `artifacts/${projectId}/public/data/groups`));
                await setDoc(newGroupRef, {
                    name: name,
                    ownerId: userId,
                    members: [userId],
                    economyFocus: focus,
                    createdAt: serverTimestamp()
                });
                showMessage(`'${name}' grubu baÅŸarÄ±yla oluÅŸturuldu!`, false);
                document.getElementById('new-group-name').value = '';
             } catch(error) {
                console.error("Grup oluÅŸturma hatasÄ±:", error);
                showMessage("Grup oluÅŸturulamadÄ±.", true);
             }
        };
        window.joinGroup = async (groupId) => {
            if (isGuest || !userId) return;
            const groupRef = doc(db, `artifacts/${projectId}/public/data/groups`, groupId);
            await updateDoc(groupRef, { members: arrayUnion(userId) });
        };
        window.leaveGroup = async (groupId) => {
            if (isGuest || !userId) return;
            const groupRef = doc(db, `artifacts/${projectId}/public/data/groups`, groupId);
            await updateDoc(groupRef, { members: arrayRemove(userId) });
        };
        
        window.onload = () => {
             initializeAppAndAuth();
        };

    </script>
</body>
</html>


