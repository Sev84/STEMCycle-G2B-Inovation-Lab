<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STEMCycle G2B Lab Hub</title>
    <!-- Tailwind CSS Yüklemesi -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font Yüklemesi -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet (Harita) CSS Yüklemesi -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/SJPMeIegerwBLpT6A="
     crossorigin=""/>
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0f9ff;
        } 
        
        #app::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-image: url('https://www.transparenttextures.com/patterns/cubes.png');
            opacity: 0.1;
            z-index: -1;
            pointer-events: none;
        }
        
        .header-blue { background-color: #00796b; }
        .accent-blue { background-color: #00838f; }
        .accent-green { background-color: #4caf50; }
        .tab-active { border-bottom: 3px solid #00838f; color: #00838f; font-weight: 600; }
        .announcement-card { border-left: 4px solid #ffb300; }
        .project-card { border-top: 5px solid #00838f; }
        .lab-accent { background-color: #ffb300; }
        
        #user-map { height: 300px; width: 100%; border-radius: 12px; margin-bottom: 1.5rem; z-index: 5; }
        
        .module { cursor: grab; user-select: none; }
        .module:active { cursor: grabbing; }
        #kit-canvas { 
            min-height: 250px; 
            background-color: #e2e8f0; 
            border: 2px dashed #94a3b8;
            position: relative;
        }
        
        /* Harita ikonları için 'iframe' yerine divIcon kullanılır */
        .custom-div-icon { background-color: transparent !important; border: none !important; }
        
    </style>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
</head>
<body class="min-h-screen">

    <div id="app" class="flex flex-col min-h-screen">
        
        <!-- Hesap Oluşturma/Giriş Modalı -->
        <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h1 class="text-2xl font-bold mb-4 text-center text-accent-blue" data-i18n="welcome_title">HOŞ GELDİNİZ</h1>
                <div class="space-y-3 mb-6">
                    <h2 class="text-sm font-semibold text-gray-700" data-i18n="esep_students_title">Öğrenci Girişleri ve Kaynaklar:</h2>
                    <a href="https://school-education.ec.europa.eu/en/pupil-login" target="_blank" class="block p-3 bg-green-100 border border-green-300 rounded-lg hover:bg-green-200 transition">
                        <p class="font-bold text-green-700 text-sm" data-i18n="esep_login_btn">ESEP/eTwinning Öğrenci Girişi</p>
                    </a>
                    <a href="https://school-education.ec.europa.eu/en/" target="_blank" class="block p-3 bg-blue-100 border border-blue-300 rounded-lg hover:bg-blue-200 transition">
                        <p class="font-bold text-blue-700 text-sm" data-i18n="esep_platform_btn">ESEP Okul Eğitimi Platformu</p>
                    </a>
                </div>
                <h2 class="text-xl font-bold mb-4 text-center text-accent-blue border-t pt-4" data-i18n="hub_login_title">STEMCycle Hub Girişi</h2>
                <div id="register-ui">
                    <h3 class="font-bold text-sm mb-2 text-gray-700" data-i18n="new_register_title">Yeni Kayıt / Bilgi Güncelleme</h3>
                    <input type="text" id="user-name-input" placeholder="Adınız, Soyadınız" class="w-full p-2 border rounded-lg mb-3">
                    <input type="email" id="user-email-input" placeholder="E-posta (Opsiyonel)" class="w-full p-2 border rounded-lg mb-3">
                    <input type="text" id="user-school-input" placeholder="Okulunuz / Ülkeniz" class="w-full p-2 border rounded-lg mb-4">
                    <button onclick="registerUser()" class="w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700">Kayıt Ol / Güncelle</button>
                </div>
                <div id="login-ui" class="mt-4">
                    <h3 class="font-bold text-sm mb-2 text-gray-700 border-t pt-4" data-i18n="guest_login_title">Veya Misafir Olarak Devam Et</h3>
                    <button onclick="loginUser()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700">Misafir Girişi</button>
                </div>
                <!-- DÜZELTİLMİŞ LOGOLAR -->
                <div class="p-4 flex flex-wrap justify-center items-center space-x-4 mt-4 border-t">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjMwIiB2aWV3Qm94PSIwIDAgMTAwIDMwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGZpbGw9IiMwMDQ0OTQiIGQ9Ik0wIDIuNzQ2aDEuNzM4VjI3LjI1NEgwVjIuNzQ2ek0zLjI3IDIuNzQ2aDQuMDQ4YzIuODEgMCA0LjM2OC41MyA1LjY3NSAyLjE5NyAxLjMwNSAxLjY2NyAxLjk1OCAzLjg2NyAxLjk1OCA2LjYwMiAwIDIuNzM0LS42NTMgNC45MzQtMS45NTggNi42MDItMS4zMDcuMTY2Ny0yLjg2NSAyLjE5Ny01LjY3NSAyLjE5N0gzLjI3VjIuNzQ2Wm0xLjc0IDYuMDYydjcuMjNoMi4zMDhjMi4wMSAwIDIuOTI4LS44MjIgMi45MjgtMi43OTIgMC0yLjA1My0uOTE5LTIuNzUzLTIuNzgtMi43NTNINS4wMXpNMTUuODQ4IDIuNzQ2aDQuMDQ4YzIuODEgMCA0LjM2OC41MyA1LjY3NSAyLjE5NyAxLjMwNSAxLjY2NyAxLjk1OCAzLjg2NyAxLjk1OCA2LjYwMiAwIDIuNzM0LS42NTMgNC45MzQtMS45NTggNi42MDItMS4zMDcuMTY2Ny0yLjg2NSAyLjE5Ny01LjY3NSAyLjE5N0gxNS44NThWMi43NDZabTEuNzQgNi4wNjJ2Ny4yM2gyLjMwOGMyLjAxIDAgMi45MjgtLjgyMiAyLjkyOC0yLjc5MiAwLTIuMDUzLS45MTktMi43NTMtMi43OC0yLjc1M2gtMi4xNDhaTTI4LjQyNyAyLjM0N2MxLjQxMy0xLjM4IDIuOTctMi4wNyA0LjY3LTIuMDcgMS43OCAwIDMuMzguNjg1IDQuODEgMi4wNTcgMS40MzIgMS4zNzIgMi4xNDggMy4xNzcgMi4xNDggNS40MTUgMCAyLjE5Ny0uNzE2IDMuOTk3LTIuMTQ4IDUuNHMtMy4wMyAyLjEtNC44MSAyLjFjLTEuNyAwLTMuMjU3LS42OS00LjY3LTIuMDY5VjI3LjI1NGgtMS43MzhWMi43NDZoMS43Mzh2Ni44NTZaTTMzLjA5NyA5LjE5YzAgMS43NTguNTMgMy4xMTggMS41OTEgNC4wNzkgMS4wNi45NiAyLjMzOCAxLjQ0IDMuODQzIDEuNDQgMS41NDggMCAyLjg1MS0uNDggMy44ODYtMS40NCAxLjAzNS0uOTYgMS41NTMtMi4zMiAxLjU1My00LjA3OSAwLTEuNzE2LS41MTgtMy4wNjgtMS41NTMtNC4wNTktMS4wMzUtLjk5LTIuMzM4LTEuNDg1LTMuODg2LTEuNDg1LTEuNTA1IDAtMi43ODMuNDk1LTMuODQzIDEuNDg1LTEuMDYgMS0xLjU5MSAyLjM0My0xLjU5MSA0LjA1OVpNNTAuMTI3IDIuNzQ2aDMuMjE2bC0zLjAzIDkuMzE4LTUuNjU0LTkuMzE4aC0zLjU2M2w3LjIzIDExLjk0Ny43NDIgMS4yMzVoLTEuNjQxbC0xLjk3OS0zLjI2aC0uOTM4bC0uODk2IDEuNDI3IDIuMTEyIDMuNDkzaDMuMzIzbDYuOTI0LTExLjQwM2gxLjc2bC01LjUyIDkuMDg4IDQuMzY4IDcuMTY4aC0zLjMyMmwtMi44NzctNC43MTUtMS41MzEgMi41MmgxLjQ2N2wuODI4IDEuMzY4aC45NThsLjY3OCAxLjExNGgtNy45NjhsLjY3OC0xLjExNGguOTU4bC44MjgtMS4zNjhoMS40NjdMNDEuNiAyNy4yNTRsLTUuNzgtOS41MjVMODAuMDM0IDIuNzQ2aC0uNjU2bC01LjY1MyA5LjMxOEw2OC4wNDQgMi43NDZoLTMuMjE2bDQuNjkyIDcuNzYyIDQuNDUtNy43NjJoMy41NjNsLTcuMjMgMTEuOTQ3LS43NDIgMS4yMzVoMS42NDFsMS45OC0zLjI2aC45MzhsLjg5NiAxLjQyNy0yLjExMiAzLjQ5M2gtMy4zMjNMNTguMyAxNS44NGwtNi45MjQtMTEuNDAzaC0xLjc2bDUuNTIgOS4wODgtNC4zNjggNy4xNjhoMy4zMjJsMi44NzctNC43MTUgMS41MzIgMi41MmgtMS40NjdsLS44MjggMS4zNjhoLS45NThsLS42NzgtMS4xMTRoNy45NjhMNTkuMzU4IDI3LjI1NGw1Ljc4LTkuNTI1IDQuNjQ2IDcuNTI1aC42NTZaTTY5LjEyNyAyLjM0N2MxLjQxMy0xLjM4IDIuOTctMi4wNyA0LjY3LTIuMDcgMS43OCAwIDMuMzguNjg1IDQuODEgMi4wNTcgMS40MzIgMS4zNzIgMi4xNDggMy4xNzcgMi4xNDggNS40MTUgMCAyLjE5Ny0uNzE2IDMuOTk3LTIuMTQ4IDUuNHMtMy4wMyAyLjEtNC44MSAyLjFjLTEuNyAwLTMuMjU3LS42OS00LjY3LTIuMDY5VjI3LjI1NGgtMS43MzhWMi43NDZoMS43Mzh2Ni44NTZaTTczLjc5NyA5LjE5YzAgMS43NTguNTMgMy4xMTggMS41OTEgNC4wNzkgMS4wNi45NiAyLjMzOCAxLjQ0IDMuODQzIDEuNDQgMS41NDggMCAyLjg1MS0uNDggMy44ODYtMS40NCAxLjAzNS0uOTYgMS41NTMtMi4zMiAxLjU1My00LjA3OSAwLTEuNzE2LS41MTgtMy4wNjgtMS41NTMtNC4wNTktMS4wMzUtLjk5LTIuMzM4LTEuNDg1LTMuODg2LTEuNDg1LTEuNTA1IDAtMi43ODMuNDk1LTMuODQzIDEuNDg1LTEuMDYgMS0xLjU5MSAyLjM0My0xLjU5MSA0LjA1OVpNODQuMzQ2IDIuNzQ2aDEuNzM4VjIzLjQxNGMwIDEuMzc5LjM1NSAyLjQ1IDEuMDY2IDMuMjE2LjcxMS43NjYgMS42MTUgMS4xNSA'BmaWxsPSIjRkZEMTAwIiBkPSJNMzEuMTkyIDEyLjExMmwxLjQxNC0xLjQxMyAzLjU4NiAzLjU4NiAxLjQxNC0xLjQxNC0zLjU4Ni0zLjU4NiAxLjQxNC0xLjQxNC0zLjU4Ni0zLjU4NmEuOTk2Ljk5NiAwIDAgMC0xLjQxNCAwbC0xLjQxNCAxLjQxMyAzLjU4NiAzLjU4Ni0xLjQxNCAxLjQxMyAzLjU4NiAzLjU4NnoiLz48L3N2Zz4=" alt="eTwinning Logosu" class="h-6 opacity-80">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjMwIiB2aWV3Qm94PSIwIDAgMTAwIDMwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGZpbGw9IiMwMDkzZGEiIGQ9Ik0zMi4wMzIgMTIuMjk1SDIyLjk0bDMuOTc3IDMuOTc3di4wMDFoNS4xMTV2LTMuOTc4Wm0wIDUuMTJIMUMxLjgyNCAxLjEyIDIuODcyIDEuNTkgMy43MjggMi4zN2guMDJjLjk1Ny43OCAxLjU3IDEuODQgMi4xMDcgMy4xNTNsLjAwNS4wMTJjLjUzOCAxLjMxMy44MDYgMi43OC44MDYgNC40VjI3LjI1NWgtMS43MzhWMjMuNDE0Yy4wMDEtMS4zNzktLjM1NC0yLjQ1LTEuMDY1LTMuMjE2LS43MS0uNzY2LTEuNjE0LTEuMTUtMi43MDgtMS4xNUg4MC4zVjI3LjI1NGgtMS43MzhWOS45NmMwLTEuNzMzLjIyLTMuMjU3LjY1Ny00LjU3NC40MzYtMS4zMTcuOTk3LTIuNDI1IDEuNjgxLTMuMzI1IDEuMzU3LTEuNzU4IDMuMDc5LTIuNjM3IDUuMTY2LTIuNjM3IDEuOTk3IDAgMy42MzUuNzggNC45MTUgMi4zNHMxLjkxOSAzLjQ4MyAxLjkxOSA1Ljc3MnYxMi45MDFoLTEuNzM4di0xLjQ4NmMtMS4yNjYgMS4xOTUtMi43ODMgMS43OTMtNC41NSAxLjc5My0yLjEyIDAtMy45MS0uODctNS4zNzMtMi42MS0xLjQ2My0xLjc0LTEuNjY3LTMuNjQzLTEuNjY3LTUuNzA5IDAtMi4wNjYuMjA0LTMuOTczIDEuNjY3LTUuNzA5IDEuNDYzLTEuNzQgMy4yNTMtMi42MSA1LjM3My0yLjYxIDEuNzY3IDAgMy4yODMuNjAzIDQuNTUgMS43OTNWMTEuMTRjMC0yLjI4OS0uNjQzLTMuOTk3LTEuOTE5LTUuNzcyWk05NC4wMiAyLjM0N2MxLjQxMy0xLjM4IDIuOTctMi4wNyA0LjY3LTIuMDcgMS43OCAwIDMuMzguNjg1YyAxLjQzMiAxLjM3MiAyLjE0OCAzLjE3NyAyLjE0OCA1LjQxNSAwIDIuEzk3LS43MTYgMy45OTctMi4xNDggNS40cy0zLjAzIDIuMS00LjgxIDIuMWMtMS43IDAtMy4yNTctLjY5LTQuNjctMi4wNjlWMjcuMjU0aC0xLjczOFYyLjc0NmgxLjczOHY2Ljg1NlpNOTQuNjkgOS4xOWMwIDEuNzU4LjUzIDMuMTE4IDEuNTkxIDQuMDc5IDEuMDYuOTYgMi4zMzggMS40NCAzLjg0MyAxLjQ0IDEuNTQ4IDAgMi44NTEtLjQ4IDMuODg2LTEuNDQgMS4wMzUtLjk2IDEuNTUzLTIuMzIgMS41NTMtNC4wNzkgMC0xLjcxNi0uNTE4LTMuMDY4LTEuNTUzLTQuMDU5LTEuMDM1LTUuOTktMi4zMzgtMS40ODUtMy44ODYtMS40ODUtMS41MDUgMC0yLjc4My40OTUtMy44NDMgMS40ODUtMS4wNiAxLTEuNTkxIDIuMzQzLTEuNTkxIDQuMDU5WiIvPjxwYXRoIGZpbGw9IiMwMDkzZGEiIGQ9Ik0xOC40ODUgMTUuMDA4aDEuNDU2YTcuMDIgNy4wMiAwIDAgMCAzLjQ5OC0xLjA5NSA0LjQ4OSA0LjQ4OSAwIDAgMCAyLjQ1NC0zLjA4OCA0LjI4MiA0LjI4MiAwIDAgMC0xLjQ4OS00LjMzNCA1LjAxMiA1LjAxMiAwIDAgMC0zLjgxMS0xLjQ2OUgxOC40ODV2OS45ODYxWm0tMy4xNzcgOS4zMDVIMTUuMzA4VjMuOTY5aDUuMTc3YzEuNzYgMCAzLjMwNS4zNzkgNC43MzMgMS4xMzkgMS40MjcuNzU5IDIuNTcgMS44NzQgMy40MjggMy4zNDQgLjg1OCAxLjQ2OSAxLjI4NyAzLjE2IDEuMjg3IDUuMDc0IDAgMS42MTUtLjMyNSAzLjEyMy0uOTc0IDQuNTE4YTcuMDY5IDcuMDY5IDAgMCAxLTIuNjU3IDMuMTk4IDcuOTQxIDcuOTQxIDAgMCAxLTQgMS4zMDJINC4xMTRsMy4yMDggMy4yMDhoMy45ODd2LTguNDE1aC0zLjk4N2wtMy4yMDggMy4yMDhINC4xMTRsMy4yMDggMy4yMDh6TTIuNzU2IDE1LjAwOGgxLjQ1NmE3LjAyIDcuMDIgMCAwIDAgMy40OTgtMS4wOTUgNC40ODkgNC40ODkgMCAwIDAgMi40NTQtMy4wODggNC4yODIgNC4yODIgMCAwIDAtMS40ODktNC4zMzQgNS4wMTIgNS4wMTIgMCAwIDAtMy44MTEtMS40NjlIMi43NTZ2OS45ODYxWk0tLjQyIDI0LjMxM2gxNS43MjlWMy45NjloNS4xNzdjMS43NiAwIDMuMzA1LjM3OSA0LjczMyAxLjEzOSAxLjQyNy43NTkgMi41NyAxLjg3NCAzLjQyOCAzLjM0NCAuODU4IDEuNDY5IDEuMjg3IDMuMTYgMS4yODcgNS4wNzQgMCAxLjYxNS0uMzI1IDMuMTIzLS45NzQgNC41MThhNy4wNjkgNy4wNjkgMCAwIDEtMi42NTcgMy4xOTggNy45NDEgNy45NDEgMCAwIDEtNCAxLjMwMkgtLjQxOHoiLz48L3N2Zz4=" alt="CodeWeek Logosu" class="h-8 opacity-80">
                </div>
            </div>
        </div>

        <!-- Başlık ve Kullanıcı Bilgisi -->
        <header class="header-blue text-white p-4 shadow-lg sticky top-0 z-20">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <h1 class="text-base sm:text-xl font-bold flex items-center">
                        <svg class="w-6 h-6 mr-2 text-green-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9h-9m-9 0a9 9 0 019-9m-9 9h6m-9 9a9 9 0 019-9m-9 9a9 9 0 009 9m9-9a9 9 0 01-9 9m9-9h-9m-9 0a9 9 0 019-9m-9 9h6"></path></svg>
                        <span data-i18n="app_main_title">STEMCycle G2B Lab Hub</span>
                    </h1>
                    <!-- DÜZELTİLMİŞ LOGOLAR (BAŞLIK) -->
                    <span class="text-sm font-light italic ml-3 pl-3 border-l border-green-300 hidden sm:block">BluEcoInVET</span>
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjMwIiB2aWV3Qm94PSIwIDAgMTAwIDMwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGZpbGw9IiMwMDQ0OTQiIGQ9Ik0wIDIuNzQ2aDEuNzM4VjI3LjI1NEDgwVjIuNzQ2ek0zLjI3IDIuNzQ2aDQuMDQ4YzIuODEgMCA0LjM2OC41MyA1LjY3NSAyLjE5NyAxLjMwNSAxLjY2NyAxLjk1OCAzLjg2NyAxLjk1OCA2LjYwMiAwIDIuNzM0LS42NTMgNC45MzQtMS45NTggNi42MDItMS4zMDcuMTY2Ny0yLjg2NSAyLjE5Ny01LjY3NSAyLjE5N0gzLjI3VjIuNzQ2Wm0xLjc0IDYuMDYydjcuMjNoMi4zMDhjMi4wMSAwIDIuOTI4LS44MjIgMi45MjgtMi43OTIgMC0yLjA1My0uOTE5LTIuNzUzLTIuNzgtMi43NTNINS4wMXpNMTUuODQ4IDIuNzQ2aDQuMDQ4YzIuODEgMCA0LjM2OC41MyA1LjY3NSAyLjE5NyAxLjMwNSAxLjY2NyAxLjk1OCAzLjg2NyAxLjk1OCA2LjYwMiAwIDIuNzM0LS42NTMgNC45MzQtMS45NTggNi42MDItMS4zMDcuMTY2Ny0yLjg2NSAyLjE5Ny01LjY3NSAyLjE5N0gxNS44NThWMi43NDZabTEuNzQgNi4wNjJ2Ny4yM2gyLjMwOGMyLjAxIDAgMi45MjgtLjgyMiAyLjkyOC0yLjc5MiAwLTIuMDUzLS45MTktMi43NTMtMi43OC0yLjc1M2gtMi4xNDhaTTI4LjQyNyAyLjM0N2MxLjQxMy0xLjM4IDIuOTctMi4wNyA0LjY3LTIuMDcgMS43OCAwIDMuMzguNjg1IDQuODEgMi4wNTcgMS40MzIgMS4zNzIgMi4xNDggMy4xNzcgMi4xNDggNS40MTUgMCAyLjE5Ny0uNzE2IDMuOTk3LTIuMTQ4IDUuNHMtMy4wMyAyLjEtNC44MSAyLjFjLTEuNyAwLTMuMjU3LS42OS00LjY3LTIuMDY5VjI3LjI1NGgtMS43MzhWMi43NDZoMS43Mzh2Ni44NTZaTTMzLjA5NyA5LjE5YzAgMS43NTguNTMgMy4xMTggMS41OTEgNC4wNzkgMS4wNi45NiAyLjMzOCAxLjQ0IDMuODQzIDEuNDQgMS41NDggMCAyLjg1MS0uNDggMy44ODYtMS40NCAxLjAzNS0uOTYgMS41NTMtMi4zMiAxLjU1My00LjA3OSAwLTEuNzE2LS41MTgtMy4wNjgtMS41NTMtNC4wNTktMS4wMzUtLjk5LTIuMzM4LTEuNDg1LTMuODg2LTEuNDg1LTEuNTA1IDAtMi43ODMuNDk1LTMuODQzIDEuNDg1LTEuMDYgMS0xLjU5MSAyLjM0My0xLjU5MSA0LjA1OVpNNTAuMTI3IDIuNzQ2aDMuMjE2bC0zLjAzIDkuMzE4LTUuNjU0LTkuMzE4aC0zLjU2M2w3LjIzIDExLjk0Ny43NDIgMS4yMzVoLTEuNjQxbC0xLjk3OS0zLjI2aC0uOTM4bC0uODk2IDEuNDI3IDIuMTEyIDMuNDkzaDMuMzIzbDYuOTI0LTExLjQwM2gxLjc2bC01LjUyIDkuMDg4IDQuMzY4IDcuMTY4aC0zLjMyMmwtMi44NzctNC43MTUtMS41MzEgMi41MmgxLjQ2N2wuODI4IDEuMzY4aC45NThsLjY3OCAxLjExNGgtNy45NjhsLjY3OC0xLjExNGguOTU4bC44MjgtMS4zNjhoMS40NjdMNDEuNiAyNy4yNTRsLTUuNzgtOS41MjVMODAuMDM0IDIuNzQ2aC0uNjU2bC01LjY1MyA5LjMxOEw2OC4wNDQgMi43NDZoLTMuMjE2bDQuNjkyIDcuNzYyIDQuNDUtNy43NjJoMy41NjNsLTcuMjMgMTEuOTQ3LS43NDIgMS4yMzVoMS42NDFsMS45OC0zLjI2aC45MzhsLjg5NiAxLjQyNy0yLjExMiAzLjQ5M2gtMy4zMjNMNTguMyAxNS44NGwtNi45MjQtMTEuNDAzaC0xLjc2bDUuNTIgOS4wODgtNC4zNjggNy4xNjhoMy4zMjJsMi44NzctNC43MTUgMS41MzIgMi41MmgtMS40NjdsLS44MjggMS4zNjhoLS45NThsLS42NzgtMS4xMTRoNy45NjhMNTkuMzU4IDI3LjI1NGw1Ljc4LTkuNTI1IDQuNjQ2IDcuNTI1aC42NTZaTTY5LjEyNyAyLjM0N2MxLjQxMy0xLjM4IDIuOTctMi4wNyA0LjY3LTIuMDcgMS43OCAwIDMuMzguNjg1IDQuODEgMi4wNTcgMS40MzIgMS4zNzIgMi4xNDggMy4xNzcgMi4xNDggNS40MTUgMCAyLjE5Ny0uNzE2IDMuOTk3LTIuMTQ4IDUuNHMtMy4wMyAyLjEtNC44MSAyLjFjLTEuNyAwLTMuMjU3LS42OS00LjY3LTIuMDY5VjI3LjI1NGgtMS43MzhWMi43NDZoMS43Mzh2Ni44NTZaTTczLjc5NyA5LjE5YzAgMS43NTguNTMgMy4xMTggMS41OTEgNC4wNzkgMS4wNi45NiAyLjMzOCAxLjQ0IDMuODQzIDEuNDQgMS41NDggMCAyLjg1MS0uNDggMy44ODYtMS40NCAxLjAzNS0uOTYgMS41NTMtMi4zMiAxLjU1My00LjA3OSAwLTEuNzE2LS41MTgtMy4wNjgtMS41NTMtNC4wNTktMS4wMzUtLjk5LTIuMzM4LTEuNDg1LTMuODg2LTEuNDg1LTEuNTA1IDAtMi43ODMuNDk1LTMuODQzIDEuNDg1LTEuMDYgMS0xLjU5MSAyLjM0My0xLjU5MSA0LjA1OVpNODQuMzQ2IDIuNzQ2aDEuNzM4VjIzLjQxNGMwIDEuMzc5LjM1NSAyLjQ1IDEuMDY2IDMuMjE2LjcxMS43NjYgMS42MTUgMS4xNSIvPg0KPHBhdGggZmlsbD0iI0ZGRDEwMCIgZD0iTTMxLjE5MiAxMi4xMTJsMS40MTQtMS40MTMgMy41ODYgMy41ODYgMS40MTQtMS40MTQtMy41ODYtMy41ODYgMS40MTQtMS40MTQtMy41ODYtMy41ODZhLjk5Ni45OTYgMCAwIDAtMS40MTQgMGwtMS40MTQgMS40MTMgMy41ODYgMy41ODYtMS40MTQgMS40MTMgMy41ODYgMy41ODZ6Ii8+DQo8L3N2Zz4=" alt="eTwinning Logosu" class="h-5 ml-4 opacity-90 hidden sm:block">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjMwIiB2aWV3Qm94PSIwIDAgMTAwIDMwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGZpbGw9IiMwMDkzZGEiIGQ9Ik0zMi4wMzIgMTIuMjk1SDIyLjk0bDMuOTc3IDMuOTc3di4wMDFoNS4xMTV2LTMuOTc4Wm0wIDUuMTJIMUMxLjgyNCAxLjEyIDIuODcyIDEuNTkgMy43MjggMi4zN2guMDJjLjk1Ny43OCAxLjU3IDEuODQgMi4xMDcgMy4xNTNsLjAwNS4wMTJjLjUzOCAxLjMxMy44MDYgMi43OC44MDYgNC40VjI3LjI1NWgtMS43MzhWMjMuNDE0Yy4wMDEtMS4zNzktLjM1NC0yLjQ1LTEuMDY1LTMuMjE2LS43MS0uNzY2LTEuNjE0LTEuMTUtMi43MDgtMS4xNUg4MC4zVjI3LjI1NGgtMS43MzhWOS45NmMwLTEuNzMzLjIyLTMuMjU3LjY1Ny00LjU3NC40MzYtMS4zMTcuOTk3LTIuNDI1IDEuNjgxLTMuMzI1IDEuMzU3LTEuNzU4IDMuMDc5LTIuNjM3IDUuMTY2LTIuNjM3IDEuOTk3IDAgMy42MzUuNzggNC45MTUgMi4zNHMxLjkxOSAzLjQ4MyAxLjkxOSA1Ljc3MnYxMi45MDFoLTEuNzM4di0xLjQ4NmMtMS4yNjYgMS4xOTUtMi43ODMgMS43OTMtNC41NSAxLjc5My0yLjEyIDAtMy45MS0uODctNS4zNzMtMi42MS0xLjQ2My0xLjc0LTEuNjY3LTMuNjQzLTEuNjY3LTUuNzA5IDAtMi4wNjYuMjA0LTMuOTczIDEuNjY3LTUuNzA5IDEuNDYzLTEuNzQgMy4yNTMtMi42MSA1LjM3My0yLjYxIDEuNzY3IDAgMy4yODMuNjAzIDQuNTUgMS43OTNWMTEuMTRjMC0yLjI4OS0uNjQzLTMuOTk3LTEuOTE5LTUuNzcyWk05NC4wMiAyLjM0N2MxLjQxMy0xLjM4IDIuOTctMi4wNyA0LjY3LTIuMDcgMS43OCAwIDMuMzguNjg1YyAxLjQzMiAxLjM3MiAyLjE0OCAzLjE3NyAyLjE0OCA1LjQxNSAwIDIuEzk3LS43MTYgMy45OTctMi4xNDggNS40cy0zLjAzIDIuMS00LjgxIDIuMWMtMS43IDAtMy4yNTctLjY5LTQuNjctMi4wNjlWMjcuMjU0aC0xLjczOFYyLjc0NmgxLjczOHY2Ljg1NlpNOTQuNjkgOS4xOWMwIDEuNzU4LjUzIDMuMTE4IDEuNTkxIDQuMDc5IDEuMDYuOTYgMi4zMzggMS40NCAzLjg0MyAxLjQ0IDEuNTQ4IDAgMi44NTEtLjQ4IDMuODg2LTEuNDQgMS4wMzUtLjk2IDEuNTUzLTIuMzIgMS41NTMtNC4wNzkgMC0xLjcxNi0uNTE4LTMuMDY4LTEuNTUzLTQuMDU5LTEuMDM1LTUuOTktMi4zMzgtMS40ODUtMy44ODYtMS40ODUtMS41MDUgMC0yLjc4My40OTUtMy44NDMgMS40ODUtMS4wNiAxLTEuNTkxIDIuMzQzLTEuNTkxIDQuMDU5WiIvPjxwYXRoIGZpbGw9IiMwMDkzZGEiIGQ9Ik0xOC40ODUgMTUuMDA4aDEuNDU2YTcuMDIgNy4wMiAwIDAgMCAzLjQ5OC0xLjA5NSA0LjQ4OSA0LjQ4OSAwIDAgMCAyLjQ1NC0zLjA4OCA0LjI4MiA0LjI4MiAwIDAgMC0xLjQ4OS00LjMzNCA1LjAxMiA1LjAxMiAwIDAgMC0zLjgxMS0xLjQ2OUgxOC40ODV2OS45ODYxWm0tMy4xNzcgOS4zMDVIMTUuMzA4VjMuOTY5aDUuMTc3YzEuNzYgMCAzLjMwNS4zNzkgNC43MzMgMS4xMzkgMS40MjcuNzU5IDIuNTcgMS44NzQgMy40MjggMy4zNDQgLjg1OCAxLjQ2OSAxLjI4NyAzLjE2IDEuMjg3IDUuMDc0IDAgMS42MTUtLjMyNSAzLjEyMy0uOTc0IDQuNTE4YTcuMDY5IDcuMDY5IDAgMCAxLTIuNjU3IDMuMTk4IDcuOTQxIDcuOTQxIDAgMCAxLTQgMS4zMDJINC4xMTRsMy4yMDggMy4yMDhoMy45ODd2LTguNDE1aC0zLjk4N2wtMy4yMDggMy4yMDhINC4xMTRsMy4yMDggMy4yMDh6TTIuNzU2IDE1LjAwOGgxLjQ1NmE3LjAyIDcuMDIgMCAwIDAgMy40OTgtMS4wOTUgNC40ODkgNC40ODkgMCAwIDAgMi40NTQtMy4wODggNC4yODIgNC4yODIgMCAwIDAtMS40ODktNC4zMzQgNS4wMTIgNS4wMTIgMCAwIDAtMy44MTEtMS40NjlIMi43NTZ2OS45ODYxWk0tLjQyIDI0LjMxM2gxNS43MjlWMy45NjloNS4xNzdjMS43NiAwIDMuMzA1LjM3OSA0LjczMyAxLjEzOSAxLjQyNy43NTkgMi41NyAxLjg3NCAzLjQyOCAzLjM0NCAuODU4IDEuNDY5IDEuMjg3IDMuMTYgMS4yODcgNS4wNzQgMCAxLjYxNS0uMzI1IDMuMTIzLS45NzQgNC41MThhNy4wNjkgNy4wNjkgMCAwIDEtMi42NTcgMy4xOTggNy45NDEgNy45NDEgMCAwIDEtNCAxLjMwMkgtLjQxOHoiLz48L3N2Zz4=" alt="CodeWeek Logosu" class="h-6 ml-3 opacity-90 hidden sm:block">
                </div>
                <div class="flex items-center space-x-4"><select id="language-select" class="bg-white text-gray-800 text-xs font-semibold p-1 rounded-md cursor-pointer" onchange="changeLanguage(this.value)"><option value="tr">TR</option><option value="en">EN</option></select><div class="text-sm"><p id="user-info" class="font-semibold text-right truncate"></p><p id="user-location" class="text-xs opacity-70 truncate"></p></div></div>
            </div>
        </header>

        <!-- Sekmeler -->
        <nav class="bg-white shadow-md p-2 flex justify-around text-gray-600 sticky top-[68px] z-20 overflow-x-auto whitespace-nowrap">
            <button id="tab-groups" onclick="changeTab('groups')" class="px-2 py-2 text-xs sm:text-sm flex-shrink-0 tab-active" data-i18n="tab_groups">Gruplar</button>
            <button id="tab-files" onclick="changeTab('files')" class="px-2 py-2 text-xs sm:text-sm flex-shrink-0" data-i18n="tab_files">Dosyalar</button>
            <button id="tab-announcements" onclick="changeTab('announcements')" class="px-2 py-2 text-xs sm:text-sm flex-shrink-0" data-i18n="tab_announcements">Duyurular</button>
            <button id="tab-gallery" onclick="changeTab('gallery')" class="px-2 py-2 text-xs sm:text-sm flex-shrink-0" data-i18n="tab_boards">Panolar</button>
            <button id="tab-lab" onclick="changeTab('lab')" class="px-2 py-2 text-xs sm:text-sm flex-shrink-0" data-i18n="tab_lab_data">LAB Veri</button>
            <!-- MODÜL SEKMESİ GERİ EKLENDİ -->
            <button id="tab-module" onclick="changeTab('module')" class="px-2 py-2 text-xs sm:text-sm flex-shrink-0" data-i18n="tab_module">
                <svg class="w-5 h-5 inline-block sm:mr-1 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 10-4 0v1a2 2 0 004 0V4zM19 4a2 2 0 10-4 0v1a2 2 0 004 0V4zM7 20h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v11a2 2 0 002 2z"></path></svg>
                Modül
            </button>
        </nav>

        <!-- Ana İçerik Alanı -->
        <main class="flex-grow p-4 space-y-6 z-10 relative">
            <section id="groups-view" class="tab-content"><div class="bg-white p-4 rounded-xl shadow-lg mb-6"><h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2" data-i18n="map_title">Etki Haritası</h2><div id="user-map"></div></div><div class="bg-white p-4 rounded-xl shadow-lg mb-6"><h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2" data-i18n="create_join_group_title">Grup Oluştur / Katıl</h2><input type="text" id="new-group-name" placeholder="Yeni Grup Adı" class="w-full p-2 border rounded-lg mb-3"><div class="mb-4"><label class="block text-sm font-medium" data-i18n="project_focus_label">Odak:</label><div class="flex space-x-4"><label><input type="radio" name="economyFocus" value="Mavi" checked> <span data-i18n="focus_blue">Mavi Ekonomi</span></label><label><input type="radio" name="economyFocus" value="Yeşil"> <span data-i18n="focus_green">Yeşil Ekonomi</span></label></div></div><button onclick="createGroup()" class="w-full accent-blue bg-blue-600 text-white py-2 rounded-lg font-semibold" data-i18n="create_group_btn">Grup Oluştur</button></div><div id="all-groups-list" class="space-y-4 mb-8"><h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2" data-i18n="all_groups_title">Tüm Gruplar</h2></div><div class="bg-white p-4 rounded-xl shadow-lg"><h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2" data-i18n="active_users_title">Aktif Kullanıcılar</h2><div id="all-users-list" class="space-y-2 max-h-64 overflow-y-auto"></div></div></section>
            <section id="files-view" class="tab-content hidden"><div class="bg-white p-4 rounded-xl shadow-lg"><h2 class="text-xl font-bold text-gray-800 mb-4" data-i18n="file_share_title">Dosya Paylaşımı</h2><select id="group-select-files" class="w-full p-2 border rounded-lg mb-4"></select><div id="file-upload-area" class="hidden"><input type="file" id="file-input" class="w-full p-2 border rounded-lg mb-3"><input type="text" id="file-description" placeholder="Açıklama" class="w-full p-2 border rounded-lg mb-3"><button onclick="uploadFile()" class="w-full accent-blue bg-blue-600 text-white py-2 rounded-lg font-semibold" data-i18n="upload_file_link_btn">Yükle</button></div></div><div id="group-files-list" class="mt-6 space-y-4"><h3 class="text-xl font-bold text-gray-800 border-b pb-2" data-i18n="selected_group_files">Grubun Dosyaları</h3></div></section>
            <section id="announcements-view" class="tab-content hidden"><div class="bg-white p-4 rounded-xl shadow-lg mb-6"><h2 class="text-xl font-bold text-gray-800 mb-4" data-i18n="publish_announcement_title">Yeni Duyuru</h2><input type="text" id="announcement-title" placeholder="Başlık" class="w-full p-2 border rounded-lg mb-3"><textarea id="announcement-content" placeholder="İçerik" rows="3" class="w-full p-2 border rounded-lg mb-3"></textarea><button onclick="publishAnnouncement()" class="w-full lab-accent bg-yellow-500 text-white py-2 rounded-lg font-semibold" data-i18n="publish_btn">Yayınla</button></div><div id="announcements-list" class="space-y-4"><h3 class="text-xl font-bold text-gray-800 border-b pb-2" data-i18n="all_announcements_title">Tüm Duyurular</h3></div></section>
            <section id="gallery-view" class="tab-content hidden"><div class="bg-white p-4 rounded-xl shadow-lg"><h2 class="text-xl font-bold text-gray-800 mb-4" data-i18n="project_board_title">Proje Panosu</h2><select id="group-select-panel" class="w-full p-2 border rounded-lg mb-4"></select><div id="panel-editor-area" class="hidden"><input type="text" id="panel-title" placeholder="Pano Başlığı" class="w-full p-2 border rounded-lg mb-3"><textarea id="panel-content" placeholder="Pano İçeriği" rows="5" class="w-full p-2 border rounded-lg mb-3"></textarea><input type="url" id="panel-link" placeholder="Proje Linki (opsiyonel)" class="w-full p-2 border rounded-lg mb-3"><button onclick="saveProjectPanel()" class="w-full accent-green bg-green-600 text-white py-2 rounded-lg font-semibold" data-i18n="save_board_btn">Kaydet</button></div></div><div id="project-gallery" class="mt-6 space-y-4"><h3 class="text-xl font-bold text-gray-800 border-b pb-2" data-i18n="innovation_gallery_title">İnovasyon Galerisi</h3></div></section>
            <section id="lab-view" class="tab-content hidden"><div class="bg-white p-4 rounded-xl shadow-lg"><h2 class="text-xl font-bold text-gray-800 mb-4" data-i18n="lab_results_title">LAB Sonuçları</h2><select id="group-select-lab" class="w-full p-2 border rounded-lg mb-4"></select><div id="lab-input-area" class="hidden"><input type="text" id="lab-name" placeholder="Deney Adı" class="w-full p-2 border rounded-lg mb-3"><input type="number" id="lab-value" placeholder="Tasarruf (Litre/Ay)" class="w-full p-2 border rounded-lg mb-3"><input type="number" id="lab-baseline" placeholder="Temel Tüketim (Litre/Ay)" class="w-full p-2 border rounded-lg mb-3"><button onclick="calculateBlueContribution()" class="w-full lab-accent bg-yellow-500 text-white py-2 rounded-lg font-semibold" data-i18n="calculate_save_btn">Kaydet</button></div></div><div id="contribution-results" class="mt-6 space-y-4"><h3 class="text-xl font-bold text-gray-800 border-b pb-2" data-i18n="group_contribution_score_title">Grup Katkı Puanı</h3><div id="current-contribution-card" class="p-4 bg-white rounded-xl shadow-md"></div><div id="lab-records-list" class="space-y-3"></div></div></section>
            
            <!-- MODÜL SEKMESİ İÇERİĞİ GERİ EKLENDİ -->
            <section id="module-view" class="tab-content hidden">
                <div class="bg-white p-4 rounded-xl shadow-lg mb-6 border-l-4 border-orange-500">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center border-b pb-2" data-i18n="module_dev_title">
                        <svg class="w-6 h-6 mr-2 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 10-4 0v1a2 2 0 004 0V4zM19 4a2 2 0 10-4 0v1a2 2 0 004 0V4zM7 20h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v11a2 2 0 002 2z"></path></svg>
                        Sanal Modül Geliştirme (Drag & Drop Kit)
                    </h2>
                    <p class="text-sm text-gray-600 mb-4" data-i18n="module_dev_desc">Modülleri sürükleyip, Sanal Kit Alanına bırakarak deney düzeneklerinizi inşa edin.</p>
                    <div id="module-palette" class="flex flex-wrap gap-3 p-3 bg-gray-100 rounded-lg mb-4">
                        <div class="module bg-white text-gray-700 p-2 rounded-lg shadow-md text-xs font-semibold" draggable="true" data-type="sensor" data-name="pH_Sensor" data-i18n="module_ph_sensor">pH Sensör</div>
                        <div class="module bg-white text-gray-700 p-2 rounded-lg shadow-md text-xs font-semibold" draggable="true" data-type="actuator" data-name="Pump" data-i18n="module_water_pump">Su Pompası</div>
                        <div class="module bg-white text-gray-700 p-2 rounded-lg shadow-md text-xs font-semibold" draggable="true" data-type="input" data-name="Rain_Collector" data-i18n="module_rain_collector">Yağmur Toplayıcı</div>
                        <div class="module bg-white text-gray-700 p-2 rounded-lg shadow-md text-xs font-semibold" draggable="true" data-type="control" data-name="Microcontroller" data-i18n="module_microcontroller">Kontrolcü (IoT)</div>
                        <div class="module bg-white text-gray-700 p-2 rounded-lg shadow-md text-xs font-semibold" draggable="true" data-type="storage" data-name="Greywater_Tank" data-i18n="module_greywater_tank">Gri Su Tankı</div>
                    </div>
                    <h3 class="text-md font-semibold text-gray-700 mb-2" data-i18n="virtual_kit_area">Sanal Kit İnşa Alanı</h3>
                    <div id="kit-canvas" class="rounded-lg shadow-inner relative">
                        <p class="text-center text-gray-500 pt-16" data-i18n="drag_modules_here">Modülleri Buraya Sürükleyin</p>
                    </div>
                    <button onclick="clearKitCanvas()" class="w-full mt-4 bg-red-500 text-white py-2 rounded-lg font-semibold hover:bg-red-600" data-i18n="clear_canvas_btn">Kanvası Temizle</button>
                </div>
            </section>
        </main>
        
        <footer class="bg-gray-100 p-3 text-xs text-gray-600 text-center mt-auto z-10 relative"><p data-i18n="project_desc">Bu platform, su okuryazarlığı ile yeşil ve mavi ekonomi arasındaki ilişkiyi göstermeyi amaçlar.</p></footer>
    </div>

    <div id="message-box" class="fixed bottom-4 right-4 bg-red-500 text-white p-3 rounded-lg shadow-xl hidden z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, where, arrayUnion, arrayRemove, deleteDoc, updateDoc, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        const translations = { /* ... Çeviri metinleri ... */ };
        let app, db, auth, storage;
        let userId = null, userName = '', userSchool = '', userEmail = '', isGuest = true;
        let userLat = null, userLon = null;
        let userGroups = [], allUserMetadata = [], groupMap = {};
        let userMap = null, mapMarkers = []; 
        let isMapInitialized = false;
        let filesListener, labDataListener;

        const firebaseConfig = {
            apiKey: "AIzaSyAshVa6zGftQmBQcjo_HRHoOP92vb3kKgQ",
            authDomain: "stemcycle-g2b-innovation-efe5c.firebaseapp.com",
            projectId: "stemcycle-g2b-innovation-efe5c",
            storageBucket: "stemcycle-g2b-innovation-efe5c.appspot.com",
            appId: "1:79339752913:web:5379abf2794791b7bda4f0"
        };
        
        function showMessage(message, isError = false) {
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.className = `fixed bottom-4 right-4 p-3 rounded-lg shadow-xl z-50 ${isError ? 'bg-red-500' : 'bg-green-500'} text-white opacity-100`;
            setTimeout(() => { box.classList.add('hidden'); }, 3000);
        }
        
        window.changeTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('tab-active'));
            document.getElementById(`${tabName}-view`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('tab-active');
            
            // DÜZELTME: Harita sadece görünür olduğunda ve
            // başlatıldığında yeniden boyutlandırılır.
            if (tabName === 'groups') {
                if (!isMapInitialized) {
                    initializeMap();
                } else {
                    // Harita zaten varsa, boyutunu tazele
                    setTimeout(() => { if (userMap) userMap.invalidateSize(); }, 100);
                }
            }
        }

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig); 
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);
                
                onAuthStateChanged(auth, (user) => {
                    if (user && user.uid !== userId) {
                        userId = user.uid;
                        setupRealtimeListeners();
                        getUserLocationAndMetadata();
                    }
                });
                if (!auth.currentUser) await signInAnonymously(auth);

            } catch (error) { console.error("Firebase Hatası:", error); }
        }

        // GİRİŞ EKRANI FONKSİYONLARI
        window.registerUser = () => {
            const name = document.getElementById('user-name-input').value.trim();
            const school = document.getElementById('user-school-input').value.trim();
            if (!name || !school) return showMessage("Ad ve okul alanları zorunludur.", true);
            
            localStorage.setItem('user_name', name);
            localStorage.setItem('user_school', school);
            localStorage.setItem('user_email', document.getElementById('user-email-input').value.trim());
            
            isGuest = false;
            document.getElementById('auth-modal').classList.add('hidden');
            if (!auth.currentUser) initializeFirebase();
            else getUserLocationAndMetadata();
        };

        window.loginUser = () => {
            localStorage.removeItem('user_name');
            localStorage.removeItem('user_school');
            localStorage.removeItem('user_email');
            sessionStorage.setItem('isGuest', 'true');
            isGuest = true;
            document.getElementById('auth-modal').classList.add('hidden');
            if (!auth.currentUser) initializeFirebase();
            else getUserLocationAndMetadata();
        };
        
        function getUserLocationAndMetadata() {
            if (isGuest) {
                userName = "Misafir";
                userSchool = "Görüntüleme";
                updateUserMetadata(false); // Konum almadan güncelle
            } else {
                userName = localStorage.getItem('user_name');
                userSchool = localStorage.getItem('user_school');
                userEmail = localStorage.getItem('user_email');

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(pos => {
                        userLat = pos.coords.latitude.toFixed(2);
                        userLon = pos.coords.longitude.toFixed(2);
                        updateUserMetadata(true);
                    }, () => {
                        userLat = 41.01; userLon = 28.97; // İstanbul
                        updateUserMetadata(true);
                    });
                } else {
                    userLat = 41.01; userLon = 28.97;
                    updateUserMetadata(true);
                }
            }
        }

        async function updateUserMetadata(hasLocation) {
            document.getElementById('user-info').textContent = `${userName} (${userSchool})`;
            if (hasLocation) {
                document.getElementById('user-location').textContent = `Konum: ${userLat}, ${userLon}`;
                if (!isGuest && userId) {
                     await setDoc(doc(db, `artifacts/${firebaseConfig.projectId}/public/data/user_metadata`, userId), 
                        { name: userName, school: userSchool, email: userEmail, lat: userLat, lon: userLon, lastLogin: new Date().toISOString() }, 
                        { merge: true }
                    );
                }
            }
        }

        function setupRealtimeListeners() {
            const projectId = firebaseConfig.projectId;
            onSnapshot(collection(db, `artifacts/${projectId}/public/data/groups`), 
                (snapshot) => updateAllUsersAndGroups(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))),
                (error) => console.error("Grup dinleme hatası:", error)
            );
            onSnapshot(collection(db, `artifacts/${projectId}/public/data/announcements`), 
                (snapshot) => renderAnnouncements(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))),
                (error) => console.error("Duyuru dinleme hatası:", error)
            );
            onSnapshot(collection(db, `artifacts/${projectId}/public/data/panels`), 
                (snapshot) => renderProjectGallery(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))),
                (error) => console.error("Pano dinleme hatası:", error)
            );
        }

        async function updateAllUsersAndGroups(groupsData) {
            const userSnapshot = await getDocs(collection(db, `artifacts/${firebaseConfig.projectId}/public/data/user_metadata`));
            allUserMetadata = userSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // DÜZELTME: groupMap harita için burada oluşturulur
            groupMap = {};
            groupsData.forEach(g => {
                g.members.forEach(memberId => {
                    if (!groupMap[memberId]) groupMap[memberId] = [];
                    groupMap[memberId].push(g);
                });
            });
            
            userGroups = groupsData.filter(g => g.members && g.members.includes(userId));

            renderAllUsers(); 
            renderAllGroups(groupsData); 
            renderUserMap(allUserMetadata); // Haritayı en son verilerle güncelle
            updateGroupSelectors(userGroups);
        }

        function initializeMap() {
            if (isMapInitialized || typeof L === 'undefined') return;
            try {
                userMap = L.map('user-map').setView([40, 35], 5);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(userMap);
                isMapInitialized = true;
                setTimeout(() => userMap.invalidateSize(), 100);
                renderUserMap(allUserMetadata);
            } catch (e) {
                console.error("Harita başlatılamadı:", e);
                isMapInitialized = false;
            }
        }

        // DÜZELTME: Harita ikonları, puan ve renkler
        function renderUserMap(users) {
            if (!isMapInitialized) return;
            mapMarkers.forEach(m => m.remove()); mapMarkers = [];
            
            users.forEach(user => {
                if (user.lat && user.lon) {
                    const userGroupsInfo = groupMap[user.id] || [];
                    const isBlue = userGroupsInfo.some(g => g.economyFocus === 'Mavi');
                    const isGreen = userGroupsInfo.some(g => g.economyFocus === 'Yeşil');
                    
                    let color = '#808080'; // Gri (grup yoksa)
                    if (isBlue && isGreen) color = '#ffb300'; // Turuncu (ikisi de)
                    else if (isBlue) color = '#00838f'; // Mavi
                    else if (isGreen) color = '#4caf50'; // Yeşil
                    
                    const markerHtmlStyles = `background-color: ${color}; width: 1.5rem; height: 1.5rem; display: block; left: -0.75rem; top: -0.75rem; position: relative; border-radius: 1.5rem 1.5rem 0; transform: rotate(45deg); border: 2px solid #FFF; box-shadow: 0 0 5px rgba(0,0,0,0.5);`;
                    const customIcon = L.divIcon({ className: "custom-div-icon", html: `<div style="${markerHtmlStyles}"></div>`, iconSize: [24, 24], iconAnchor: [12, 24] });
                    
                    const userScore = user.puan || 0; // Puan (varsayılan 0)
                    const popupContent = `<div class="font-bold">${user.name} (${user.school})</div><div class="text-sm font-semibold text-accent-blue">Puan: ${userScore}</div>`;
                    
                    const marker = L.marker([user.lat, user.lon], { icon: customIcon }).bindPopup(popupContent).addTo(userMap);
                    mapMarkers.push(marker);
                }
            });
        }
        
        // DÜZELTME: Aktif Kullanıcılar listesi
        function renderAllUsers() {
            const userListEl = document.getElementById('all-users-list');
            if (!userListEl) return;
            userListEl.innerHTML = '';
            
            const threeDaysAgo = new Date(Date.now() - 3 * 24 * 60 * 60 * 1000);
            allUserMetadata.sort((a, b) => new Date(b.lastLogin || 0) - new Date(a.lastLogin || 0));
            
            allUserMetadata.forEach(user => {
                const isCurrentUser = user.id === userId;
                const dateStr = user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Bilinmiyor';
                const isActive = user.lastLogin && new Date(user.lastLogin) > threeDaysAgo;
                
                let bgColor = 'bg-gray-50 border-gray-200';
                let textColor = 'text-gray-800';
                let statusText = '';
                
                if (isCurrentUser) {
                    bgColor = 'bg-blue-100 border-blue-400';
                    textColor = 'text-blue-800';
                    statusText = `<span class="text-xs font-normal text-red-500">(Siz)</span>`;
                } else if (isActive) {
                    bgColor = 'bg-green-100 border-green-400';
                    textColor = 'text-green-800';
                    statusText = `<span class="text-xs font-bold text-green-600 ml-1">(AKTİF)</span>`;
                }

                const userCard = document.createElement('div');
                userCard.className = `p-2 rounded-lg border ${bgColor}`;
                userCard.innerHTML = `<p class="font-semibold text-sm ${textColor}">${user.name} ${statusText}</p><p class="text-xs text-gray-600">${user.school} | Son Görülme: ${dateStr}</p>`;
                userListEl.appendChild(userCard);
            });
        }

        function renderAllGroups(groups) {
            const listEl = document.getElementById('all-groups-list');
            listEl.innerHTML = '';
            const userLookup = Object.fromEntries(allUserMetadata.map(u => [u.id, u.name]));

            groups.forEach(group => {
                const members = group.members || [];
                const isMember = members.includes(userId);
                const isOwner = group.ownerId === userId;
                
                const card = document.createElement('div');
                card.className = `bg-white p-4 rounded-xl shadow-md space-y-2 border-l-4 ${group.economyFocus === 'Yeşil' ? 'border-green-500' : 'border-blue-500'}`;
                card.innerHTML = `
                    <h3 class="font-bold text-lg">${group.name}</h3>
                    <p class="text-sm"><b>Odak:</b> ${group.economyFocus} Ekonomi</p>
                    <p class="text-sm"><b>Aşama:</b> ${group.stemCycleStatus}</p>
                    <div class="text-sm"><b>Üyeler (${members.length}):</b><ul class="list-disc pl-5">${members.map(id => `<li>${userLookup[id] || '...'}</li>`).join('')}</ul></div>
                    <div class="pt-2 border-t mt-2 flex space-x-4">
                        ${!isGuest ? (isMember ? `<button onclick="leaveGroup('${group.id}')" class="text-red-600 font-semibold">Ayrıl</button>` : `<button onclick="joinGroup('${group.id}')" class="text-green-600 font-semibold">Katıl</button>`) : ''}
                    </div>
                    ${isOwner ? renderStatusUpdateUI(group.id, group.stemCycleStatus) : ''}
                `;
                listEl.appendChild(card);
            });
        }
        
        function renderStatusUpdateUI(groupId, currentStatus) {
            const statuses = ["Başlangıç", "Tasarım", "Test", "Uygulama", "Sonuç"];
            const options = statuses.map(s => `<option value="${s}" ${s === currentStatus ? 'selected' : ''}>${s}</option>`).join('');
            return `<div class="mt-2 pt-2 border-t"><label class="text-xs font-bold">Aşamayı Güncelle:</label><div class="flex gap-2 mt-1"><select id="status-select-${groupId}" class="p-1 border rounded w-full">${options}</select><button onclick="updateGroupStatus('${groupId}')" class="px-3 bg-orange-500 text-white rounded">OK</button></div></div>`;
        }

        window.createGroup = async () => { if(isGuest) return showMessage("Grup oluşturmak için kayıt olmalısınız.", true); /* ... */ };
        window.joinGroup = async (groupId) => { if(isGuest) return showMessage("Gruba katılmak için kayıt olmalısınız.", true); /* ... */ };
        window.leaveGroup = async (groupId) => { /* ... */ };
        window.updateGroupStatus = async (groupId) => { /* ... */ };
        window.uploadFile = async () => { if(isGuest) return showMessage("Dosya yüklemek için kayıt olmalısınız.", true); /* ... */ };
        window.deleteFile = async (id, url) => { /* ... */ };
        function renderFiles(files) { /* ... */ };
        window.publishAnnouncement = async () => { if(isGuest) return showMessage("Duyuru için kayıt olmalısınız.", true); /* ... */ };
        window.deleteAnnouncement = async (id) => { /* ... */ };
        function renderAnnouncements(announcements) { /* ... */ };
        async function loadPanelForGroup(groupId) { /* ... */ };
        window.saveProjectPanel = async () => { if(isGuest) return showMessage("Pano için kayıt olmalısınız.", true); /* ... */ };
        function renderProjectGallery(panels) { /* ... */ };
        function listenToLabData(groupId) { /* ... */ };
        window.calculateBlueContribution = async () => { if(isGuest) return showMessage("Veri girmek için kayıt olmalısınız.", true); /* ... */ };
        function renderContributionResults(records) { /* ... */ };
        window.deleteLabRecord = async (recordId) => { /* ... */ };
        
        function updateGroupSelectors(groups) {
            const optionsHTML = `<option value="">-- Grup Seçin --</option>` + groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            const selects = {
                'group-select-files': (gid) => { document.getElementById('file-upload-area').classList.toggle('hidden', !gid || isGuest); displayGroupFiles(gid); },
                'group-select-panel': (gid) => { document.getElementById('panel-editor-area').classList.toggle('hidden', !gid || isGuest); loadPanelForGroup(gid); },
                'group-select-lab': (gid) => { document.getElementById('lab-input-area').classList.toggle('hidden', !gid || isGuest); listenToLabData(gid); },
            };
            for (const id in selects) {
                const el = document.getElementById(id);
                if (el) { el.innerHTML = optionsHTML; el.onchange = (e) => selects[id](e.target.value); }
            }
        }
        
        function displayGroupFiles(groupId) {
            if(filesListener) filesListener();
            if(!groupId) { document.getElementById('group-files-list').innerHTML = ''; return; }
            const q = query(collection(db, `artifacts/${firebaseConfig.projectId}/public/data/files`), where("groupId", "==", groupId));
            filesListener = onSnapshot(q, (snapshot) => renderFiles(snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}))));
        }

        // MODÜL JS FONKSİYONLARI
        function setupDragAndDrop() {
            const canvas = document.getElementById('kit-canvas');
            const palette = document.getElementById('module-palette');
            if (!canvas || !palette) return; 

            palette.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('module')) {
                    e.dataTransfer.setData('text/plain', JSON.stringify({ name: e.target.dataset.name, text: e.target.textContent }));
                }
            });
            canvas.addEventListener('dragover', (e) => e.preventDefault());
            canvas.addEventListener('drop', (e) => {
                e.preventDefault();
                try {
                    const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                    const placeholder = canvas.querySelector('p');
                    if(placeholder) placeholder.style.display = 'none';
                    const newModule = document.createElement('div');
                    newModule.className = 'module absolute bg-white text-gray-700 p-2 rounded-lg shadow-lg text-xs font-semibold';
                    newModule.textContent = data.text;
                    newModule.dataset.name = data.name;
                    const rect = canvas.getBoundingClientRect();
                    let x = e.clientX - rect.left - 40, y = e.clientY - rect.top - 15;
                    x = Math.max(0, Math.min(x, rect.width - 80)); 
                    y = Math.max(0, Math.min(y, rect.height - 30));
                    newModule.style.left = `${x}px`;
                    newModule.style.top = `${y}px`;
                    canvas.appendChild(newModule);
                } catch (err) { console.error("Drop hatası:", err); }
            });
        }

        window.clearKitCanvas = () => {
            const canvas = document.getElementById('kit-canvas');
            if (canvas && confirm('Kanvası temizlemek istediğinizden emin misiniz?')) {
                canvas.innerHTML = `<p class="text-center text-gray-500 pt-16" data-i18n="drag_modules_here">Modülleri Buraya Sürükleyin</p>`;
            }
        }

        // BAŞLANGIÇ
        window.onload = () => {
            if (localStorage.getItem('user_name')) {
                isGuest = false;
                initializeFirebase();
            } else if (sessionStorage.getItem('isGuest')) {
                isGuest = true;
                initializeFirebase();
            } else {
                 document.getElementById('auth-modal').classList.remove('hidden');
            }
            setupDragAndDrop(); // Modül sekmesi için JS'yi yükle
        };
    </script>
</body>
</html>


