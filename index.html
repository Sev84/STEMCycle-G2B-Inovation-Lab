<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>STEMCycle G2B Lab Hub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&amp;display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        /* CORE STYLES */
        body {
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            height: 100%;
            overflow-x: hidden;
        }
        
        html {
            height: 100%;
        }
        
        #app {
            position: relative;
            min-height: 100%;
            z-index: 10;
        }
        #app::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #e8f5e9 0%, #b2dfdb 50%, #80deea 100%);
            opacity: 0.4;
            z-index: -1;
            pointer-events: none;
        }
        
        .header-blue { background: linear-gradient(135deg, #00796b 0%, #00838f 100%); }
        .accent-blue { background-color: #00838f; }
        .accent-green { background-color: #4caf50; }
        .tab-active { border-bottom: 3px solid #00838f; color: #00838f; font-weight: 600; }
        .announcement-card { border-left: 4px solid #ffb300; background-color: white; }
        .project-card { border-top: 5px solid #00838f; background-color: white; }
        .lab-accent { background-color: #ffb300; }
        
        #user-map { height: 300px; width: 100%; border-radius: 12px; margin-bottom: 1.5rem; z-index: 5; }
        
        /* LAB MODULE STYLES */
        .module {
            cursor: grab;
            user-select: none;
            transition: transform 0.1s, box-shadow 0.2s;
            position: absolute;
        }
        .module:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .module:active { cursor: grabbing; transform: scale(1.05); }
        .module.dragging { opacity: 0.7; z-index: 1000; }
        
        #kit-canvas { 
            min-height: 350px; 
            background: linear-gradient(135deg, #e3f2fd 0%, #f1f8e9 100%);
            border: 2px dashed #94a3b8;
            position: relative;
            border-radius: 12px;
        }
        
        /* GENERAL UI & TOAST */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00838f 0%, #00796b 100%);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 131, 143, 0.4);
        }
        
        .btn-secondary {
            background-color: #4caf50;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #00838f;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* IoT Sensor Styles */
        .sensor-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .sensor-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .sensor-value {
            font-size: 2.5rem;
            font-weight: bold;
            line-height: 1;
        }
        
        .sensor-status-online {
            background-color: #4caf50;
            animation: pulse 2s infinite;
        }
        
        .sensor-status-offline {
            background-color: #f44336;
        }
        
        .sensor-status-warning {
            background-color: #ff9800;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .chart-container {
            height: 200px;
            position: relative;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .chart-line {
            stroke: #00838f;
            stroke-width: 2;
            fill: none;
        }
        
        .chart-area {
            fill: url(#gradient);
            opacity: 0.3;
        }
        
        .data-point {
            fill: #00838f;
            r: 3;
        }
        
        .alert-high { border-left: 4px solid #f44336; background-color: #ffebee; }
        .alert-low { border-left: 4px solid #2196f3; background-color: #e3f2fd; }
        .alert-normal { border-left: 4px solid #4caf50; background-color: #e8f5e9; }
        /* Community Styles */
        .community-project { border-left: 4px solid #4caf50; }
        .my-project { border-left: 4px solid #00838f; }
        .project-view-btn.active { ring: 2px; }

        /* GREEN CITY (YENI) STYLES */

        /* 1. Hareket Eden Bulutlar Animasyonu */
        @keyframes moveClouds {
            0% { transform: translateX(800px); }
            100% { transform: translateX(-400px); }
        }

        .moving-cloud {
            fill: #FFFFFF;
            opacity: 0.8;
            animation: moveClouds 60s linear infinite;
        }

        /* 2. Animasyonlu Yol √áizgileri */
        @keyframes dash {
            to { stroke-dashoffset: -100; }
        }
        .animated-road-line {
            stroke-dasharray: 10, 10;
            animation: dash 1s linear infinite;
        }

        /* 3. Parƒ±ldayan Izgara */
        @keyframes pulse-grid {
            0% { opacity: 0.3; }
            50% { opacity: 0.6; }
            100% { opacity: 0.3; }
        }
        .placement-grid {
            stroke: #4caf50;
            stroke-width: 1;
            stroke-dasharray: 5,5;
            animation: pulse-grid 4s ease-in-out infinite; 
        }

        /* 4. Sallanan Aƒüa√ßlar (Tree Swaying) */
        @keyframes sway {
            0% { transform: rotate(0deg); }
            50% { transform: rotate(-1deg); }
            100% { transform: rotate(0deg); }
        }
        .swaying-tree {
            transform-origin: 50% 50%;
            animation: sway 5s ease-in-out infinite;
        }

        /* 5. 3D Bina Efektleri (Hover ve G√∂lge) ve Pencere Detaylarƒ± */
        .city-building {
            transition: transform 0.3s, box-shadow 0.3s, background 0.5s;
            transform-style: preserve-3d;
            cursor: grab;
            position: absolute; /* √ñnemli: Dinamik olarak eklenen binalar i√ßin */
        }

        .city-building:hover {
            transform: translateZ(10px) translateY(-5px) scale(1.05); 
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3); 
            cursor: grabbing;
        }

        .city-building::after {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            background: repeating-linear-gradient(
                90deg,
                rgba(255, 255, 255, 0.1) 0px,
                rgba(255, 255, 255, 0.1) 2px,
                transparent 2px,
                transparent 6px
            );
            /* Basit Pencere Detaylarƒ± */
        }
        
        /* Bina Kategori Renk Ge√ßi≈üleri (Gradient) */
        .bg-green-500 { background: linear-gradient(to top, #4caf50 0%, #81c784 100%); } 
        .bg-blue-500 { background: linear-gradient(to top, #2196f3 0%, #64b5f6 100%); } 
        .bg-yellow-500 { background: linear-gradient(to top, #ffeb3b 0%, #fff176 100%); } 
        .bg-purple-500 { background: linear-gradient(to top, #9c27b0 0%, #ba68c8 100%); } 
        .bg-emerald-500 { background: linear-gradient(to top, #009688 0%, #4db6ac 100%); } 
        .bg-indigo-500 { background: linear-gradient(to top, #3f51b5 0%, #7986cb 100%); } 
        .bg-teal-500 { background: linear-gradient(to top, #00bcd4 0%, #4dd0e1 100%); } 
        .bg-cyan-500 { background: linear-gradient(to top, #00acc1 0%, #4dd0e1 100%); } 
        .bg-lime-500 { background: linear-gradient(to top, #cddc39 0%, #e6ee9c 100%); } 
        .bg-orange-500 { background: linear-gradient(to top, #ff9800 0%, #ffb74d 100%); } 
        .bg-pink-500 { background: linear-gradient(to top, #e91e63 0%, #f06292 100%); } 
        .bg-red-500 { background: linear-gradient(to top, #f44336 0%, #ef5350 100%); } 

        /* 6. Hareket Eden Ara√ßlar Animasyonu */
        @keyframes moveCar {
            0% { transform: translateX(800px); }
            100% { transform: translateX(-100px); }
        }
        .animated-car {
            animation: moveCar 10s linear infinite;
            position: absolute;
            z-index: 10;
        }

        /* 7. Dinamik G√ºne≈ü I≈üƒ±nlarƒ± */
        @keyframes spinRays {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #sun-rays {
            transform-origin: 700px 80px; /* G√ºne≈üin merkezi */
            animation: spinRays 60s linear infinite;
        }

    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body>
  <div id="app"><!-- Language Selection Modal -->
   <div id="language-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-60">
    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full mx-4 text-center">
     <div class="mb-6">
      <div class="text-6xl mb-4">
        üåç
      </div>
      <h2 class="text-2xl font-bold mb-2" style="color: #00796b;">Select Language / Dil Se√ßin</h2>
      <p class="text-gray-600">Choose your preferred language</p>
     </div>
     <div class="space-y-3"><button id="lang-en" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-4 rounded-lg transition-all transform hover:scale-105">  üá∫üá∏  English </button> <button id="lang-tr" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-4 rounded-lg transition-all transform hover:scale-105">  üáπüá∑  T√ºrk√ße </button>
     </div>
    </div>
   </div><!-- Auth Modal -->
   <div id="auth-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full mx-4 relative overflow-hidden"><!-- Animated Background -->
     <div class="absolute inset-0 bg-gradient-to-br from-blue-400 via-green-400 to-blue-600 opacity-10"></div>
     <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-green-400 to-blue-500"></div><!-- Music Control -->
     <div class="absolute top-4 right-4"><button id="music-toggle" class="bg-green-500 hover:bg-green-600 text-white p-2 rounded-full transition-all">  üéµ  </button>
     </div>
     <div class="relative z-10">
      <div class="text-center mb-6">
       <div class="text-6xl mb-4 animate-bounce">
         üß™
       </div>
       <h2 id="auth-title" class="text-3xl font-bold mb-2" style="color: #00796b;">Welcome to STEMCycle G2B</h2>
       <p id="auth-subtitle" class="text-gray-600">Your sustainable science laboratory awaits</p>
      </div>
      <form id="auth-form" class="space-y-4">
       <div><label for="username" id="username-label" class="block text-sm font-semibold mb-2 text-gray-700">Username</label> <input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="Enter your username">
       </div>
       <div><label for="location" id="location-label" class="block text-sm font-semibold mb-2 text-gray-700">Your Location (City)</label> <input type="text" id="location" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="e.g., Istanbul">
       </div>
       <div class="flex gap-3"><button type="submit" id="enter-btn" class="flex-1 btn-primary text-white font-semibold py-3 rounded-lg transform hover:scale-105 transition-all"> Enter Lab Hub </button> <button type="button" id="guest-btn" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 rounded-lg transform hover:scale-105 transition-all"> Guest Mode </button>
       </div>
      </form>
     </div>
    </div>
   </div><!-- Main App (Hidden Initially) -->
   <div id="main-app" class="hidden"><!-- Header -->
    <header class="header-blue text-white shadow-lg">
     <div class="container mx-auto px-4 py-6">
      <div class="flex justify-between items-center">
       <div>
        <h1 id="site-title" class="text-3xl font-bold">STEMCycle G2B Lab Hub</h1>
        <p id="welcome-message" class="text-sm opacity-90 mt-1">Welcome to your sustainable science lab</p>
       </div>
       <div class="text-right">
        <p class="font-semibold" id="user-display">User</p>
        <p class="text-sm opacity-90" id="location-display">Location</p>
       </div>
      </div>
     </div>
    </header><!-- Navigation Tabs -->
    <nav class="bg-white shadow-md sticky top-0 z-40">
     <div class="container mx-auto px-4">
      <div class="overflow-x-auto">
       <div class="flex space-x-8 min-w-max"><button class="tab-btn tab-active py-4 px-2 whitespace-nowrap" data-tab="dashboard">Dashboard</button> <button class="tab-btn py-4 px-2 text-gray-600 hover:text-gray-900 whitespace-nowrap" data-tab="lab">Virtual Lab</button> <button class="tab-btn py-4 px-2 text-gray-600 hover:text-gray-900 whitespace-nowrap" data-tab="projects">Community Hub</button> <button class="tab-btn py-4 px-2 text-gray-600 hover:text-gray-900 whitespace-nowrap" data-tab="sensors">IoT Sensors</button> <button class="tab-btn py-4 px-2 text-gray-600 hover:text-gray-900 whitespace-nowrap" data-tab="city">Green City</button> <button class="tab-btn py-4 px-2 text-gray-600 hover:text-gray-900 whitespace-nowrap" data-tab="history">User History</button>
       </div>
      </div>
     </div>
    </nav><!-- Content Sections -->
    <main class="container mx-auto px-4 py-8"><!-- Dashboard Tab -->
     <section id="dashboard-tab" class="tab-content">
      <div class="grid md:grid-cols-2 gap-6"><!-- Map -->
       <div class="bg-white rounded-lg shadow-lg p-6">
        <h3 class="text-xl font-bold mb-4" style="color: #00796b;">Your Location</h3>
        <div id="user-map"></div>
       </div><!-- Community Activity -->
       <div class="bg-white rounded-lg shadow-lg p-6">
        <h3 id="announcement-title" class="text-xl font-bold mb-4" style="color: #00796b;">Community Activity</h3>
        <div class="space-y-4" id="community-feed">
         <div class="announcement-card p-4 rounded-lg">
          <h4 class="font-semibold text-gray-800"> üåç  Global Collaboration</h4>
          <p class="text-sm text-gray-600 mt-1">Share your projects and see what others are building!</p>
         </div>
         <div class="announcement-card p-4 rounded-lg">
          <h4 class="font-semibold text-gray-800"> üèôÔ∏è  Community City</h4>
          <p class="text-sm text-gray-600 mt-1">Build a sustainable city together with users worldwide.</p>
         </div>
        </div>
       </div>
      </div><!-- Global Stats -->
      <div class="grid md:grid-cols-4 gap-6 mt-6">
       <div class="bg-white rounded-lg shadow-lg p-6 text-center">
        <div class="text-4xl font-bold" style="color: #00838f;" id="global-project-count">
         0
        </div>
        <p class="text-gray-600 mt-2">Global Projects</p>
       </div>
       <div class="bg-white rounded-lg shadow-lg p-6 text-center">
        <div class="text-4xl font-bold" style="color: #4caf50;" id="active-users">
         0
        </div>
        <p class="text-gray-600 mt-2">Active Users</p>
       </div>
       <div class="bg-white rounded-lg shadow-lg p-6 text-center">
        <div class="text-4xl font-bold" style="color: #ffb300;" id="global-buildings">
         0
        </div>
        <p class="text-gray-600 mt-2">City Buildings</p>
       </div>
       <div class="bg-white rounded-lg shadow-lg p-6 text-center">
        <div class="text-4xl font-bold" style="color: #ff5722;" id="total-impact">
         0
        </div>
        <p class="text-gray-600 mt-2">Total Impact</p>
       </div>
      </div>
     </section><!-- Virtual Lab Tab -->
     <section id="lab-tab" class="tab-content hidden">
      <div class="bg-white rounded-lg shadow-lg p-6">
       <h3 id="lab-section-title" class="text-2xl font-bold mb-6" style="color: #00796b;">Virtual Lab</h3><!-- Lab Modules Palette -->
       <div class="mb-6">
        <h4 id="modules-title" class="font-semibold mb-3 text-gray-700">Available Modules (Drag to Canvas)</h4>
        <div class="grid grid-cols-2 md:grid-cols-6 gap-3" id="module-palette">
         <div class="module-template bg-blue-500 text-white p-3 rounded-lg text-center cursor-pointer hover:bg-blue-600 transform hover:scale-105 transition-all" data-module="sensor" data-name="Water Sensor" data-desc="Monitors water quality parameters">
          <div class="text-2xl mb-1">
            üíß
          </div>
          <div class="text-xs font-semibold">
           Water Sensor
          </div>
         </div>
         <div class="module-template bg-green-500 text-white p-3 rounded-lg text-center cursor-pointer hover:bg-green-600 transform hover:scale-105 transition-all" data-module="filter" data-name="Bio Filter" data-desc="Natural filtration system">
          <div class="text-2xl mb-1">
            üå±
          </div>
          <div class="text-xs font-semibold">
           Bio Filter
          </div>
         </div>
         <div class="module-template bg-yellow-500 text-white p-3 rounded-lg text-center cursor-pointer hover:bg-yellow-600 transform hover:scale-105 transition-all" data-module="analyzer" data-name="Chemical Analyzer" data-desc="Analyzes chemical composition">
          <div class="text-2xl mb-1">
            ‚öóÔ∏è
          </div>
          <div class="text-xs font-semibold">
           Analyzer
          </div>
         </div>
         <div class="module-template bg-purple-500 text-white p-3 rounded-lg text-center cursor-pointer hover:bg-purple-600 transform hover:scale-105 transition-all" data-module="monitor" data-name="Data Monitor" data-desc="Real-time data visualization">
          <div class="text-2xl mb-1">
            üìä
          </div>
          <div class="text-xs font-semibold">
           Monitor
          </div>
         </div>
         <div class="module-template bg-red-500 text-white p-3 rounded-lg text-center cursor-pointer hover:bg-red-600 transform hover:scale-105 transition-all" data-module="pump" data-name="Solar Pump" data-desc="Eco-friendly water circulation">
          <div class="text-2xl mb-1">
            ‚òÄÔ∏è
          </div>
          <div class="text-xs font-semibold">
           Solar Pump
          </div>
         </div>
         <div class="module-template bg-indigo-500 text-white p-3 rounded-lg text-center cursor-pointer hover:bg-indigo-600 transform hover:scale-105 transition-all" data-module="ai" data-name="AI Controller" data-desc="Smart system management">
          <div class="text-2xl mb-1">
            ü§ñ
          </div>
          <div class="text-xs font-semibold">
           AI Brain
          </div>
         </div>
        </div>
       </div><!-- Lab Canvas -->
       <div>
        <h4 class="font-semibold mb-3 text-gray-700">Lab Canvas</h4>
        <div id="kit-canvas" class="rounded-lg"></div>
       </div><!-- Save Project -->
       <div class="mt-6 bg-gray-50 p-6 rounded-lg">
        <h4 id="save-project-title" class="font-semibold mb-4 text-gray-700">Save Your Project</h4>
        <div class="grid md:grid-cols-2 gap-4 mb-4">
         <div><label id="project-name-label" class="block text-sm font-medium mb-2">Project Name</label> <input type="text" id="project-name" placeholder="My Awesome Project" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
         </div>
         <div><label id="project-category-label" class="block text-sm font-medium mb-2">Category</label> <select id="project-category" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="water">Water Treatment</option> <option value="energy">Renewable Energy</option> <option value="air">Air Quality</option> <option value="waste">Waste Management</option> <option value="ecosystem">Ecosystem Monitoring</option> </select>
         </div>
        </div>
        <div class="mb-4"><label id="project-desc-label" class="block text-sm font-medium mb-2">Project Description</label> <textarea id="project-description" rows="3" placeholder="Describe your sustainable science project..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
        </div>
        <div class="mb-4"><label id="difficulty-label" class="block text-sm font-medium mb-2">Difficulty Level</label>
         <div class="flex gap-2"><button type="button" class="difficulty-btn bg-green-500 text-white px-4 py-2 rounded-lg text-sm ring-2 ring-white" data-level="beginner"> üå±  Beginner</button> <button type="button" class="difficulty-btn bg-yellow-500 text-white px-4 py-2 rounded-lg text-sm" data-level="intermediate"> ‚ö°  Intermediate</button> <button type="button" class="difficulty-btn bg-red-500 text-white px-4 py-2 rounded-lg text-sm" data-level="advanced"> üöÄ  Advanced</button>
         </div>
        </div>
        <div class="mb-4"><label class="flex items-center"> <input type="checkbox" id="share-project" class="mr-2"> <span class="text-sm font-medium"> üåç  Share with community (others can see and learn from your project)</span> </label>
        </div>
        <div class="flex gap-4"><button id="save-project-btn" class="btn-primary text-white px-6 py-3 rounded-lg font-semibold flex-1">  üíæ  Save Project </button> <button id="clear-canvas-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold">  üóëÔ∏è  Clear Canvas </button>
        </div>
       </div>
      </div>
     </section><!-- Community Hub Tab -->
     <section id="projects-tab" class="tab-content hidden">
      <div class="space-y-6"><!-- Project View Toggle -->
       <div class="bg-white rounded-lg shadow-lg p-6">
        <div class="flex justify-between items-center mb-4">
         <h3 class="text-2xl font-bold" style="color: #00796b;"> üåç  Community Hub</h3>
         <div class="flex gap-2"><button id="my-projects-btn" class="project-view-btn bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold ring-2 ring-blue-300">  üë§  My Projects </button> <button id="all-projects-btn" class="project-view-btn bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-semibold">  üåç  All Projects </button> <button id="leaderboard-btn" class="project-view-btn bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-semibold">  üèÜ  Leaderboard </button>
         </div>
        </div><!-- Project Stats -->
        <div class="grid md:grid-cols-4 gap-4">
         <div class="bg-blue-50 p-4 rounded-lg text-center">
          <div class="text-2xl font-bold text-blue-600" id="my-project-count">
           0
          </div>
          <p class="text-sm text-gray-600">My Projects</p>
         </div>
         <div class="bg-green-50 p-4 rounded-lg text-center">
          <div class="text-2xl font-bold text-green-600" id="community-project-count">
           0
          </div>
          <p class="text-sm text-gray-600">Community Projects</p>
         </div>
         <div class="bg-purple-50 p-4 rounded-lg text-center">
          <div class="text-2xl font-bold text-purple-600" id="total-contributors">
           0
          </div>
          <p class="text-sm text-gray-600">Contributors</p>
         </div>
         <div class="bg-yellow-50 p-4 rounded-lg text-center">
          <div class="text-2xl font-bold text-yellow-600" id="avg-impact-score">
           0
          </div>
          <p class="text-sm text-gray-600">Avg Impact</p>
         </div>
        </div>
       </div><!-- Projects List -->
       <div class="bg-white rounded-lg shadow-lg p-6">
        <div id="projects-list" class="space-y-4">
         <p class="text-gray-500 text-center py-8">No projects yet. Create one in the Virtual Lab!</p>
        </div>
       </div><!-- Leaderboard -->
       <div id="leaderboard-section" class="bg-white rounded-lg shadow-lg p-6 hidden">
        <h4 class="text-xl font-bold mb-4" style="color: #00796b;"> üèÜ  Top Contributors</h4>
        <div id="leaderboard-list" class="space-y-3"><!-- Leaderboard will be populated here -->
        </div>
       </div>
      </div>
     </section><!-- Green City Tab -->
     <section id="city-tab" class="tab-content hidden">
      <div class="space-y-6"><!-- City Header -->
       <div class="bg-white rounded-lg shadow-lg p-6">
        <div class="flex justify-between items-center mb-6">
         <div>
          <h3 class="text-2xl font-bold" style="color: #00796b;"> üå±  Global Green City</h3>
          <p class="text-gray-600 mt-2">Build a sustainable smart city together with the global community</p>
         </div>
         <div class="text-right">
          <div class="text-3xl font-bold" style="color: #4caf50;" id="city-population">
           0
          </div>
          <p class="text-sm text-gray-500">Global Citizens</p>
         </div>
        </div>
        <!-- Yeni Hava Durumu Kontrolleri -->
        <div class="mb-6 flex justify-center gap-4 p-4 bg-gray-100 rounded-lg shadow-inner">
         <button id="weather-sunny-btn" class="weather-btn bg-yellow-400 hover:bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg transition-all transform hover:scale-105 ring-2 ring-offset-2 ring-white" data-weather="sunny"> ‚òÄÔ∏è G√ºne≈üli </button>
         <button id="weather-cloudy-btn" class="weather-btn bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition-all transform hover:scale-105" data-weather="cloudy"> ‚òÅÔ∏è Bulutlu </button>
         <button id="weather-rainy-btn" class="weather-btn bg-blue-400 hover:bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg transition-all transform hover:scale-105" data-weather="rainy"> üåßÔ∏è Yaƒümurlu </button>
        </div>
        <!-- City Stats -->
        <div class="grid md:grid-cols-4 gap-4">
         <div class="bg-green-50 p-4 rounded-lg text-center">
          <div class="text-2xl font-bold text-green-600" id="green-buildings">
           0
          </div>
          <p class="text-sm text-gray-600">Green Buildings</p>
         </div>
         <div class="bg-blue-50 p-4 rounded-lg text-center">
          <div class="text-2xl font-bold text-blue-600" id="water-systems">
           0
          </div>
          <p class="text-sm text-gray-600">Water Systems</p>
         </div>
         <div class="bg-yellow-50 p-4 rounded-lg text-center">
          <div class="text-2xl font-bold text-yellow-600" id="energy-systems">
           0
          </div>
          <p class="text-sm text-gray-600">Energy Systems</p>
         </div>
         <div class="bg-purple-50 p-4 rounded-lg text-center">
          <div class="text-2xl font-bold text-purple-600" id="transport-systems">
           0
          </div>
          <p class="text-sm text-gray-600">Transport</p>
         </div>
        </div>
       </div><!-- Building Palette -->
       <div class="bg-white rounded-lg shadow-lg p-6">
        <h4 class="font-semibold mb-4 text-gray-700"> üèóÔ∏è  Available Buildings (Drag to City)</h4>
        <div class="grid grid-cols-2 md:grid-cols-6 gap-3" id="building-palette">
         <div class="building-template bg-green-500 text-white p-3 rounded-lg text-center cursor-pointer hover:bg-green-600 transform hover:scale-105 transition-all" data-building="green-house" data-name="Green House" data-desc="Eco-friendly residential building" data-category="green">
          <div class="text-2xl mb-1">
            üè†
          </div>
          <div class="text-xs font-semibold">
           Green House
          </div>
         </div>
         <div class="building-template bg-blue-500 text-white p-3 rounded-lg text-center cursor-pointer hover:bg-blue-600 transform hover:scale-105 transition-all" data-building="water-plant" data-name="Water Plant" data-desc="Water treatment facility" data-category="water">
          <div class="text-2xl mb-1">
            üè≠
          </div>
          <div class="text-xs font-semibold">
           Water Plant
          </div>
         </div>
         <div class="building-template bg-yellow-500 text-white p-3 rounded-lg text-center cursor-pointer hover:bg-yellow-600 transform hover:scale-105 transition-all" data-building="solar-farm" data-name="Solar Farm" data-desc="Renewable energy source" data-category="energy">
          <div class="text-2xl mb-1">
            ‚òÄÔ∏è
          </div>
          <div class="text-xs font-semibold">
           Solar Farm
          </div>
         </div>
         <div class="building-template bg-purple-500 text-white p-3 rounded-lg text-center cursor-pointer hover:bg-purple-600 transform hover:scale-105 transition-all" data-building="metro-station" data-name="Metro Station" data-desc="Public transportation hub" data-category="transport">
          <div class="text-2xl mb-1">
            üöá
          </div>
          <div class="text-xs font-semibold">
           Metro Station
          </div>
         </div>
         <div class="building-template bg-emerald-500 text-white p-3 rounded-lg text-center cursor-pointer hover:bg-emerald-600 transform hover:scale-105 transition-all" data-building="park" data-name="Green Park" data-desc="Urban green space" data-category="green">
          <div class="text-2xl mb-1">
            üå≥
          </div>
          <div class="text-xs font-semibold">
           Green Park
          </div>
         </div>
         <div class="building-template bg-indigo-500 text-white p-3 rounded-lg text-center cursor-pointer hover:bg-indigo-600 transform hover:scale-105 transition-all" data-building="research-center" data-name="Research Center" data-desc="STEM research facility" data-category="green">
          <div class="text-2xl mb-1">
            üî¨
          </div>
          <div class="text-xs font-semibold">
           Research Center
          </div>
         </div>
         <div class="building-template bg-teal-500 text-white p-3 rounded-lg text-center cursor-pointer hover:bg-teal-600 transform hover:scale-105 transition-all" data-building="wind-turbine" data-name="Wind Turbine" data-desc="Wind energy generator" data-category="energy">
          <div class="text-2xl mb-1">
            üí®
          </div>
          <div class="text-xs font-semibold">
           Wind Turbine
          </div>
         </div>
         <div class="building-template bg-cyan-500 text-white p-3 rounded-lg text-center cursor-pointer hover:bg-cyan-600 transform hover:scale-105 transition-all" data-building="recycling-center" data-name="Recycling Center" data-desc="Waste management facility" data-category="green">
          <div class="text-2xl mb-1">
            ‚ôªÔ∏è
          </div>
          <div class="text-xs font-semibold">
           Recycling Center
          </div>
         </div>
         <div class="building-template bg-lime-500 text-white p-3 rounded-lg text-center cursor-pointer hover:bg-lime-600 transform hover:scale-105 transition-all" data-building="vertical-farm" data-name="Vertical Farm" data-desc="Urban agriculture tower" data-category="green">
          <div class="text-2xl mb-1">
            üåæ
          </div>
          <div class="text-xs font-semibold">
           Vertical Farm
          </div>
         </div>
         <div class="building-template bg-orange-500 text-white p-3 rounded-lg text-center cursor-pointer hover:bg-orange-600 transform hover:scale-105 transition-all" data-building="ev-station" data-name="EV Station" data-desc="Electric vehicle charging" data-category="transport">
          <div class="text-2xl mb-1">
            üîå
          </div>
          <div class="text-xs font-semibold">
           EV Station
          </div>
         </div>
         <div class="building-template bg-pink-500 text-white p-3 rounded-lg text-center cursor-pointer hover:bg-pink-600 transform hover:scale-105 transition-all" data-building="smart-grid" data-name="Smart Grid" data-desc="Intelligent power distribution" data-category="energy">
          <div class="text-2xl mb-1">
            ‚ö°
          </div>
          <div class="text-xs font-semibold">
           Smart Grid
          </div>
         </div>
         <div class="building-template bg-red-500 text-white p-3 rounded-lg text-center cursor-pointer hover:bg-red-600 transform hover:scale-105 transition-all" data-building="air-purifier" data-name="Air Purifier" data-desc="Urban air cleaning system" data-category="green">
          <div class="text-2xl mb-1">
            üå¨Ô∏è
          </div>
          <div class="text-xs font-semibold">
           Air Purifier
          </div>
         </div>
        </div>
       </div><!-- City Canvas -->
       <div class="bg-white rounded-lg shadow-lg p-6">
        <h4 class="font-semibold mb-4 text-gray-700"> üèôÔ∏è  Global Green City Canvas</h4>
        <div id="city-canvas" class="rounded-lg relative overflow-hidden" style="min-height: 500px; background: #f0f8ff; border: 2px solid #4caf50;">
         <svg width="100%" height="100%" viewbox="0 0 800 500" class="absolute inset-0">
          <defs>
           <lineargradient id="skyGradient" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#87CEEB;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#E0F6FF;stop-opacity:1" />
           </lineargradient>
           <lineargradient id="grassGradient" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#90EE90;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#228B22;stop-opacity:1" />
           </lineargradient>
          </defs>
          <!-- Sky background (Dinamik G√∂ky√ºz√º) -->
          <rect width="800" height="300" fill="url(#skyGradient)" />
          <!-- Hareket Eden Bulutlar -->
          <g class="moving-cloud" style="animation-duration: 40s; animation-delay: 0s;">
           <ellipse cx="150" cy="80" rx="30" ry="15" />
           <ellipse cx="140" cy="75" rx="20" ry="12" />
           <ellipse cx="160" cy="75" rx="25" ry="10" />
          </g>
          <g class="moving-cloud" style="animation-duration: 50s; animation-delay: -20s;">
           <ellipse cx="450" cy="60" rx="35" ry="18" />
           <ellipse cx="440" cy="55" rx="25" ry="15" />
           <ellipse cx="465" cy="55" rx="20" ry="12" />
          </g>
          <g class="moving-cloud" style="animation-duration: 65s; animation-delay: -45s;">
           <ellipse cx="650" cy="90" rx="28" ry="14" />
           <ellipse cx="640" cy="85" rx="18" ry="10" />
           <ellipse cx="660" cy="85" rx="22" ry="12" />
          </g>
          <!-- Sun (D√∂nen G√ºne≈ü I≈üƒ±nlarƒ±) -->
          <g id="sun-group">
           <circle cx="700" cy="80" r="25" fill="#FFD700" opacity="0.9" />
           <g stroke="#FFD700" stroke-width="3" opacity="0.7" id="sun-rays">
            <line x1="700" y1="35" x2="700" y2="45" />
            <line x1="700" y1="115" x2="700" y2="125" />
            <line x1="655" y1="80" x2="645" y2="80" />
            <line x1="755" y1="80" x2="745" y2="80" />
            <line x1="672" y1="52" x2="667" y2="47" />
            <line x1="733" y1="113" x2="728" y2="108" />
            <line x1="728" y1="52" x2="733" y2="47" />
            <line x1="667" y1="113" x2="672" y2="108" />
           </g>
          </g>
          <!-- Ground -->
          <rect y="300" width="800" height="200" fill="url(#grassGradient)" />
          <!-- Roads -->
          <rect x="0" y="350" width="800" height="20" fill="#696969" opacity="0.8" />
          <rect x="0" y="420" width="800" height="20" fill="#696969" opacity="0.8" />
          <rect x="200" y="300" width="20" height="200" fill="#696969" opacity="0.8" />
          <rect x="400" y="300" width="20" height="200" fill="#696969" opacity="0.8" />
          <rect x="600" y="300" width="20" height="200" fill="#696969" opacity="0.8" />
          <!-- Road markings (Animasyonlu Yol √áizgileri) -->
          <g stroke="#FFFF00" stroke-width="2" class="animated-road-line" opacity="0.8">
           <line x1="0" y1="360" x2="800" y2="360" />
           <line x1="0" y1="430" x2="800" y2="430" />
           <line x1="210" y1="300" x2="210" y2="500" />
           <line x1="410" y1="300" x2="410" y2="500" />
           <line x1="610" y1="300" x2="610" y2="500" />
          </g>
          <!-- Trees (Aƒüa√ßlar) -->
          <g fill="#228B22">
           <circle cx="100" cy="320" r="15" class="swaying-tree" />
           <circle cx="300" cy="315" r="18" class="swaying-tree" style="animation-delay: -1s;" />
           <circle cx="500" cy="325" r="12" class="swaying-tree" style="animation-delay: -2s;" />
           <circle cx="700" cy="318" r="16" class="swaying-tree" style="animation-delay: -0.5s;" />
           <circle cx="150" cy="480" r="14" class="swaying-tree" />
           <circle cx="350" cy="475" r="17" class="swaying-tree" style="animation-delay: -1.5s;" />
           <circle cx="550" cy="485" r="13" class="swaying-tree" style="animation-delay: -2.5s;" />
           <circle cx="750" cy="478" r="15" class="swaying-tree" style="animation-delay: -3s;" />
          </g>
          <!-- Tree trunks -->
          <g fill="#8B4513">
           <rect x="95" y="335" width="10" height="15" />
           <rect x="295" y="333" width="10" height="17" />
           <rect x="495" y="337" width="10" height="13" />
           <rect x="695" y="334" width="10" height="16" />
           <rect x="145" y="494" width="10" height="14" />
           <rect x="345" y="492" width="10" height="17" />
           <rect x="545" y="498" width="10" height="13" />
           <rect x="745" y="493" width="10" height="15" />
          </g>
          <!-- Grid overlay for building placement (Parƒ±ldayan Izgara) -->
          <g class="placement-grid">
           <!-- Vertical lines -->
           <line x1="100" y1="300" x2="100" y2="500" />
           <line x1="150" y1="300" x2="150" y2="500" />
           <line x1="250" y1="300" x2="250" y2="500" />
           <line x1="300" y1="300" x2="300" y2="500" />
           <line x1="350" y1="300" x2="350" y2="500" />
           <line x1="450" y1="300" x2="450" y2="500" />
           <line x1="500" y1="300" x2="500" y2="500" />
           <line x1="550" y1="300" x2="550" y2="500" />
           <line x1="650" y1="300" x2="650" y2="500" />
           <line x1="700" y1="300" x2="700" y2="500" />
           <!-- Horizontal lines -->
           <line x1="0" y1="320" x2="800" y2="320" />
           <line x1="0" y1="380" x2="800" y2="380" />
           <line x1="0" y1="400" x2="800" y2="400" />
           <line x1="0" y1="450" x2="800" y2="450" />
           <line x1="0" y1="480" x2="800" y2="480" />
          </g>
         </svg>
         <!-- Building placement area (Hareketli Ara√ßlar ve Binalar Buraya) -->
         <div class="absolute inset-0" style="top: 300px;">
          <!-- Animasyonlu Ara√ßlar (Car) -->
          <div class="animated-car" style="top: 55px; animation-duration: 10s; left: -100px;">
           <svg width="40" height="15" viewbox="0 0 40 15">
            <rect x="5" y="0" width="30" height="10" rx="2" fill="#FF5722" />
            <circle cx="10" cy="12" r="3" fill="#333" />
            <circle cx="30" cy="12" r="3" fill="#333" />
           </svg>
          </div>
          <!-- Animasyonlu Ara√ßlar (Bus) -->
          <div class="animated-car" style="top: 125px; animation-duration: 15s; animation-delay: -5s; left: -200px;">
           <svg width="60" height="20" viewbox="0 0 60 20">
            <rect x="5" y="0" width="50" height="15" rx="3" fill="#00BCD4" />
            <circle cx="15" cy="17" r="3" fill="#333" />
            <circle cx="45" cy="17" r="3" fill="#333" />
           </svg>
          </div>
          <!-- Buildings will be placed here -->
         </div>
        </div>
       </div><!-- City Controls -->
       <div class="bg-white rounded-lg shadow-lg p-6">
        <div class="flex justify-between items-center mb-4">
         <h4 class="font-semibold text-gray-700"> üéÆ  City Management</h4>
         <div class="flex gap-3"><button id="save-city-btn" class="btn-primary text-white px-4 py-2 rounded-lg font-semibold">  üíæ  Save My Contribution </button> <button id="refresh-city-btn" class="btn-secondary text-white px-4 py-2 rounded-lg font-semibold">  üîÑ  Refresh City </button>
         </div>
        </div><!-- User Contributions -->
        <div class="grid md:grid-cols-2 gap-6">
         <div>
          <h5 class="font-semibold mb-3 text-gray-700"> üë§  Your Contributions</h5>
          <div id="user-contributions" class="space-y-2 max-h-40 overflow-y-auto">
           <p class="text-gray-500 text-sm">No contributions yet. Add buildings to the city!</p>
          </div>
         </div>
         <div>
          <h5 class="font-semibold mb-3 text-gray-700"> üåç  Global Activity</h5>
          <div id="community-activity" class="space-y-2 max-h-40 overflow-y-auto">
           <p class="text-gray-500 text-sm">Loading global activity...</p>
          </div>
         </div>
        </div>
       </div>
      </div>
     </section><!-- User History Tab -->
     <section id="history-tab" class="tab-content hidden">
      <div class="space-y-6"><!-- History Header -->
       <div class="bg-white rounded-lg shadow-lg p-6">
        <h3 class="text-2xl font-bold mb-4" style="color: #00796b;"> üìä  User Activity History</h3>
        <div class="grid md:grid-cols-4 gap-4">
         <div class="bg-blue-50 p-4 rounded-lg text-center">
          <div class="text-2xl font-bold text-blue-600" id="total-projects-history">
           0
          </div>
          <p class="text-sm text-gray-600">Total Projects</p>
         </div>
         <div class="bg-green-50 p-4 rounded-lg text-center">
          <div class="text-2xl font-bold text-green-600" id="total-sensor-readings">
           0
          </div>
          <p class="text-sm text-gray-600">Sensor Readings</p>
         </div>
         <div class="bg-purple-50 p-4 rounded-lg text-center">
          <div class="text-2xl font-bold text-purple-600" id="total-city-contributions">
           0
          </div>
          <p class="text-sm text-gray-600">City Buildings</p>
         </div>
         <div class="bg-yellow-50 p-4 rounded-lg text-center">
          <div class="text-2xl font-bold text-yellow-600" id="days-active">
           0
          </div>
          <p class="text-sm text-gray-600">Days Active</p>
         </div>
        </div>
       </div><!-- Activity Timeline -->
       <div class="bg-white rounded-lg shadow-lg p-6">
        <h4 class="text-xl font-bold mb-4" style="color: #00796b;"> üìÖ  Recent Activity</h4>
        <div id="activity-timeline" class="space-y-4">
         <p class="text-gray-500 text-center py-8">No activity yet. Start using the platform to see your history!</p>
        </div>
       </div><!-- Activity Charts -->
       <div class="grid md:grid-cols-2 gap-6">
        <div class="bg-white rounded-lg shadow-lg p-6">
         <h4 class="text-lg font-bold mb-4" style="color: #00796b;"> üìà  Projects by Category</h4>
         <div id="projects-chart" class="h-64 flex items-center justify-center">
          <svg width="100%" height="100%" viewbox="0 0 300 200"><text x="150" y="100" text-anchor="middle" class="text-gray-500 text-sm">
            No project data available
           </text>
          </svg>
         </div>
        </div>
        <div class="bg-white rounded-lg shadow-lg p-6">
         <h4 class="text-lg font-bold mb-4" style="color: #00796b;"> üìä  Activity Over Time</h4>
         <div id="activity-chart" class="h-64 flex items-center justify-center">
          <svg width="100%" height="100%" viewbox="0 0 300 200"><text x="150" y="100" text-anchor="middle" class="text-gray-500 text-sm">
            No activity data available
           </text>
          </svg>
         </div>
        </div>
       </div>
      </div>
     </section><!-- IoT Sensors Tab -->
     <section id="sensors-tab" class="tab-content hidden">
      <div class="space-y-6"><!-- Sensor Controls -->
       <div class="bg-white rounded-lg shadow-lg p-6">
        <div class="flex justify-between items-center mb-6">
         <h3 class="text-2xl font-bold" style="color: #00796b;">IoT Environmental Sensors</h3>
         <div class="flex gap-3"><button id="start-monitoring" class="btn-primary text-white px-4 py-2 rounded-lg font-semibold">  ‚ñ∂Ô∏è  Start Monitoring </button> <button id="stop-monitoring" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold">  ‚èπÔ∏è  Stop </button> <button id="save-sensor-data" class="btn-secondary text-white px-4 py-2 rounded-lg font-semibold">  üíæ  Save Data </button>
         </div>
        </div><!-- Connection Status -->
        <div class="mb-6 p-4 bg-gray-50 rounded-lg">
         <div class="flex items-center gap-3">
          <div id="connection-status" class="w-3 h-3 rounded-full sensor-status-offline"></div><span id="connection-text" class="font-semibold">Sensors Offline</span> <span class="text-sm text-gray-500">|</span> <span class="text-sm text-gray-500">Last Update: <span id="last-update">Never</span></span>
         </div>
        </div>
       </div><!-- Sensor Grid -->
       <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" id="sensor-grid"><!-- Temperature Sensor -->
        <div class="sensor-card p-6">
         <div class="flex justify-between items-start mb-4">
          <div>
           <h4 class="font-bold text-gray-800"> üå°Ô∏è  Temperature</h4>
           <p class="text-sm text-gray-500">Environmental</p>
          </div>
          <div class="w-3 h-3 rounded-full sensor-status-offline" id="temp-status"></div>
         </div>
         <div class="sensor-value text-blue-600" id="temp-value">
          --¬∞C
         </div>
         <div class="text-sm text-gray-500 mt-2">
          Range: 15-35¬∞C | Threshold: ¬±5¬∞C
         </div>
         <div class="chart-container mt-4" id="temp-chart">
          <svg width="100%" height="100%" viewbox="0 0 300 150"><defs>
            <lineargradient id="tempGradient" x1="0%" y1="0%" x2="0%" y2="100%">
             <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:0.3" />
             <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:0" />
            </lineargradient>
           </defs> <path id="temp-line" class="chart-line" d="M0,75 L300,75"></path> <path id="temp-area" class="chart-area" fill="url(#tempGradient)" d="M0,75 L300,75 L300,150 L0,150 Z"></path>
          </svg>
         </div>
        </div><!-- Humidity Sensor -->
        <div class="sensor-card p-6">
         <div class="flex justify-between items-start mb-4">
          <div>
           <h4 class="font-bold text-gray-800"> üíß  Humidity</h4>
           <p class="text-sm text-gray-500">Air Quality</p>
          </div>
          <div class="w-3 h-3 rounded-full sensor-status-offline" id="humidity-status"></div>
         </div>
         <div class="sensor-value text-cyan-600" id="humidity-value">
          --%
         </div>
         <div class="text-sm text-gray-500 mt-2">
          Range: 30-70% | Optimal: 45-55%
         </div>
         <div class="chart-container mt-4" id="humidity-chart">
          <svg width="100%" height="100%" viewbox="0 0 300 150"><path id="humidity-line" class="chart-line" style="stroke:#06b6d4" d="M0,75 L300,75"></path>
          </svg>
         </div>
        </div><!-- Air Quality Sensor -->
        <div class="sensor-card p-6">
         <div class="flex justify-between items-start mb-4">
          <div>
           <h4 class="font-bold text-gray-800"> üå¨Ô∏è  Air Quality</h4>
           <p class="text-sm text-gray-500">PM2.5 Index</p>
          </div>
          <div class="w-3 h-3 rounded-full sensor-status-offline" id="air-status"></div>
         </div>
         <div class="sensor-value text-green-600" id="air-value">
          -- AQI
         </div>
         <div class="text-sm text-gray-500 mt-2">
          Good: 0-50 | Moderate: 51-100 | Unhealthy: 101+
         </div>
         <div class="chart-container mt-4" id="air-chart">
          <svg width="100%" height="100%" viewbox="0 0 300 150"><path id="air-line" class="chart-line" style="stroke:#10b981" d="M0,75 L300,75"></path>
          </svg>
         </div>
        </div><!-- Water pH Sensor -->
        <div class="sensor-card p-6">
         <div class="flex justify-between items-start mb-4">
          <div>
           <h4 class="font-bold text-gray-800"> ‚öóÔ∏è  Water pH</h4>
           <p class="text-sm text-gray-500">Acidity Level</p>
          </div>
          <div class="w-3 h-3 rounded-full sensor-status-offline" id="ph-status"></div>
         </div>
         <div class="sensor-value text-purple-600" id="ph-value">
          -- pH
         </div>
         <div class="text-sm text-gray-500 mt-2">
          Neutral: 6.5-7.5 | Acidic: &lt;6.5 | Basic: &gt;7.5
         </div>
         <div class="chart-container mt-4" id="ph-chart">
          <svg width="100%" height="100%" viewbox="0 0 300 150"><path id="ph-line" class="chart-line" style="stroke:#8b5cf6" d="M0,75 L300,75"></path>
          </svg>
         </div>
        </div><!-- Light Sensor -->
        <div class="sensor-card p-6">
         <div class="flex justify-between items-start mb-4">
          <div>
           <h4 class="font-bold text-gray-800"> ‚òÄÔ∏è  Light Intensity</h4>
           <p class="text-sm text-gray-500">Illumination</p>
          </div>
          <div class="w-3 h-3 rounded-full sensor-status-offline" id="light-status"></div>
         </div>
         <div class="sensor-value text-yellow-600" id="light-value">
          -- lux
         </div>
         <div class="text-sm text-gray-500 mt-2">
          Indoor: 100-500 | Outdoor: 1000-10000+
         </div>
         <div class="chart-container mt-4" id="light-chart">
          <svg width="100%" height="100%" viewbox="0 0 300 150"><path id="light-line" class="chart-line" style="stroke:#eab308" d="M0,75 L300,75"></path>
          </svg>
         </div>
        </div><!-- Soil Moisture Sensor -->
        <div class="sensor-card p-6">
         <div class="flex justify-between items-start mb-4">
          <div>
           <h4 class="font-bold text-gray-800"> üå±  Soil Moisture</h4>
           <p class="text-sm text-gray-500">Plant Health</p>
          </div>
          <div class="w-3 h-3 rounded-full sensor-status-offline" id="soil-status"></div>
         </div>
         <div class="sensor-value text-emerald-600" id="soil-value">
          --%
         </div>
         <div class="text-sm text-gray-500 mt-2">
          Dry: 0-30% | Optimal: 40-60% | Wet: 70-100%
         </div>
         <div class="chart-container mt-4" id="soil-chart">
          <svg width="100%" height="100%" viewbox="0 0 300 150"><path id="soil-line" class="chart-line" style="stroke:#059669" d="M0,75 L300,75"></path>
          </svg>
         </div>
        </div>
       </div><!-- Alerts Panel -->
       <div class="bg-white rounded-lg shadow-lg p-6">
        <h4 class="text-xl font-bold mb-4" style="color: #00796b;">System Alerts</h4>
        <div id="alerts-container" class="space-y-3">
         <p class="text-gray-500 text-center py-4">No active alerts. All systems normal.</p>
        </div>
       </div><!-- Data Export -->
       <div class="bg-white rounded-lg shadow-lg p-6">
        <h4 class="text-xl font-bold mb-4" style="color: #00796b;">Data Management</h4>
        <div class="grid md:grid-cols-3 gap-4"><button id="export-csv" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg font-semibold">  üìä  Export CSV </button> <button id="clear-data" class="bg-red-500 hover:bg-red-600 text-white px-4 py-3 rounded-lg font-semibold">  üóëÔ∏è  Clear Data </button> <button id="generate-report" class="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg font-semibold">  üìã  Generate Report </button>
        </div>
       </div>
      </div>
     </section>
    </main>
   </div>
  </div>
  <script>
        // Configuration
        const defaultConfig = {
            site_title: "STEMCycle G2B Lab Hub",
            welcome_message: "Welcome to your sustainable science lab",
            announcement_title: "Community Activity",
            lab_section_title: "Virtual Lab",
            primary_color: "#00838f",
            secondary_color: "#4caf50",
            accent_color: "#ffb300"
        };
        let currentUser = null;
        let currentLocation = null;
        let currentLanguage = 'en';
        let selectedDifficulty = 'beginner';
        let map = null;
        let canvasModules = [];
        let draggedElement = null;
        let offsetX = 0;
        let offsetY = 0;
        let allProjects = [];
        let audioContext = null;
        let isPlaying = false;
        // IoT Sensor Variables
        let sensorData = [];
        let isMonitoring = false;
        let monitoringInterval = null;
        let sensorCharts = {};
        let alertCount = 0;
        // Community Variables
        let currentProjectView = 'my'; // 'my', 'all', or 'leaderboard'
        // City Variables
        let currentWeather = 'sunny';
        // Sensor Configuration
        const sensorConfig = {
            temperature: { min: 15, max: 35, unit: '¬∞C', threshold: 5, color: '#3b82f6' },
            humidity: { min: 30, max: 70, unit: '%', threshold: 10, color: '#06b6d4' },
            air_quality: { min: 0, max: 150, unit: ' AQI', threshold: 50, color: '#10b981' },
            ph: { min: 6.0, max: 8.0, unit: ' pH', threshold: 0.5, color: '#8b5cf6' },
            light: { min: 100, max: 10000, unit: ' lux', threshold: 500, color: '#eab308' },
            soil_moisture: { min: 20, max: 80, unit: '%', threshold: 15, color: '#059669' }
        };
        // Language translations
        const translations = {
            en: {
                selectLanguage: "Select Language / Dil Se√ßin",
                chooseLanguage: "Choose your preferred language",
                welcomeTitle: "Welcome to STEMCycle G2B",
                welcomeSubtitle: "Your sustainable science laboratory awaits",
                username: "Username",
                location: "Your Location (City)",
                enterHub: "Enter Lab Hub",
                dashboard: "Dashboard",
                virtualLab: "Virtual Lab",
                communityHub: "Community Hub",
                iotSensors: "IoT Sensors",
                yourLocation: "Your Location",
                communityActivity: "Community Activity",
                globalProjects: "Global Projects",
                activeUsers: "Active Users",
                cityBuildings: "City Buildings",
                totalImpact: "Total Impact",
                availableModules: "Available Modules (Drag to Canvas)",
                labCanvas: "Lab Canvas",
                saveProject: "Save Your Project",
                projectName: "Project Name",
                category: "Category",
                projectDesc: "Project Description",
                difficulty: "Difficulty Level",
                clearCanvas: "Clear Canvas",
                noProjects: "No projects yet. Create one in the Virtual Lab!",
                waterTreatment: "Water Treatment",
                renewableEnergy: "Renewable Energy",
                airQuality: "Air Quality",
                wasteManagement: "Waste Management",
                ecosystemMonitoring: "Ecosystem Monitoring",
                startMonitoring: "Start Monitoring",
                stopMonitoring: "Stop",
                saveData: "Save Data",
                sensorsOffline: "Sensors Offline",
                sensorsOnline: "Sensors Online",
                lastUpdate: "Last Update",
                never: "Never"
            },
            tr: {
                selectLanguage: "Dil Se√ßin / Select Language",
                chooseLanguage: "Tercih ettiƒüiniz dili se√ßin",
                welcomeTitle: "STEMCycle G2B'ye Ho≈ü Geldiniz",
                welcomeSubtitle: "S√ºrd√ºr√ºlebilir bilim laboratuvarƒ±nƒ±z sizi bekliyor",
                username: "Kullanƒ±cƒ± Adƒ±",
                location: "Konumunuz (≈ûehir)",
                enterHub: "Laboratuvara Gir",
                dashboard: "Ana Panel",
                virtualLab: "Sanal Laboratuvar",
                communityHub: "Topluluk Merkezi",
                iotSensors: "IoT Sens√∂rler",
                yourLocation: "Konumunuz",
                communityActivity: "Topluluk Aktivitesi",
                globalProjects: "K√ºresel Projeler",
                activeUsers: "Aktif Kullanƒ±cƒ±lar",
                cityBuildings: "≈ûehir Binalarƒ±",
                totalImpact: "Toplam Etki",
                availableModules: "Mevcut Mod√ºller (Tuvale S√ºr√ºkleyin)",
                labCanvas: "Laboratuvar Tuvali",
                saveProject: "Projenizi Kaydedin",
                projectName: "Proje Adƒ±",
                category: "Kategori",
                projectDesc: "Proje A√ßƒ±klamasƒ±",
                difficulty: "Zorluk Seviyesi",
                clearCanvas: "Tuvali Temizle",
                noProjects: "Hen√ºz proje yok. Sanal Laboratuvarda bir tane olu≈üturun!",
                waterTreatment: "Su Arƒ±tma",
                renewableEnergy: "Yenilenebilir Enerji",
                airQuality: "Hava Kalitesi",
                wasteManagement: "Atƒ±k Y√∂netimi",
                ecosystemMonitoring: "Ekosistem ƒ∞zleme",
                startMonitoring: "ƒ∞zlemeyi Ba≈ülat",
                stopMonitoring: "Durdur",
                saveData: "Veriyi Kaydet",
                sensorsOffline: "Sens√∂rler √áevrimdƒ±≈üƒ±",
                sensorsOnline: "Sens√∂rler √áevrimi√ßi",
                lastUpdate: "Son G√ºncelleme",
                never: "Hi√ß"
            }
        };
        // Initialize Element SDK
        async function onConfigChange(config) {
            document.getElementById('site-title').textContent = config.site_title || defaultConfig.site_title;
            document.getElementById('welcome-message').textContent = config.welcome_message || defaultConfig.welcome_message;
            document.getElementById('announcement-title').textContent = config.announcement_title || defaultConfig.announcement_title;
            document.getElementById('lab-section-title').textContent = config.lab_section_title || defaultConfig.lab_section_title;
        }
        if (window.elementSdk) {
            window.elementSdk.init({
                defaultConfig,
                onConfigChange,
                mapToCapabilities: (config) => ({
                    recolorables: [
                        {
                            get: () => config.primary_color || defaultConfig.primary_color,
                            set: (value) => {
                                config.primary_color = value;
                                window.elementSdk.setConfig({ primary_color: value });
                            }
                        },
                        {
                            get: () => config.secondary_color || defaultConfig.secondary_color,
                            set: (value) => {
                                config.secondary_color = value;
                                window.elementSdk.setConfig({ secondary_color: value });
                            }
                        },
                        {
                            get: () => config.accent_color || defaultConfig.accent_color,
                            set: (value) => {
                                config.accent_color = value;
                                window.elementSdk.setConfig({ accent_color: value });
                            }
                        }
                    ],
                    borderables: [],
                    fontEditable: undefined,
                    fontSizeable: undefined
                }),
                mapToEditPanelValues: (config) => new Map([
                    ["site_title", config.site_title || defaultConfig.site_title],
                    ["welcome_message", config.welcome_message || defaultConfig.welcome_message],
                    ["announcement_title", config.announcement_title || defaultConfig.announcement_title],
                    ["lab_section_title", config.lab_section_title || defaultConfig.lab_section_title]
                ])
            });
        }
        // City and History Variables
        let cityBuildings = [];
        let userHistory = [];
        let cityCanvas = null;
        let cityDraggedElement = null;
        let cityOffsetX = 0;
        let cityOffsetY = 0;
        // Initialize Data SDK
        const dataHandler = {
            onDataChanged(data) {
                allProjects = data.filter(item => item.project_name);
                sensorData = data.filter(item => item.sensor_type);
                cityBuildings = data.filter(item => item.building_type);
                userHistory = data.filter(item => item.activity_type);
                
                renderProjects(allProjects);
                updateProjectCount(allProjects.length);
                renderCityBuildings(cityBuildings);
                updateCityStats(cityBuildings);
                renderUserHistory(userHistory);
                updateHistoryStats();
                updateGlobalStats();
                updateCommunityFeed();
            }
        };
        async function initializeApp() {
            const initResult = await window.dataSdk.init(dataHandler);
            if (!initResult.isOk) {
                showToast('Failed to initialize data storage', 'error');
            }
        }
        // Language Selection
        document.getElementById('lang-en').addEventListener('click', () => {
            currentLanguage = 'en';
            updateLanguage();
            document.getElementById('language-modal').classList.add('hidden');
            document.getElementById('auth-modal').classList.remove('hidden');
        });
        document.getElementById('lang-tr').addEventListener('click', () => {
            currentLanguage = 'tr';
            updateLanguage();
            document.getElementById('language-modal').classList.add('hidden');
            document.getElementById('auth-modal').classList.remove('hidden');
        });
        // Update Language Function
        function updateLanguage() {
            const t = translations[currentLanguage];
            
            // Auth modal
            document.getElementById('auth-title').textContent = t.welcomeTitle;
            document.getElementById('auth-subtitle').textContent = t.welcomeSubtitle;
            document.getElementById('username-label').textContent = t.username;
            document.getElementById('location-label').textContent = t.location;
            document.getElementById('enter-btn').textContent = t.enterHub;
            
            // Navigation
            document.querySelectorAll('.tab-btn')[0].textContent = t.dashboard;
            document.querySelectorAll('.tab-btn')[1].textContent = t.virtualLab;
            document.querySelectorAll('.tab-btn')[2].textContent = t.communityHub;
            document.querySelectorAll('.tab-btn')[3].textContent = t.iotSensors;
            
            // Update placeholders
            document.getElementById('username').placeholder = currentLanguage === 'en' ? 'Enter your username' : 'Kullanƒ±cƒ± adƒ±nƒ±zƒ± girin';
            document.getElementById('location').placeholder = currentLanguage === 'en' ? 'e.g., Istanbul' : '√∂rn., ƒ∞stanbul';
            
            // Update other elements
            if (document.getElementById('modules-title')) {
                document.getElementById('modules-title').textContent = t.availableModules;
            }
        }
        // Music Functions
        function createAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }
        function playWelcomeMusic() {
            createAudioContext();
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
            oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.3); // E5
            oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.6); // G5
            
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 1);
            
            isPlaying = true;
            setTimeout(() => { isPlaying = false; }, 1000);
        }
        // Music Toggle
        document.getElementById('music-toggle').addEventListener('click', () => {
            if (!isPlaying) {
                playWelcomeMusic();
                document.getElementById('music-toggle').textContent = ' üîä ';
                setTimeout(() => {
                    document.getElementById('music-toggle').textContent = ' üéµ ';
                }, 1000);
            }
        });
        // Auth Form Handler
        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const location = document.getElementById('location').value.trim();
            
            if (!username || !location) {
                const message = currentLanguage === 'en' ? 'Please fill in all fields' : 'L√ºtfen t√ºm alanlarƒ± doldurun';
                showToast(message, 'error');
                return;
            }
            
            currentUser = username;
            currentLocation = location;
            
            document.getElementById('user-display').textContent = currentUser;
            document.getElementById('location-display').textContent = currentLocation;
            
            document.getElementById('auth-modal').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            playWelcomeMusic(); // Play welcome sound
            initializeMap();
            await initializeApp();
            initializeSensorCharts();
            initializeCityCanvas();

            // Yeni hava durumu ayarƒ±
            updateWeather('sunny');
            
            // Add login to user history
            addToUserHistory('login', `Logged in from ${currentLocation}`);
        });
        // Guest Mode Handler
        document.getElementById('guest-btn').addEventListener('click', async () => {
            currentUser = 'Guest_' + Math.random().toString(36).substr(2, 6);
            currentLocation = 'Unknown Location';
            
            document.getElementById('user-display').textContent = currentUser + ' (Guest Mode)';
            document.getElementById('location-display').textContent = currentLocation;
            
            document.getElementById('auth-modal').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            playWelcomeMusic(); // Play welcome sound
            initializeMap();
            await initializeApp();
            initializeSensorCharts();
            initializeCityCanvas();

            // Yeni hava durumu ayarƒ±
            updateWeather('sunny');
            
            // Add login to user history
            addToUserHistory('login', 'Logged in as guest user');
            
            const message = currentLanguage === 'en' ? 
                'Welcome to Guest Mode! You can explore all features.' : 
                'Misafir Moduna Ho≈ü Geldiniz! T√ºm √∂zellikleri ke≈üfedebilirsiniz.';
            showToast(message, 'success');
        });
        // Tab Navigation
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;
                
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('tab-active');
                    b.classList.add('text-gray-600');
                });
                btn.classList.add('tab-active');
                btn.classList.remove('text-gray-600');
                
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            });
        });
        // Initialize Map
        function initializeMap() {
            const mapElement = document.getElementById('user-map');
            if (!mapElement) return;
            
            map = L.map('user-map').setView([41.0082, 28.9784], 10);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            L.marker([41.0082, 28.9784]).addTo(map)
                .bindPopup(`<b>${currentUser}</b><br>${currentLocation}`)
                .openPopup();
        }
        // Community Project View Handlers
        document.getElementById('my-projects-btn').addEventListener('click', () => {
            currentProjectView = 'my';
            updateProjectViewButtons();
            renderProjects(allProjects);
            document.getElementById('leaderboard-section').classList.add('hidden');
        });
        document.getElementById('all-projects-btn').addEventListener('click', () => {
            currentProjectView = 'all';
            updateProjectViewButtons();
            renderProjects(allProjects);
            document.getElementById('leaderboard-section').classList.add('hidden');
        });
        document.getElementById('leaderboard-btn').addEventListener('click', () => {
            currentProjectView = 'leaderboard';
            updateProjectViewButtons();
            renderLeaderboard();
            document.getElementById('leaderboard-section').classList.remove('hidden');
        });
        function updateProjectViewButtons() {
            const myBtn = document.getElementById('my-projects-btn');
            const allBtn = document.getElementById('all-projects-btn');
            const leaderBtn = document.getElementById('leaderboard-btn');
            
            // Reset all buttons
            [myBtn, allBtn, leaderBtn].forEach(btn => {
                btn.className = 'project-view-btn bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-semibold';
            });
            
            // Highlight active button
            if (currentProjectView === 'my') {
                myBtn.className = 'project-view-btn bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold ring-2 ring-blue-300';
            } else if (currentProjectView === 'all') {
                allBtn.className = 'project-view-btn bg-green-600 text-white px-4 py-2 rounded-lg font-semibold ring-2 ring-green-300';
            } else if (currentProjectView === 'leaderboard') {
                leaderBtn.className = 'project-view-btn bg-yellow-600 text-white px-4 py-2 rounded-lg font-semibold ring-2 ring-yellow-300';
            }
        }
        function renderLeaderboard() {
            const leaderboardList = document.getElementById('leaderboard-list');
            
            // Calculate user stats
            const userStats = {};
            
            allProjects.forEach(project => {
                if (!userStats[project.user_id]) {
                    userStats[project.user_id] = {
                        projects: 0,
                        totalImpact: 0,
                        categories: new Set()
                    };
                }
                userStats[project.user_id].projects++;
                userStats[project.user_id].totalImpact += project.impact_score || 0;
                userStats[project.user_id].categories.add(project.category);
            });
            
            cityBuildings.forEach(building => {
                if (!userStats[building.user_id]) {
                    userStats[building.user_id] = {
                        projects: 0,
                        totalImpact: 0,
                        categories: new Set(),
                        buildings: 0
                    };
                }
                userStats[building.user_id].buildings = (userStats[building.user_id].buildings || 0) + 1;
            });
            
            // Sort by total impact
            const sortedUsers = Object.entries(userStats)
                .sort(([,a], [,b]) => b.totalImpact - a.totalImpact)
                .slice(0, 10);
            
            if (sortedUsers.length === 0) {
                leaderboardList.innerHTML = '<p class="text-gray-500 text-center py-8">No contributors yet. Be the first!</p>';
                return;
            }
            
            leaderboardList.innerHTML = sortedUsers.map(([userId, stats], index) => {
                const medals = [' ü•á ', ' ü•à ', ' ü•â '];
                const medal = index < 3 ? medals[index] : `#${index + 1}`;
                const isCurrentUser = userId === currentUser;
                
                return `
                    <div class="flex items-center justify-between p-4 rounded-lg ${isCurrentUser ? 'bg-blue-50 border-2 border-blue-200' : 'bg-gray-50'}">
                        <div class="flex items-center gap-4">
                            <div class="text-2xl font-bold">${medal}</div>
                            <div>
                                <h5 class="font-semibold ${isCurrentUser ? 'text-blue-800' : 'text-gray-800'}">${userId} ${isCurrentUser ? '(You)' : ''}</h5>
                                <p class="text-sm text-gray-600">
                                    ${stats.projects} projects ‚Ä¢ ${stats.buildings || 0} buildings ‚Ä¢ ${stats.categories.size} categories
                                </p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xl font-bold text-green-600">${stats.totalImpact}</div>
                            <p class="text-xs text-gray-500">Impact Score</p>
                        </div>
                    </div>
                `;
            }).join('');
        }
        function updateGlobalStats() {
            // Update global project count
            document.getElementById('global-project-count').textContent = allProjects.length;
            
            // Update active users count
            const uniqueUsers = new Set();
            allProjects.forEach(p => uniqueUsers.add(p.user_id));
            cityBuildings.forEach(b => uniqueUsers.add(b.user_id));
            userHistory.forEach(h => uniqueUsers.add(h.user_id));
            document.getElementById('active-users').textContent = uniqueUsers.size;
            
            // Update global buildings count
            document.getElementById('global-buildings').textContent = cityBuildings.length;
            
            // Update total impact
            const totalImpact = allProjects.reduce((sum, p) => sum + (p.impact_score || 0), 0);
            document.getElementById('total-impact').textContent = totalImpact;
        }
        function updateCommunityFeed() {
            const feedContainer = document.getElementById('community-feed');
            
            // Get recent activities
            const recentActivities = [];
            
            // Recent projects
            const recentProjects = allProjects
                .filter(p => p.shared === 'true' || p.shared === true)
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                .slice(0, 3);
            
            recentProjects.forEach(project => {
                recentActivities.push({
                    type: 'project',
                    user: project.user_id,
                    action: `created project "${project.project_name}"`,
                    time: new Date(project.created_at),
                    icon: ' üß™ '
                });
            });
            
            // Recent city contributions
            const recentBuildings = cityBuildings
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                .slice(0, 3);
            
            recentBuildings.forEach(building => {
                recentActivities.push({
                    type: 'building',
                    user: building.user_id,
                    action: `added ${building.building_name} to the city`,
                    time: new Date(building.created_at),
                    icon: ' üèóÔ∏è '
                });
            });
            
            // Sort by time and take most recent
            recentActivities.sort((a, b) => b.time - a.time);
            const displayActivities = recentActivities.slice(0, 4);
            
            if (displayActivities.length === 0) {
                feedContainer.innerHTML = `
                    <div class="announcement-card p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-800"> üåç  Global Collaboration</h4>
                        <p class="text-sm text-gray-600 mt-1">Share your projects and see what others are building!</p>
                    </div>
                    <div class="announcement-card p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-800"> üèôÔ∏è  Community City</h4>
                        <p class="text-sm text-gray-600 mt-1">Build a sustainable city together with users worldwide.</p>
                    </div>
                `;
                return;
            }
            
            feedContainer.innerHTML = displayActivities.map(activity => `
                <div class="announcement-card p-4 rounded-lg">
                    <h4 class="font-semibold text-gray-800">${activity.icon} ${activity.user}</h4>
                    <p class="text-sm text-gray-600 mt-1">${activity.action}</p>
                    <p class="text-xs text-gray-400 mt-1">${activity.time.toLocaleString()}</p>
                </div>
            `).join('');
        }
        // IoT Sensor Functions
        function initializeSensorCharts() {
            Object.keys(sensorConfig).forEach(sensorType => {
                sensorCharts[sensorType] = [];
            });
        }
        function generateSensorReading(sensorType) {
            const config = sensorConfig[sensorType];
            const baseValue = (config.min + config.max) / 2;
            const range = (config.max - config.min) / 4;
            
            // Add some realistic variation and trends
            let value = baseValue + (Math.random() - 0.5) * range;
            
            // Add time-based patterns
            const hour = new Date().getHours();
            if (sensorType === 'temperature') {
                value += Math.sin((hour - 6) * Math.PI / 12) * 3; // Daily temperature cycle
            } else if (sensorType === 'light') {
                value = hour >= 6 && hour <= 18 ? 
                    config.min + (config.max - config.min) * Math.sin((hour - 6) * Math.PI / 12) :
                    config.min * 0.1; // Night/day cycle
            } else if (sensorType === 'humidity') {
                value += Math.sin((hour - 12) * Math.PI / 12) * -5; // Inverse temperature correlation
            }
            
            return Math.max(config.min, Math.min(config.max, value));
        }
        function updateSensorDisplay(sensorType, value) {
            const config = sensorConfig[sensorType];
            const elementId = sensorType.replace('_', '-');
            
            // Update value display
            document.getElementById(`${elementId}-value`).textContent = 
                value.toFixed(sensorType === 'ph' ? 2 : 1) + config.unit;
            
            // Update status indicator
            const statusElement = document.getElementById(`${elementId}-status`);
            const isNormal = Math.abs(value - (config.min + config.max) / 2) <= config.threshold;
            
            statusElement.className = `w-3 h-3 rounded-full ${
                isNormal ? 'sensor-status-online' : 'sensor-status-warning'
            }`;
            
            // Update chart
            updateSensorChart(sensorType, value);
            
            // Check for alerts
            checkSensorAlert(sensorType, value);
        }
        function updateSensorChart(sensorType, value) {
            const config = sensorConfig[sensorType];
            
            // Initialize chart data if not exists
            if (!sensorCharts[sensorType]) {
                sensorCharts[sensorType] = [];
            }
            
            const chartData = sensorCharts[sensorType];
            
            // Add new data point
            chartData.push({
                timestamp: Date.now(),
                value: value
            });
            
            // Keep only last 20 points
            if (chartData.length > 20) {
                chartData.shift();
            }
            
            // Update SVG chart
            const elementId = sensorType.replace('_', '-');
            const lineElement = document.getElementById(`${elementId}-line`);
            const areaElement = document.getElementById(`${elementId}-area`);
            
            if (lineElement && chartData.length > 1) {
                // Create path for line
                const linePoints = chartData.map((point, index) => {
                    const x = (index / (chartData.length - 1)) * 280 + 10; // Add padding
                    const normalizedValue = Math.max(0, Math.min(1, (point.value - config.min) / (config.max - config.min)));
                    const y = 140 - (normalizedValue * 120) + 5; // Invert Y and add padding
                    return `${x},${y}`;
                });
                
                const linePath = `M${linePoints.join(' L')}`;
                lineElement.setAttribute('d', linePath);
                
                // Update area if exists
                if (areaElement) {
                    const areaPath = `${linePath} L${280 + 10},140 L10,140 Z`;
                    areaElement.setAttribute('d', areaPath);
                }
                
                // Add data points
                const svg = lineElement.closest('svg');
                // Remove existing points
                svg.querySelectorAll('.data-point').forEach(point => point.remove());
                
                // Add new points
                chartData.forEach((point, index) => {
                    if (index % 3 === 0) { // Show every 3rd point to avoid clutter
                        const x = (index / (chartData.length - 1)) * 280 + 10;
                        const normalizedValue = Math.max(0, Math.min(1, (point.value - config.min) / (config.max - config.min)));
                        const y = 140 - (normalizedValue * 120) + 5;
                        
                        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                        circle.setAttribute('cx', x);
                        circle.setAttribute('cy', y);
                        circle.setAttribute('r', 2);
                        circle.setAttribute('fill', config.color);
                        circle.setAttribute('class', 'data-point');
                        svg.appendChild(circle);
                    }
                });
            }
        }
        function checkSensorAlert(sensorType, value) {
            const config = sensorConfig[sensorType];
            const normalRange = (config.min + config.max) / 2;
            const isOutOfRange = Math.abs(value - normalRange) > config.threshold;
            
            if (isOutOfRange) {
                const alertType = value > normalRange ? 'high' : 'low';
                addAlert(sensorType, value, alertType);
            }
        }
        function addAlert(sensorType, value, type) {
            const alertsContainer = document.getElementById('alerts-container');
            const config = sensorConfig[sensorType];
            
            // Remove "no alerts" message
            if (alertsContainer.querySelector('p')) {
                alertsContainer.innerHTML = '';
            }
            
            const alertElement = document.createElement('div');
            alertElement.className = `alert-${type === 'high' ? 'high' : 'low'} p-4 rounded-lg`;
            alertElement.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <h5 class="font-semibold">${getSensorIcon(sensorType)} ${getSensorName(sensorType)} Alert</h5>
                        <p class="text-sm">Value: ${value.toFixed(1)}${config.unit} - ${type === 'high' ? 'Above' : 'Below'} normal range</p>
                        <p class="text-xs text-gray-500">${new Date().toLocaleTimeString()}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove(); updateAlertCount();" class="text-gray-500 hover:text-gray-700">√ó</button>
                </div>
            `;
            
            alertsContainer.appendChild(alertElement);
            alertCount++;
            updateAlertCount();
        }
        function getSensorIcon(sensorType) {
            const icons = {
                temperature: ' üå°Ô∏è ',
                humidity: ' üíß ',
                air_quality: ' üå¨Ô∏è ',
                ph: ' ‚öóÔ∏è ',
                light: ' ‚òÄÔ∏è ',
                soil_moisture: ' üå± '
            };
            return icons[sensorType] || ' üìä ';
        }
        function getSensorName(sensorType) {
            const names = {
                temperature: 'Temperature',
                humidity: 'Humidity',
                air_quality: 'Air Quality',
                ph: 'Water pH',
                light: 'Light Intensity',
                soil_moisture: 'Soil Moisture'
            };
            return names[sensorType] || sensorType;
        }
        function updateAlertCount() {
            const alertElements = document.querySelectorAll('#alerts-container > div');
            alertCount = alertElements.length;
            
            if (alertCount === 0) {
                document.getElementById('alerts-container').innerHTML = 
                    '<p class="text-gray-500 text-center py-4">No active alerts. All systems normal.</p>';
            }
        }
        // Sensor Control Event Listeners
        document.getElementById('start-monitoring').addEventListener('click', () => {
            if (!isMonitoring) {
                isMonitoring = true;
                document.getElementById('connection-status').className = 'w-3 h-3 rounded-full sensor-status-online';
                document.getElementById('connection-text').textContent = translations[currentLanguage].sensorsOnline;
                
                // Update all sensor statuses
                Object.keys(sensorConfig).forEach(sensorType => {
                    const elementId = sensorType.replace('_', '-');
                    document.getElementById(`${elementId}-status`).className = 'w-3 h-3 rounded-full sensor-status-online';
                });
                
                // Start monitoring interval
                monitoringInterval = setInterval(() => {
                    Object.keys(sensorConfig).forEach(sensorType => {
                        const value = generateSensorReading(sensorType);
                        updateSensorDisplay(sensorType, value);
                    });
                    
                    document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
                }, 2000); // Update every 2 seconds
                
                showToast(currentLanguage === 'en' ? 'Sensor monitoring started' : 'Sens√∂r izleme ba≈ülatƒ±ldƒ±', 'success');
            }
        });
        document.getElementById('stop-monitoring').addEventListener('click', () => {
            if (isMonitoring) {
                isMonitoring = false;
                clearInterval(monitoringInterval);
                
                document.getElementById('connection-status').className = 'w-3 h-3 rounded-full sensor-status-offline';
                document.getElementById('connection-text').textContent = translations[currentLanguage].sensorsOffline;
                
                // Update all sensor statuses
                Object.keys(sensorConfig).forEach(sensorType => {
                    const elementId = sensorType.replace('_', '-');
                    document.getElementById(`${elementId}-status`).className = 'w-3 h-3 rounded-full sensor-status-offline';
                });
                
                showToast(currentLanguage === 'en' ? 'Sensor monitoring stopped' : 'Sens√∂r izleme durduruldu', 'info');
            }
        });
        document.getElementById('save-sensor-data').addEventListener('click', async () => {
            if (sensorCharts && Object.keys(sensorCharts).length > 0) {
                if (sensorData.length >= 999) {
                    const message = currentLanguage === 'en' ? 'Maximum limit of 999 sensor records reached. Please delete some data first.' : 'Maksimum 999 sens√∂r kaydƒ± sƒ±nƒ±rƒ±na ula≈üƒ±ldƒ±. L√ºtfen √∂nce bazƒ± verileri silin.';
                    showToast(message, 'error');
                    return;
                }
                
                const btn = document.getElementById('save-sensor-data');
                btn.disabled = true;
                btn.innerHTML = '<span class="loading-spinner"></span>' + (currentLanguage === 'en' ? 'Saving...' : 'Kaydediliyor...');
                
                const timestamp = new Date().toISOString();
                const sensorReading = {
                    id: Date.now().toString(),
                    user_id: currentUser,
                    sensor_type: 'environmental_reading',
                    timestamp: timestamp,
                    temperature: document.getElementById('temp-value').textContent,
                    humidity: document.getElementById('humidity-value').textContent,
                    air_quality: document.getElementById('air-value').textContent,
                    ph: document.getElementById('ph-value').textContent,
                    light: document.getElementById('light-value').textContent,
                    soil_moisture: document.getElementById('soil-value').textContent,
                    location: currentLocation
                };
                
                const result = await window.dataSdk.create(sensorReading);
                
                btn.disabled = false;
                btn.innerHTML = ' üíæ  ' + (currentLanguage === 'en' ? 'Save Data' : 'Veriyi Kaydet');
                
                if (result.isOk) {
                    const message = currentLanguage === 'en' ? 'Sensor data saved successfully!' : 'Sens√∂r verisi ba≈üarƒ±yla kaydedildi!';
                    showToast(message, 'success');
                    
                    // Add to user history
                    addToUserHistory('sensor_reading', 'Saved environmental sensor data');
                } else {
                    const message = currentLanguage === 'en' ? 'Failed to save sensor data' : 'Sens√∂r verisi kaydedilemedi';
                    showToast(message, 'error');
                }
            } else {
                const message = currentLanguage === 'en' ? 'No sensor data to save. Start monitoring first.' : 'Kaydedilecek sens√∂r verisi yok. √ñnce izlemeyi ba≈ülatƒ±n.';
                showToast(message, 'warning');
            }
        });
        // Data Export Functions
        document.getElementById('export-csv').addEventListener('click', () => {
            if (sensorData.length === 0) {
                showToast(currentLanguage === 'en' ? 'No sensor data to export' : 'Dƒ±≈üa aktarƒ±lacak sens√∂r verisi yok', 'warning');
                return;
            }
            
            const csvContent = generateCSV(sensorData);
            downloadCSV(csvContent, 'sensor_data.csv');
            showToast(currentLanguage === 'en' ? 'CSV exported successfully' : 'CSV ba≈üarƒ±yla dƒ±≈üa aktarƒ±ldƒ±', 'success');
        });
        document.getElementById('clear-data').addEventListener('click', async () => {
            if (sensorData.length === 0) {
                showToast(currentLanguage === 'en' ? 'No sensor data to clear' : 'Temizlenecek sens√∂r verisi yok', 'warning');
                return;
            }
            
            const btn = document.getElementById('clear-data');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>' + (currentLanguage === 'en' ? 'Clearing...' : 'Temizleniyor...');
            
            // Delete all sensor data
            for (const record of sensorData) {
                await window.dataSdk.delete(record);
            }
            
            btn.disabled = false;
            btn.innerHTML = ' üóëÔ∏è  ' + (currentLanguage === 'en' ? 'Clear Data' : 'Veriyi Temizle');
            
            showToast(currentLanguage === 'en' ? 'All sensor data cleared' : 'T√ºm sens√∂r verisi temizlendi', 'success');
        });
        document.getElementById('generate-report').addEventListener('click', () => {
            generateSensorReport();
        });
        function generateCSV(data) {
            const headers = ['Timestamp', 'User', 'Location', 'Temperature', 'Humidity', 'Air Quality', 'pH', 'Light', 'Soil Moisture'];
            const rows = data.map(record => [
                record.timestamp,
                record.user_id,
                record.location,
                record.temperature,
                record.humidity,
                record.air_quality,
                record.ph,
                record.light,
                record.soil_moisture
            ]);
            
            return [headers, ...rows].map(row => row.join(',')).join('\n');
        }
        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        function generateSensorReport() {
            const reportContent = `
                <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px;">
                    <h1>STEMCycle G2B - Environmental Sensor Report</h1>
                    <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
                    <p><strong>User:</strong> ${currentUser}</p>
                    <p><strong>Location:</strong> ${currentLocation}</p>
                    
                    <h2>Current Sensor Status</h2>
                    <table border="1" style="width: 100%; border-collapse: collapse;">
                        <tr>
                            <th>Sensor</th>
                            <th>Current Value</th>
                            <th>Status</th>
                        </tr>
                        ${Object.keys(sensorConfig).map(sensorType => {
                            const elementId = sensorType.replace('_', '-');
                            const value = document.getElementById(`${elementId}-value`).textContent;
                            return `<tr>
                                <td>${getSensorName(sensorType)}</td>
                                <td>${value}</td>
                                <td>${isMonitoring ? 'Online' : 'Offline'}</td>
                            </tr>`;
                        }).join('')}
                    </table>
                    
                    <h2>System Summary</h2>
                    <ul>
                        <li>Total Projects: ${allProjects.length}</li>
                        <li>Sensor Records: ${sensorData.length}</li>
                        <li>Active Alerts: ${alertCount}</li>
                        <li>Monitoring Status: ${isMonitoring ? 'Active' : 'Inactive'}</li>
                    </ul>
                </div>
            `;
            
            const newWindow = window.open('', '_blank');
            newWindow.document.write(reportContent);
            newWindow.document.close();
            
            showToast(currentLanguage === 'en' ? 'Report generated successfully' : 'Rapor ba≈üarƒ±yla olu≈üturuldu', 'success');
        }
        // Difficulty Selection
        document.querySelectorAll('.difficulty-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('ring-2', 'ring-white'));
                btn.classList.add('ring-2', 'ring-white');
                selectedDifficulty = btn.dataset.level;
            });
        });
        // Drag and Drop for Lab Modules
        document.getElementById('module-palette').addEventListener('click', (e) => {
            const template = e.target.closest('.module-template');
            if (!template) return;
            
            const moduleType = template.dataset.module;
            const moduleName = template.dataset.name;
            const moduleDesc = template.dataset.desc;
            const canvas = document.getElementById('kit-canvas');
            
            const newModule = document.createElement('div');
            newModule.className = `module ${template.className.replace('module-template', '').replace('cursor-pointer', '')} shadow-lg border-2 border-white`;
            newModule.innerHTML = `
                <div class="text-2xl mb-1">${template.querySelector('.text-2xl').textContent}</div>
                <div class="text-xs font-semibold">${template.querySelector('.text-xs').textContent}</div>
                <div class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs cursor-pointer opacity-0 hover:opacity-100 transition-opacity" onclick="removeModule(this)">√ó</div>
            `;
            newModule.dataset.module = moduleType;
            newModule.dataset.name = moduleName;
            newModule.dataset.desc = moduleDesc;
            newModule.style.position = 'absolute';
            newModule.style.left = Math.random() * 200 + 20 + 'px';
            newModule.style.top = Math.random() * 150 + 20 + 'px';
            newModule.style.width = '100px';
            newModule.style.height = '80px';
            newModule.style.zIndex = '10';
            
            canvas.appendChild(newModule);
            canvasModules.push(newModule);
            
            setupDragging(newModule);
            showToast(`${moduleName} added to canvas!`, 'success');
        });
        function removeModule(btn) {
            const module = btn.closest('.module');
            const index = canvasModules.indexOf(module);
            if (index > -1) {
                canvasModules.splice(index, 1);
            }
            module.remove();
        }
        function setupDragging(element) {
            let isDragging = false;
            
            element.addEventListener('mousedown', (e) => {
                if (e.target.textContent === '√ó') return;
                startDrag(e, element);
            });
            
            element.addEventListener('touchstart', (e) => {
                if (e.target.textContent === '√ó') return;
                startDrag(e, element);
            });
        }
        function startDrag(e, element) {
            e.preventDefault();
            draggedElement = element;
            draggedElement.classList.add('dragging');
            draggedElement.style.zIndex = '1000';
            
            const rect = draggedElement.getBoundingClientRect();
            const canvas = document.getElementById('kit-canvas');
            const canvasRect = canvas.getBoundingClientRect();
            
            const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
            const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
            
            offsetX = clientX - rect.left;
            offsetY = clientY - rect.top;
            
            function handleMove(e) {
                if (!draggedElement) return;
                
                const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
                const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
                
                let newX = clientX - canvasRect.left - offsetX;
                let newY = clientY - canvasRect.top - offsetY;
                
                newX = Math.max(0, Math.min(newX, canvasRect.width - draggedElement.offsetWidth));
                newY = Math.max(0, Math.min(newY, canvasRect.height - draggedElement.offsetHeight));
                
                draggedElement.style.left = newX + 'px';
                draggedElement.style.top = newY + 'px';
            }
            
            function handleEnd() {
                if (draggedElement) {
                    draggedElement.classList.remove('dragging');
                    draggedElement.style.zIndex = '10';
                    draggedElement = null;
                }
                document.removeEventListener('mousemove', handleMove);
                document.removeEventListener('touchmove', handleMove);
                document.removeEventListener('mouseup', handleEnd);
                document.removeEventListener('touchend', handleEnd);
            }
            
            document.addEventListener('mousemove', handleMove);
            document.addEventListener('touchmove', handleMove);
            document.addEventListener('mouseup', handleEnd);
            document.addEventListener('touchend', handleEnd);
        }
        // Clear Canvas
        document.getElementById('clear-canvas-btn').addEventListener('click', () => {
            const canvas = document.getElementById('kit-canvas');
            canvas.innerHTML = '';
            canvasModules = [];
        });
        // Save Project
        document.getElementById('save-project-btn').addEventListener('click', async () => {
            const projectName = document.getElementById('project-name').value.trim();
            const projectDescription = document.getElementById('project-description').value.trim();
            const projectCategory = document.getElementById('project-category').value;
            const shareProject = document.getElementById('share-project').checked;
            
            if (!projectName) {
                const message = currentLanguage === 'en' ? 'Please enter a project name' : 'L√ºtfen bir proje adƒ± girin';
                showToast(message, 'error');
                return;
            }
            
            if (canvasModules.length === 0) {
                const message = currentLanguage === 'en' ? 'Please add some modules to your project' : 'L√ºtfen projenize mod√ºl ekleyin';
                showToast(message, 'error');
                return;
            }
            
            if (allProjects.length >= 999) {
                const message = currentLanguage === 'en' ? 'Maximum limit of 999 projects reached. Please delete some projects first.' : 'Maksimum 999 proje sƒ±nƒ±rƒ±na ula≈üƒ±ldƒ±. L√ºtfen √∂nce bazƒ± projeleri silin.';
                showToast(message, 'error');
                return;
            }
            
            const btn = document.getElementById('save-project-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>' + (currentLanguage === 'en' ? 'Saving...' : 'Kaydediliyor...');
            
            const modulesData = canvasModules.map(m => ({
                type: m.dataset.module,
                name: m.dataset.name,
                description: m.dataset.desc,
                x: m.style.left,
                y: m.style.top
            }));
            
            // Calculate impact score based on modules and difficulty
            let impactScore = canvasModules.length * 10;
            if (selectedDifficulty === 'intermediate') impactScore *= 1.5;
            if (selectedDifficulty === 'advanced') impactScore *= 2;
            
            const projectData = {
                id: Date.now().toString(),
                user_id: currentUser,
                project_name: projectName,
                description: projectDescription || `${translations[currentLanguage].category}: ${translations[currentLanguage][projectCategory.replace(' ', '')]} - ${canvasModules.length} modules`,
                modules: JSON.stringify(modulesData),
                created_at: new Date().toISOString(),
                status: 'active',
                category: projectCategory,
                difficulty: selectedDifficulty,
                impact_score: Math.round(impactScore),
                shared: shareProject.toString(),
                location: currentLocation
            };
            
            const result = await window.dataSdk.create(projectData);
            
            btn.disabled = false;
            btn.innerHTML = ' üíæ  ' + (currentLanguage === 'en' ? 'Save Project' : 'Projeyi Kaydet');
            
            if (result.isOk) {
                const message = currentLanguage === 'en' ? 'Project saved successfully!' : 'Proje ba≈üarƒ±yla kaydedildi!';
                showToast(message, 'success');
                
                // Add to user history
                const historyMessage = shareProject ? 
                    `Created and shared project: ${projectName}` : 
                    `Created project: ${projectName}`;
                addToUserHistory('project_created', historyMessage);
                
                document.getElementById('project-name').value = '';
                document.getElementById('project-description').value = '';
                document.getElementById('share-project').checked = false;
                document.getElementById('kit-canvas').innerHTML = '';
                canvasModules = [];
                
                // Reset difficulty selection
                document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('ring-2', 'ring-white'));
                document.querySelector('[data-level="beginner"]').classList.add('ring-2', 'ring-white');
                selectedDifficulty = 'beginner';
            } else {
                const message = currentLanguage === 'en' ? 'Failed to save project. Please try again.' : 'Proje kaydedilemedi. L√ºtfen tekrar deneyin.';
                showToast(message, 'error');
            }
        });
        // Render Projects
        function renderProjects(projects) {
            const container = document.getElementById('projects-list');
            
            // Filter projects based on current view
            const filteredProjects = currentProjectView === 'my' 
                ? projects.filter(p => p.user_id === currentUser)
                : projects.filter(p => p.shared === 'true' || p.shared === true || p.user_id === currentUser);
            
            // Update project stats
            updateProjectStats(projects);
            
            if (filteredProjects.length === 0) {
                const message = currentProjectView === 'my' 
                    ? (currentLanguage === 'en' ? 'No projects yet. Create one in the Virtual Lab!' : 'Hen√ºz proje yok. Sanal Laboratuvarda bir tane olu≈üturun!')
                    : (currentLanguage === 'en' ? 'No community projects yet. Be the first to share!' : 'Hen√ºz topluluk projesi yok. ƒ∞lk payla≈üan siz olun!');
                container.innerHTML = `<p class="text-gray-500 text-center py-8">${message}</p>`;
                return;
            }
            
            container.innerHTML = filteredProjects.map(project => {
                const modules = JSON.parse(project.modules || '[]');
                const difficultyColors = {
                    beginner: 'bg-green-100 text-green-800',
                    intermediate: 'bg-yellow-100 text-yellow-800',
                    advanced: 'bg-red-100 text-red-800'
                };
                const difficultyIcons = {
                    beginner: ' üå± ',
                    intermediate: ' ‚ö° ',
                    advanced: ' üöÄ '
                };
                
                const isMyProject = project.user_id === currentUser;
                const isShared = project.shared === 'true' || project.shared === true;
                
                return `
                    <div class="project-card p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow ${isMyProject ? 'my-project' : 'community-project'}">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <h4 class="text-xl font-bold text-gray-800">${project.project_name}</h4>
                                    <span class="px-2 py-1 rounded-full text-xs font-semibold ${difficultyColors[project.difficulty] || difficultyColors.beginner}">
                                        ${difficultyIcons[project.difficulty] || ' üå± '} ${project.difficulty || 'beginner'}
                                    </span>
                                    ${isShared ? '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold"> üåç  Shared</span>' : ''}
                                    ${!isMyProject ? '<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-semibold"> üë§  Community</span>' : ''}
                                </div>
                                <p class="text-sm text-gray-600 mb-2">${project.description}</p>
                                <div class="flex items-center gap-4 text-xs text-gray-500">
                                    <span> üë§  ${project.user_id}</span>
                                    <span> üìÖ  ${new Date(project.created_at).toLocaleDateString()}</span>
                                    <span> üß™  ${modules.length} modules</span>
                                    <span> üìä  Impact: ${project.impact_score || 0}</span>
                                    <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded">${project.category || 'general'}</span>
                                    ${project.location ? `<span> üìç  ${project.location}</span>` : ''}
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button class="view-project-btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-semibold" data-id="${project.__backendId}">
                                     üëÅÔ∏è  ${currentLanguage === 'en' ? 'View' : 'G√∂r√ºnt√ºle'}
                                </button>
                                ${isMyProject ? `
                                    <button class="delete-project-btn bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-semibold" data-id="${project.__backendId}">
                                         üóëÔ∏è  ${currentLanguage === 'en' ? 'Delete' : 'Sil'}
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- Module Preview -->
                        <div class="border-t pt-3">
                            <p class="text-xs text-gray-500 mb-2">${currentLanguage === 'en' ? 'Modules:' : 'Mod√ºller:'}</p>
                            <div class="flex flex-wrap gap-1">
                                ${modules.slice(0, 6).map(module => `
                                    <span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs" title="${module.description || module.name}">
                                        ${module.name || module.type}
                                    </span>
                                `).join('')}
                                ${modules.length > 6 ? `<span class="px-2 py-1 bg-gray-200 text-gray-600 rounded text-xs">+${modules.length - 6} more</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add event listeners
            container.querySelectorAll('.delete-project-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const projectId = e.target.dataset.id;
                    const project = projects.find(p => p.__backendId === projectId);
                    
                    if (!project) return;
                    
                    e.target.disabled = true;
                    e.target.innerHTML = '<span class="loading-spinner"></span>' + (currentLanguage === 'en' ? 'Deleting...' : 'Siliniyor...');
                    
                    const result = await window.dataSdk.delete(project);
                    
                    if (result.isOk) {
                        const message = currentLanguage === 'en' ? 'Project deleted successfully' : 'Proje ba≈üarƒ±yla silindi';
                        showToast(message, 'success');
                    } else {
                        const message = currentLanguage === 'en' ? 'Failed to delete project' : 'Proje silinemedi';
                        showToast(message, 'error');
                        e.target.disabled = false;
                        e.target.innerHTML = ' üóëÔ∏è  ' + (currentLanguage === 'en' ? 'Delete' : 'Sil');
                    }
                });
            });
            
            container.querySelectorAll('.view-project-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const projectId = e.target.dataset.id;
                    const project = projects.find(p => p.__backendId === projectId);
                    
                    if (!project) return;
                    
                    // Switch to Virtual Lab tab and load project
                    document.querySelectorAll('.tab-btn')[1].click();
                    loadProjectToCanvas(project);
                });
            });
        }
        function updateProjectStats(projects) {
            const myProjects = projects.filter(p => p.user_id === currentUser);
            const sharedProjects = projects.filter(p => p.shared === 'true' || p.shared === true);
            const uniqueContributors = [...new Set(projects.map(p => p.user_id))];
            const avgImpact = projects.length > 0 ? 
                Math.round(projects.reduce((sum, p) => sum + (p.impact_score || 0), 0) / projects.length) : 0;
            
            document.getElementById('my-project-count').textContent = myProjects.length;
            document.getElementById('community-project-count').textContent = sharedProjects.length;
            document.getElementById('total-contributors').textContent = uniqueContributors.length;
            document.getElementById('avg-impact-score').textContent = avgImpact;
        }
        
        function loadProjectToCanvas(project) {
            // Clear current canvas
            document.getElementById('kit-canvas').innerHTML = '';
            canvasModules = [];
            
            // Load project data
            const modules = JSON.parse(project.modules || '[]');
            const canvas = document.getElementById('kit-canvas');
            
            modules.forEach(moduleData => {
                const newModule = document.createElement('div');
                const colors = {
                    sensor: 'bg-blue-500',
                    filter: 'bg-green-500',
                    analyzer: 'bg-yellow-500',
                    monitor: 'bg-purple-500',
                    pump: 'bg-red-500',
                    ai: 'bg-indigo-500'
                };
                
                newModule.className = `module ${colors[moduleData.type] || 'bg-gray-500'} text-white p-3 rounded-lg text-center shadow-lg border-2 border-white`;
                newModule.innerHTML = `
                    <div class="text-2xl mb-1">${getModuleIcon(moduleData.type)}</div>
                    <div class="text-xs font-semibold">${moduleData.name || moduleData.type}</div>
                    <div class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs cursor-pointer opacity-0 hover:opacity-100 transition-opacity" onclick="removeModule(this)">√ó</div>
                `;
                newModule.dataset.module = moduleData.type;
                newModule.dataset.name = moduleData.name;
                newModule.dataset.desc = moduleData.description;
                newModule.style.position = 'absolute';
                newModule.style.left = moduleData.x;
                newModule.style.top = moduleData.y;
                newModule.style.width = '100px';
                newModule.style.height = '80px';
                newModule.style.zIndex = '10';
                
                canvas.appendChild(newModule);
                canvasModules.push(newModule);
                setupDragging(newModule);
            });
            
            // Fill project details
            document.getElementById('project-name').value = project.project_name;
            document.getElementById('project-description').value = project.description;
            document.getElementById('project-category').value = project.category || 'water';
            document.getElementById('share-project').checked = project.shared === 'true' || project.shared === true;
            
            // Set difficulty
            document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('ring-2', 'ring-white'));
            document.querySelector(`[data-level="${project.difficulty || 'beginner'}"]`).classList.add('ring-2', 'ring-white');
            selectedDifficulty = project.difficulty || 'beginner';
            
            const message = currentLanguage === 'en' ? `Project "${project.project_name}" loaded to canvas!` : `"${project.project_name}" projesi tuvale y√ºklendi!`;
            showToast(message, 'success');
        }
        
        function getModuleIcon(type) {
            const icons = {
                sensor: ' üíß ',
                filter: ' üå± ',
                analyzer: ' ‚öóÔ∏è ',
                monitor: ' üìä ',
                pump: ' ‚òÄÔ∏è ',
                ai: ' ü§ñ '
            };
            return icons[type] || ' üîß ';
        }
        // Update Project Count
        function updateProjectCount(count) {
            // This function is kept for compatibility but stats are now updated in updateProjectStats
        }
        // City Building Functions
        function initializeCityCanvas() {
            cityCanvas = document.getElementById('city-canvas');
            if (!cityCanvas) return;
            
            // Add building palette click handlers
            document.getElementById('building-palette').addEventListener('click', (e) => {
                const template = e.target.closest('.building-template');
                if (!template) return;
                
                addBuildingToCity(template);
            });
            
            // City control buttons
            document.getElementById('save-city-btn').addEventListener('click', saveCityContribution);
            document.getElementById('refresh-city-btn').addEventListener('click', refreshCity);

            // Hava durumu butonlarƒ± i√ßin olay dinleyicisi
            document.querySelectorAll('.weather-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    updateWeather(e.currentTarget.dataset.weather);
                });
            });

            // Ba≈ülangƒ±√ßta g√ºne≈üli olarak ayarla
            updateWeather('sunny');
        }

        // YENI: Hava Durumu G√ºncelleme Fonksiyonu
        function updateWeather(weatherType) {
            const svg = document.querySelector('#city-canvas svg');
            if (!svg) return;

            const skyGradient = svg.querySelector('#skyGradient');
            const sun = svg.querySelector('#sun-group');
            const rainOverlay = document.getElementById('rain-overlay'); // Yaƒümur efekti i√ßin overlay (CSS ile eklenebilir)

            // 1. G√∂ky√ºz√º ve G√ºne≈ü/Bulut Ayarlarƒ±
            if (weatherType === 'sunny') {
                // G√ºne≈üli: Parlak, Canlƒ± G√∂ky√ºz√º
                skyGradient.querySelector('stop:nth-child(1)').style.stopColor = '#87CEEB'; // Mavi
                skyGradient.querySelector('stop:nth-child(2)').style.stopColor = '#E0F6FF'; // A√ßƒ±k Mavi
                if (sun) sun.style.display = 'block';
                document.querySelectorAll('.moving-cloud').forEach(cloud => cloud.style.fill = '#FFFFFF');
                if (rainOverlay) rainOverlay.style.display = 'none';
            } else if (weatherType === 'cloudy') {
                // Bulutlu: Yumu≈üak, Sakin Atmosfer
                skyGradient.querySelector('stop:nth-child(1)').style.stopColor = '#B0BEC5'; // Gri
                skyGradient.querySelector('stop:nth-child(2)').style.stopColor = '#CFD8DC'; // A√ßƒ±k Gri
                if (sun) sun.style.display = 'block'; 
                document.querySelectorAll('.moving-cloud').forEach(cloud => cloud.style.fill = '#ECEFF1');
                if (rainOverlay) rainOverlay.style.display = 'none';
            } else if (weatherType === 'rainy') {
                // Yaƒümurlu: Ger√ßek√ßi Yaƒümur Efektleri (basit√ße renk deƒüi≈üimi)
                skyGradient.querySelector('stop:nth-child(1)').style.stopColor = '#607D8B'; // Koyu Gri
                skyGradient.querySelector('stop:nth-child(2)').style.stopColor = '#90A4AE'; // Orta Gri
                if (sun) sun.style.display = 'none'; // G√ºne≈üi gizle
                document.querySelectorAll('.moving-cloud').forEach(cloud => cloud.style.fill = '#B0BEC5');
                if (rainOverlay) rainOverlay.style.display = 'block';
            }

            // 2. Buton Aktif Durumunu G√ºncelle
            document.querySelectorAll('.weather-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-offset-2', 'ring-white');
            });
            document.querySelector(`[data-weather="${weatherType}"]`).classList.add('ring-2', 'ring-offset-2', 'ring-white');

            currentWeather = weatherType;
        }
        
        function addBuildingToCity(template) {
            const buildingType = template.dataset.building;
            const buildingName = template.dataset.name;
            const buildingDesc = template.dataset.desc;
            const buildingCategory = template.dataset.category;
            
            // Get the building placement area (the div inside city-canvas)
            const buildingArea = cityCanvas.querySelector('div[style*="top: 300px"]') || cityCanvas;
            
            const newBuilding = document.createElement('div');
            // city-building sƒ±nƒ±fƒ± 3D efektleri ve gradientleri i√ßerir
            newBuilding.className = `city-building ${template.className.replace('building-template', '').replace('cursor-pointer', '').replace('transform', '').replace('transition-all', '')} shadow-lg border-2 border-white`;
            newBuilding.innerHTML = `
                <div class="text-2xl mb-1">${template.querySelector('.text-2xl').textContent}</div>
                <div class="text-xs font-semibold">${template.querySelector('.text-xs').textContent}</div>
                <div class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs cursor-pointer opacity-0 hover:opacity-100 transition-opacity" onclick="removeCityBuilding(this)">√ó</div>
                <div class="absolute -bottom-6 left-0 right-0 text-center">
                    <div class="bg-black bg-opacity-75 text-white text-xs px-2 py-1 rounded opacity-0 hover:opacity-100 transition-opacity">
                        ${currentUser}
                    </div>
                </div>
            `;
            newBuilding.dataset.building = buildingType;
            newBuilding.dataset.name = buildingName;
            newBuilding.dataset.desc = buildingDesc;
            newBuilding.dataset.category = buildingCategory;
            newBuilding.dataset.owner = currentUser;
            newBuilding.style.position = 'absolute';
            newBuilding.style.left = Math.random() * 600 + 50 + 'px';
            newBuilding.style.top = Math.random() * 150 + 20 + 'px';
            newBuilding.style.width = '80px';
            newBuilding.style.height = '70px';
            newBuilding.style.zIndex = '10';
            
            buildingArea.appendChild(newBuilding);
            setupCityBuildingDragging(newBuilding);
            
            // Add to user history
            addToUserHistory('building_added', `Added ${buildingName} to the global city`);
            
            showToast(`${buildingName} added to the global city!`, 'success');
        }
        
        function removeCityBuilding(btn) {
            const building = btn.closest('.city-building');
            const buildingName = building.dataset.name;
            const owner = building.dataset.owner;
            
            // Only allow removal of own buildings
            if (owner === currentUser) {
                // Delete from cityBuildings array if possible (currently only renders existing, needs a more complex structure for deletion before saving)
                building.remove();
                addToUserHistory('building_removed', `Removed ${buildingName} from the city`);
                showToast(`${buildingName} removed from the city`, 'info');
            } else {
                showToast(`You can only remove your own buildings`, 'error');
            }
        }
        
        function setupCityBuildingDragging(element) {
            element.addEventListener('mousedown', (e) => {
                if (e.target.textContent === '√ó') return;
                startCityDrag(e, element);
            });
            
            element.addEventListener('touchstart', (e) => {
                if (e.target.textContent === '√ó') return;
                startCityDrag(e, element);
            });
        }
        
        function startCityDrag(e, element) {
            // Only allow dragging own buildings
            if (element.dataset.owner !== currentUser) {
                showToast('You can only move your own buildings', 'error');
                return;
            }
            
            e.preventDefault();
            cityDraggedElement = element;
            cityDraggedElement.style.zIndex = '1000';
            cityDraggedElement.style.opacity = '0.8';
            
            const rect = cityDraggedElement.getBoundingClientRect();
            const canvasRect = cityCanvas.getBoundingClientRect();
            
            const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
            const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
            
            cityOffsetX = clientX - rect.left;
            cityOffsetY = clientY - rect.top;
            
            function handleCityMove(e) {
                if (!cityDraggedElement) return;
                
                const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
                const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
                
                let newX = clientX - canvasRect.left - cityOffsetX;
                let newY = clientY - canvasRect.top - cityOffsetY;
                
                newX = Math.max(0, Math.min(newX, canvasRect.width - cityDraggedElement.offsetWidth));
                newY = Math.max(0, Math.min(newY, canvasRect.height - cityDraggedElement.offsetHeight));
                
                cityDraggedElement.style.left = newX + 'px';
                cityDraggedElement.style.top = newY + 'px';
            }
            
            function handleCityEnd() {
                if (cityDraggedElement) {
                    cityDraggedElement.style.zIndex = '10';
                    cityDraggedElement.style.opacity = '1';
                    cityDraggedElement = null;
                }
                document.removeEventListener('mousemove', handleCityMove);
                document.removeEventListener('touchmove', handleCityMove);
                document.removeEventListener('mouseup', handleCityEnd);
                document.removeEventListener('touchend', handleCityEnd);
            }
            
            document.addEventListener('mousemove', handleCityMove);
            document.addEventListener('touchmove', handleCityMove);
            document.addEventListener('mouseup', handleCityEnd);
            document.addEventListener('touchend', handleCityEnd);
        }
        
        async function saveCityContribution() {
            const userBuildings = Array.from(cityCanvas.querySelector('div[style*="top: 300px"]').querySelectorAll('.city-building'))
                .filter(building => building.dataset.owner === currentUser);
            
            if (userBuildings.length === 0) {
                showToast('No buildings to save. Add some buildings first!', 'warning');
                return;
            }
            
            if (cityBuildings.length >= 999) {
                showToast('Maximum city limit reached. Cannot add more buildings.', 'error');
                return;
            }
            
            const btn = document.getElementById('save-city-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>Saving...';
            
            // NOTE: Bu basit √∂rnekte, her kaydetme i≈üleminde canvas'taki t√ºm binalar (kullanƒ±cƒ±nƒ±n ekledikleri) yeni kayƒ±t olarak ekleniyor.
            // Ger√ßek bir uygulamada, sadece yeni eklenenler veya konumu deƒüi≈üenler g√ºncellenmelidir.
            
            for (const building of userBuildings) {
                const buildingData = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    user_id: currentUser,
                    building_type: building.dataset.building,
                    building_name: building.dataset.name,
                    description: building.dataset.desc,
                    category: building.dataset.category,
                    x_position: building.style.left,
                    y_position: building.style.top,
                    created_at: new Date().toISOString(),
                    location: currentLocation
                };
                
                const result = await window.dataSdk.create(buildingData);
                if (!result.isOk) {
                    showToast('Failed to save some buildings', 'error');
                }
            }
            
            btn.disabled = false;
            btn.innerHTML = ' üíæ  Save My Contribution';
            
            addToUserHistory('city_contribution', `Saved ${userBuildings.length} buildings to the global city`);
            showToast('City contribution saved successfully!', 'success');
        }
        
        function refreshCity() {
            // Bu, onDataChanged'i tetikler ve t√ºm binalarƒ± yeniden render eder
            showToast('City refreshed!', 'info');
        }
        
        function renderCityBuildings(buildings) {
            if (!cityCanvas) return;
            
            // Get the building placement area (the div inside city-canvas)
            const buildingArea = cityCanvas.querySelector('div[style*="top: 300px"]') || cityCanvas;
            
            // Clear existing buildings (Sadece kullanƒ±cƒ±nƒ±n olmayan binalarƒ± temizle, √ß√ºnk√º kullanƒ±cƒ±nƒ±nkiler canvas'ta kalmalƒ±)
            buildingArea.querySelectorAll('.city-building').forEach(building => {
                if (building.dataset.owner !== currentUser) {
                    building.remove();
                }
            });

            // Yalnƒ±zca benim olmayan, yeni eklenen binalarƒ± render et
            buildings.forEach(buildingData => {
                // Eƒüer bina zaten canvas'ta benim tarafƒ±mdan eklenmi≈üse (ki bu basit modelde her kaydetmede yenilenir), bu adƒ±mƒ± atlarƒ±z.
                // Basitlik adƒ±na, mevcut canvas'ta olmayan t√ºm binalarƒ± yeniden ekliyoruz. (Bu, canvas'ƒ±n her zaman t√ºm global binalarƒ± g√∂stermesini saƒülar)

                let isAlreadyRendered = false;
                buildingArea.querySelectorAll('.city-building').forEach(existingBuilding => {
                    if (existingBuilding.dataset.id === buildingData.__backendId) {
                        isAlreadyRendered = true;
                    }
                });

                if (isAlreadyRendered) return;

                const newBuilding = document.createElement('div');
                const colors = {
                    green: 'bg-green-500',
                    water: 'bg-blue-500',
                    energy: 'bg-yellow-500',
                    transport: 'bg-purple-500'
                };
                
                // city-building sƒ±nƒ±fƒ± 3D efektleri ve gradientleri i√ßerir
                newBuilding.className = `city-building ${colors[buildingData.category] || 'bg-gray-500'} text-white p-3 rounded-lg text-center shadow-lg border-2 border-white`;
                newBuilding.innerHTML = `
                    <div class="text-2xl mb-1">${getBuildingIcon(buildingData.building_type)}</div>
                    <div class="text-xs font-semibold">${buildingData.building_name}</div>
                    <div class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs cursor-pointer opacity-0 hover:opacity-100 transition-opacity" onclick="removeCityBuilding(this)">√ó</div>
                    <div class="absolute -bottom-6 left-0 right-0 text-center">
                        <div class="bg-black bg-opacity-75 text-white text-xs px-2 py-1 rounded opacity-0 hover:opacity-100 transition-opacity">
                            ${buildingData.user_id}
                        </div>
                    </div>
                `;
                newBuilding.dataset.building = buildingData.building_type;
                newBuilding.dataset.name = buildingData.building_name;
                newBuilding.dataset.desc = buildingData.description;
                newBuilding.dataset.category = buildingData.category;
                newBuilding.dataset.owner = buildingData.user_id;
                newBuilding.dataset.id = buildingData.__backendId; // Backend ID'sini sakla
                newBuilding.style.position = 'absolute';
                newBuilding.style.left = buildingData.x_position;
                newBuilding.style.top = buildingData.y_position;
                newBuilding.style.width = '80px';
                newBuilding.style.height = '70px';
                newBuilding.style.zIndex = '10';
                
                buildingArea.appendChild(newBuilding);
                setupCityBuildingDragging(newBuilding);
            });
        }
        
        function getBuildingIcon(buildingType) {
            const icons = {
                'green-house': ' üè† ',
                'water-plant': ' üè≠ ',
                'solar-farm': ' ‚òÄÔ∏è ',
                'metro-station': ' üöá ',
                'park': ' üå≥ ',
                'research-center': ' üî¨ ',
                'wind-turbine': ' üí® ',
                'recycling-center': ' ‚ôªÔ∏è ',
                'vertical-farm': ' üåæ ',
                'ev-station': ' üîå ',
                'smart-grid': ' ‚ö° ',
                'air-purifier': ' üå¨Ô∏è '
            };
            return icons[buildingType] || ' üè¢ ';
        }
        
        function updateCityStats(buildings) {
            const stats = {
                green: buildings.filter(b => b.category === 'green').length,
                water: buildings.filter(b => b.category === 'water').length,
                energy: buildings.filter(b => b.category === 'energy').length,
                transport: buildings.filter(b => b.category === 'transport').length
            };
            
            document.getElementById('green-buildings').textContent = stats.green;
            document.getElementById('water-systems').textContent = stats.water;
            document.getElementById('energy-systems').textContent = stats.energy;
            document.getElementById('transport-systems').textContent = stats.transport;
            
            // Update population (unique users)
            const uniqueUsers = [...new Set(buildings.map(b => b.user_id))];
            document.getElementById('city-population').textContent = uniqueUsers.length;
            
            // Update user contributions
            const userContributions = buildings.filter(b => b.user_id === currentUser);
            const contributionsContainer = document.getElementById('user-contributions');
            
            if (userContributions.length === 0) {
                contributionsContainer.innerHTML = '<p class="text-gray-500 text-sm">No contributions yet. Add buildings to the city!</p>';
            } else {
                contributionsContainer.innerHTML = userContributions.map(building => `
                    <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
                        <span class="text-sm">${getBuildingIcon(building.building_type)} ${building.building_name}</span>
                        <span class="text-xs text-gray-500">${new Date(building.created_at).toLocaleDateString()}</span>
                    </div>
                `).join('');
            }
            
            // Update global activity
            const activityContainer = document.getElementById('community-activity');
            const recentBuildings = buildings
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                .slice(0, 5);
            
            if (recentBuildings.length === 0) {
                activityContainer.innerHTML = '<p class="text-gray-500 text-sm">No global activity yet.</p>';
            } else {
                activityContainer.innerHTML = recentBuildings.map(building => `
                    <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
                        <span class="text-sm">${getBuildingIcon(building.building_type)} ${building.building_name}</span>
                        <span class="text-xs text-gray-500">${building.user_id}</span>
                    </div>
                `).join('');
            }
        }
        
        // User History Functions
        function addToUserHistory(activityType, description) {
            // This will be saved when user performs actions
            const historyEntry = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                user_id: currentUser,
                activity_type: activityType,
                description: description,
                timestamp: new Date().toISOString(),
                location: currentLocation
            };
            
            // Save to data SDK
            window.dataSdk.create(historyEntry);
        }
        
        function renderUserHistory(history) {
            const userHistoryData = history.filter(h => h.user_id === currentUser);
            const timelineContainer = document.getElementById('activity-timeline');
            
            if (userHistoryData.length === 0) {
                timelineContainer.innerHTML = '<p class="text-gray-500 text-center py-8">No activity yet. Start using the platform to see your history!</p>';
                return;
            }
            
            const sortedHistory = userHistoryData
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 10); // Show last 10 activities
            
            timelineContainer.innerHTML = sortedHistory.map(activity => {
                const activityIcons = {
                    project_created: ' üß™ ',
                    sensor_reading: ' üìä ',
                    building_added: ' üèóÔ∏è ',
                    building_removed: ' üóëÔ∏è ',
                    city_contribution: ' üåÜ ',
                    login: ' üö™ '
                };
                
                return `
                    <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg">
                        <div class="text-2xl">${activityIcons[activity.activity_type] || ' üìù '}</div>
                        <div class="flex-1">
                            <p class="font-semibold text-gray-800">${activity.description}</p>
                            <p class="text-sm text-gray-500">${new Date(activity.timestamp).toLocaleString()}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateHistoryStats() {
            const userHistoryData = userHistory.filter(h => h.user_id === currentUser);
            const userProjects = allProjects.filter(p => p.user_id === currentUser);
            const userSensorData = sensorData.filter(s => s.user_id === currentUser);
            const userCityBuildings = cityBuildings.filter(b => b.user_id === currentUser);
            
            document.getElementById('total-projects-history').textContent = userProjects.length;
            document.getElementById('total-sensor-readings').textContent = userSensorData.length;
            document.getElementById('total-city-contributions').textContent = userCityBuildings.length;
            
            // Calculate days active
            if (userHistoryData.length > 0) {
                const dates = userHistoryData.map(h => new Date(h.timestamp).toDateString());
                const uniqueDates = [...new Set(dates)];
                document.getElementById('days-active').textContent = uniqueDates.length;
            } else {
                document.getElementById('days-active').textContent = '0';
            }
            
            // Update charts
            updateHistoryCharts(userProjects, userHistoryData);
        }
        
        function updateHistoryCharts(projects, history) {
            // Projects by category chart
            const projectsChart = document.getElementById('projects-chart');
            if (projects.length > 0) {
                const categories = {};
                projects.forEach(p => {
                    categories[p.category] = (categories[p.category] || 0) + 1;
                });
                
                const colors = ['#00838f', '#4caf50', '#ffb300', '#f44336', '#9c27b0'];
                let currentAngle = 0;
                const centerX = 150;
                const centerY = 100;
                const radius = 60;
                
                const total = Object.values(categories).reduce((a, b) => a + b, 0);
                
                let chartHTML = '<svg width="100%" height="100%" viewBox="0 0 300 200">';
                
                Object.entries(categories).forEach(([category, count], index) => {
                    const angle = (count / total) * 2 * Math.PI;
                    const x1 = centerX + radius * Math.cos(currentAngle);
                    const y1 = centerY + radius * Math.sin(currentAngle);
                    const x2 = centerX + radius * Math.cos(currentAngle + angle);
                    const y2 = centerY + radius * Math.sin(currentAngle + angle);
                    
                    const largeArcFlag = angle > Math.PI ? 1 : 0;
                    
                    chartHTML += `
                        <path d="M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2} Z" 
                              fill="${colors[index % colors.length]}" opacity="0.8"/>
                        <text x="${centerX + (radius * 0.7) * Math.cos(currentAngle + angle/2)}" 
                              y="${centerY + (radius * 0.7) * Math.sin(currentAngle + angle/2)}" 
                              text-anchor="middle" class="text-xs fill-white font-semibold">${count}</text>
                    `;
                    
                    currentAngle += angle;
                });
                
                chartHTML += '</svg>';
                projectsChart.innerHTML = chartHTML;
            }
            
            // Activity over time chart
            const activityChart = document.getElementById('activity-chart');
            if (history.length > 0) {
                const last7Days = [];
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    last7Days.push(date.toDateString());
                }
                
                const activityCounts = last7Days.map(date => {
                    return history.filter(h => new Date(h.timestamp).toDateString() === date).length;
                });
                
                const maxCount = Math.max(...activityCounts, 1);
                const barWidth = 35;
                const chartHeight = 150;
                
                let chartHTML = '<svg width="100%" height="100%" viewBox="0 0 300 200">';
                
                activityCounts.forEach((count, index) => {
                    const barHeight = (count / maxCount) * chartHeight;
                    const x = index * (barWidth + 5) + 20;
                    const y = 180 - barHeight;
                    
                    chartHTML += `
                        <rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" 
                              fill="#00838f" opacity="0.8"/>
                        <text x="${x + barWidth/2}" y="195" text-anchor="middle" class="text-xs fill-gray-600">
                            ${last7Days[index].split(' ')[1].substr(0, 3)}
                        </text>
                        <text x="${x + barWidth/2}" y="${y - 5}" text-anchor="middle" class="text-xs fill-gray-800">
                            ${count}
                        </text>
                    `;
                });
                
                chartHTML += '</svg>';
                activityChart.innerHTML = chartHTML;
            }
        }
        // Toast Notifications
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            
            const bgColor = type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#00838f';
            toast.style.borderLeft = `4px solid ${bgColor}`;
            
            toast.innerHTML = `
                <div class="flex items-center">
                    <span class="font-semibold">${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'997d0699f6b617e1',t:'MTc2MjAxNzIzOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

